<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vote Now | Mansion Mayhem</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0a;--bg-card:#111;--bg-elevated:#1a1a1a;--border:#2a2a2a;--text:#fff;--text-dim:#888;--text-muted:#555;--gold:#d4af37;--gold-light:#f4e4bc;--rose:#e91e63;--purple:#9c27b0;--success:#4caf50;--warning:#ff9800;--info:#2196f3}
    body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
    .page-bg{position:fixed;inset:0;background:radial-gradient(ellipse at top,rgba(233,30,99,.12) 0%,transparent 50%),radial-gradient(ellipse at bottom right,rgba(212,175,55,.08) 0%,transparent 50%),var(--bg);z-index:-1}
    
    /* Header */
    .header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(10,10,10,.95);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100}
    .logo{font-family:'Playfair Display',serif;font-size:20px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo span{display:block;font-family:'Montserrat',sans-serif;font-size:10px;font-weight:600;letter-spacing:3px;background:linear-gradient(135deg,var(--rose),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header-live{display:flex;align-items:center;gap:8px;background:var(--rose);padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700}
    .live-dot{width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    
    /* Main */
    .main{max-width:1000px;margin:0 auto;padding:32px 20px}
    
    /* Active Vote */
    .vote-hero{text-align:center;margin-bottom:40px}
    .vote-badge{display:inline-block;background:linear-gradient(135deg,var(--rose),var(--purple));padding:8px 20px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:16px}
    .vote-title{font-family:'Playfair Display',serif;font-size:42px;font-weight:900;margin-bottom:8px}
    .vote-subtitle{color:var(--text-dim);font-size:16px;margin-bottom:24px}
    .vote-timer{display:inline-flex;align-items:center;gap:12px;background:var(--bg-card);border:1px solid var(--border);padding:12px 24px;border-radius:12px}
    .timer-label{font-size:12px;color:var(--text-dim);letter-spacing:1px}
    .timer-value{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:var(--warning)}
    
    /* Vote Cards */
    .vote-section{margin-bottom:48px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .section-title{font-family:'Playfair Display',serif;font-size:24px}
    .section-meta{font-size:12px;color:var(--text-dim)}
    
    .vote-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
    
    .vote-card{background:var(--bg-card);border:2px solid var(--border);border-radius:16px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}
    .vote-card:hover{border-color:var(--gold);transform:translateY(-4px)}
    .vote-card.selected{border-color:var(--rose);background:rgba(233,30,99,.1)}
    .vote-card.selected::before{content:'‚úì';position:absolute;top:12px;right:12px;width:24px;height:24px;background:var(--rose);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
    .vote-card.leading{border-color:var(--gold)}
    .vote-card.leading::after{content:'üëë';position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-size:24px}
    
    .card-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--rose),var(--purple));margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;border:3px solid var(--bg)}
    .card-name{font-weight:700;font-size:16px;margin-bottom:4px}
    .card-archetype{font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px}
    
    .card-stats{display:flex;justify-content:center;gap:16px;margin-bottom:12px}
    .stat{text-align:center}
    .stat-value{font-size:14px;font-weight:700;color:var(--gold)}
    .stat-label{font-size:9px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
    
    .card-progress{margin-top:12px}
    .progress-bar{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--rose),var(--purple));border-radius:3px;transition:width .5s ease}
    .progress-label{display:flex;justify-content:space-between;margin-top:6px;font-size:11px}
    .progress-percent{font-weight:700;color:var(--rose)}
    .progress-votes{color:var(--text-muted)}
    
    /* Vote Button */
    .vote-actions{text-align:center;margin-top:32px}
    .vote-btn{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg);border:none;padding:18px 48px;border-radius:12px;font-family:inherit;font-size:16px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all .3s ease}
    .vote-btn:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(212,175,55,.3)}
    .vote-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .vote-btn.voted{background:linear-gradient(135deg,var(--success),#2e7d32)}
    
    .vote-note{margin-top:16px;font-size:12px;color:var(--text-muted)}
    
    /* Past Votes */
    .past-votes{margin-top:64px}
    .past-header{margin-bottom:24px}
    .past-title{font-family:'Playfair Display',serif;font-size:28px;margin-bottom:8px}
    .past-subtitle{color:var(--text-dim);font-size:14px}
    
    .past-grid{display:grid;gap:16px}
    .past-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:20px}
    .past-card-info{flex:1}
    .past-card-type{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--rose);margin-bottom:4px}
    .past-card-title{font-weight:600;font-size:16px;margin-bottom:4px}
    .past-card-date{font-size:12px;color:var(--text-muted)}
    .past-card-winner{display:flex;align-items:center;gap:12px}
    .past-winner-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-light));display:flex;align-items:center;justify-content:center;font-weight:700}
    .past-winner-info{text-align:right}
    .past-winner-label{font-size:10px;color:var(--text-muted);letter-spacing:1px}
    .past-winner-name{font-weight:700;color:var(--gold)}
    .past-winner-votes{font-size:12px;color:var(--text-dim)}
    
    /* Tabs */
    .vote-tabs{display:flex;gap:8px;margin-bottom:32px;flex-wrap:wrap}
    .vote-tab{background:var(--bg-elevated);border:1px solid var(--border);padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
    .vote-tab:hover{border-color:var(--gold)}
    .vote-tab.active{background:linear-gradient(135deg,var(--rose),var(--purple));border-color:transparent;color:#fff}
    
    /* Mobile */
    @media(max-width:768px){
      .vote-title{font-size:32px}
      .vote-grid{grid-template-columns:repeat(2,1fr)}
      .card-avatar{width:60px;height:60px;font-size:18px}
    }
  </style>
</head>
<body>
  <!-- MANSION MAYHEM - Persistent Navigation Bar -->
  <!-- Navigation (loaded from include) -->
  <div id="globalNavPlaceholder"></div>
  <script>
    fetch('/includes/global-nav.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('globalNavPlaceholder').innerHTML = data;
      });
  </script>
  <!-- Navigation loaded - displays role-based links, notifications, and user menu -->

  <div class="page-bg"></div>
  
  <header class="header">
    <div class="logo">MANSION MAYHEM<span>Fan Portal</span></div>
    <div class="header-live"><span class="live-dot"></span>VOTING OPEN</div>
  </header>
  
  <main class="main">
    <!-- Active Vote Hero -->
    <div class="vote-hero">
      <div class="vote-badge">üó≥Ô∏è EPISODE 4 VOTE</div>
      <h1 class="vote-title">Who Gets The Crown?</h1>
      <p class="vote-subtitle">Vote for who should be House Leader this week. The winner gains power over the next elimination.</p>
      <div class="vote-timer">
        <span class="timer-label">VOTING ENDS IN</span>
        <span class="timer-value" id="countdown">23:47:12</span>
      </div>
    </div>
    
    <!-- Vote Tabs -->
    <div class="vote-tabs">
      <div class="vote-tab active" onclick="showVote('power')">üëë Power Vote</div>
      <div class="vote-tab" onclick="showVote('hotseat')">üî• Hot Seat</div>
      <div class="vote-tab" onclick="showVote('favorite')">‚≠ê Fan Favorite</div>
      <div class="vote-tab" onclick="showVote('prediction')">üîÆ Predictions</div>
    </div>
    
    <!-- Power Vote Section -->
    <div class="vote-section" id="vote-power">
      <div class="section-header">
        <h2 class="section-title">üëë Power Vote</h2>
        <span class="section-meta">0 votes cast</span>
      </div>

      <!-- Data loaded via JavaScript from Supabase -->
      <div class="vote-grid" id="voteGrid">
        <div style="padding: 40px; text-align: center; color: var(--text-dim);">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">‚è≥</div>
          <div>Loading voting options...</div>
        </div>
      </div>
      
      <div class="vote-actions">
        <button class="vote-btn" id="voteBtn" disabled onclick="submitVote()">Select Someone to Vote</button>
        <p class="vote-note">You can vote once per day. Your vote counts toward 50% of the final result.</p>
      </div>
    </div>
    
    <!-- Past Votes -->
    <div class="past-votes">
      <div class="past-header">
        <h2 class="past-title">Past Votes</h2>
        <p class="past-subtitle">See how the house has shifted power</p>
      </div>

      <!-- Data loaded via JavaScript from Supabase -->
      <div class="past-grid" id="pastVotesGrid">
        <div style="padding: 40px; text-align: center; color: var(--text-dim);">
          No past votes yet
        </div>
      </div>
    </div>
  </main>
  
  <!-- Supabase Integration -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase Client
    var supabase = window.supabase.createClient(
      'https://mllqzeaxqusoryt–µaxzg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sbHF6ZWF4cXVzb3J5dGVheHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0ODA1NzAsImV4cCI6MjA4NjA1NjU3MH0.s9CAe91gUG8uZ7Nrjd1pIX9YYvpNKa2lOrt6HDUarec'
    );

    let currentUser = null;
    let activeVotePoll = null;
    let selectedCard = null;
    let hasVotedToday = false;

    // ========================================
    // AUTH CHECK
    // ========================================
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        // Allow anonymous voting but track by browser fingerprint
        currentUser = { id: getFingerprint(), anonymous: true };
      } else {
        currentUser = session.user;
      }

      return true;
    }

    function getFingerprint() {
      // Simple browser fingerprint - you can use a library for more robust fingerprinting
      let fingerprint = localStorage.getItem('voter_fingerprint');
      if (!fingerprint) {
        fingerprint = 'anon_' + Math.random().toString(36).substr(2, 9) + Date.now();
        localStorage.setItem('voter_fingerprint', fingerprint);
      }
      return fingerprint;
    }

    // ========================================
    // LOAD ACTIVE VOTE POLL
    // ========================================
    async function loadActiveVotePoll() {
      // For now, we'll create a vote poll based on cast members
      // You can create a separate `vote_polls` table for more complex voting
      const { data: castMembers, error } = await supabase
        .from('cast_members')
        .select('*')
        .order('fan_votes', { ascending: false })
        .limit(4);

      if (error) {
        console.error('Error loading cast members:', error);
        return;
      }

      // Get total votes
      const totalVotes = castMembers.reduce((sum, m) => sum + (m.fan_votes || 0), 0);

      activeVotePoll = {
        type: 'power',
        title: 'Who Gets The Crown?',
        subtitle: 'Vote for who should be House Leader this week',
        castMembers: castMembers.map(member => ({
          ...member,
          votePercentage: totalVotes > 0 ? Math.round((member.fan_votes / totalVotes) * 100) : 0
        })),
        totalVotes: totalVotes,
        deadline: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours from now
      };

      renderVotePoll(activeVotePoll);
      startCountdownTimer(activeVotePoll.deadline);
      await checkIfVotedToday();
    }

    // ========================================
    // RENDER VOTE POLL
    // ========================================
    function renderVotePoll(poll) {
      const container = document.querySelector('.vote-grid');
      if (!container) return;

      container.innerHTML = poll.castMembers.map((member, index) => {
        const initials = getInitials(member.name);
        const firstName = member.name.split(' ')[0];
        const isLeading = index === 0;

        return `
          <div class="vote-card ${isLeading ? 'leading' : ''}" data-cast-id="${member.id}" onclick="selectVote(this, '${member.id}', '${firstName}')">
            <div class="card-avatar">${initials}</div>
            <div class="card-name">${firstName}</div>
            <div class="card-archetype">${member.archetype || 'Cast Member'}</div>
            <div class="card-stats">
              <div class="stat">
                <div class="stat-value">${member.response_rate || 0}%</div>
                <div class="stat-label">Response</div>
              </div>
              <div class="stat">
                <div class="stat-value">${member.featured_count || 0}</div>
                <div class="stat-label">Featured</div>
              </div>
            </div>
            <div class="card-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width:${member.votePercentage}%"></div>
              </div>
              <div class="progress-label">
                <span class="progress-percent">${member.votePercentage}%</span>
                <span class="progress-votes">${formatNumber(member.fan_votes || 0)} votes</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Update total votes count
      document.querySelector('.section-meta').textContent = `${formatNumber(poll.totalVotes)} votes cast`;
    }

    // ========================================
    // COUNTDOWN TIMER
    // ========================================
    let timerInterval = null;

    function startCountdownTimer(deadline) {
      if (timerInterval) clearInterval(timerInterval);

      function update() {
        const now = new Date();
        const diff = deadline - now;

        if (diff <= 0) {
          document.getElementById('countdown').textContent = '00:00:00';
          clearInterval(timerInterval);
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        document.getElementById('countdown').textContent =
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      update();
      timerInterval = setInterval(update, 1000);
    }

    // ========================================
    // VOTE SELECTION
    // ========================================
    function selectVote(card, castId, castName) {
      if (hasVotedToday) {
        alert('You have already voted today. Come back tomorrow!');
        return;
      }

      document.querySelectorAll('.vote-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      selectedCard = { card, castId, castName };

      const btn = document.getElementById('voteBtn');
      btn.disabled = false;
      btn.textContent = `Vote for ${castName}`;
    }

    // ========================================
    // SUBMIT VOTE
    // ========================================
    async function submitVote() {
      if (!selectedCard || hasVotedToday) return;

      const btn = document.getElementById('voteBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Submitting...';

      try {
        // Update cast member fan votes
        const { data: currentData, error: fetchError } = await supabase
          .from('cast_members')
          .select('fan_votes')
          .eq('id', selectedCard.castId)
          .single();

        if (fetchError) throw fetchError;

        const newVoteCount = (currentData.fan_votes || 0) + 1;

        const { error: updateError } = await supabase
          .from('cast_members')
          .update({ fan_votes: newVoteCount })
          .eq('id', selectedCard.castId);

        if (updateError) throw updateError;

        // Record vote (create a votes table if needed for tracking)
        // For now, just mark in localStorage
        const today = new Date().toDateString();
        localStorage.setItem('last_vote_date', today);
        localStorage.setItem('last_vote_cast', selectedCard.castId);

        // Update UI
        btn.classList.add('voted');
        btn.textContent = '‚úì Vote Submitted!';
        hasVotedToday = true;

        // Update vote count visually
        const progressFill = selectedCard.card.querySelector('.progress-fill');
        const progressPercent = selectedCard.card.querySelector('.progress-percent');
        const progressVotes = selectedCard.card.querySelector('.progress-votes');

        const currentPercent = parseInt(progressFill.style.width);
        progressFill.style.width = (currentPercent + 1) + '%';
        progressPercent.textContent = (currentPercent + 1) + '%';

        const currentVotes = parseInt(progressVotes.textContent.replace(/[^\d]/g, ''));
        progressVotes.textContent = formatNumber(currentVotes + 1) + ' votes';

        alert(`‚úÖ Thank you for voting for ${selectedCard.castName}!`);

        // Reload data after 2 seconds
        setTimeout(loadActiveVotePoll, 2000);

      } catch (error) {
        console.error('Error submitting vote:', error);
        alert('Failed to submit vote: ' + error.message);
        btn.disabled = false;
        btn.textContent = `Vote for ${selectedCard.castName}`;
      }
    }

    // ========================================
    // CHECK IF VOTED TODAY
    // ========================================
    async function checkIfVotedToday() {
      const today = new Date().toDateString();
      const lastVoteDate = localStorage.getItem('last_vote_date');

      if (lastVoteDate === today) {
        hasVotedToday = true;
        const lastVoteCast = localStorage.getItem('last_vote_cast');

        // Mark the voted card
        const votedCard = document.querySelector(`.vote-card[data-cast-id="${lastVoteCast}"]`);
        if (votedCard) {
          votedCard.classList.add('selected');
        }

        const btn = document.getElementById('voteBtn');
        btn.classList.add('voted');
        btn.textContent = '‚úì Already Voted Today';
        btn.disabled = true;
      }
    }

    // ========================================
    // LOAD PAST VOTES
    // ========================================
    async function loadPastVotes() {
      // You can create a vote_history table for this
      // For now, just display mock data as in the original design
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function getInitials(name) {
      if (!name || typeof name !== 'string') {
        return '??';
      }
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    // ========================================
    // TAB SWITCHING
    // ========================================
    function showVote(type) {
      document.querySelectorAll('.vote-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // You can load different vote types here
      // For now, all tabs show the same poll
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.getElementById('voteBtn')?.addEventListener('click', submitVote);

    // ========================================
    // INITIALIZE
    // ========================================
    async function init() {
      await checkAuth();
      await loadActiveVotePoll();
      await loadPastVotes();

      // Auto-refresh poll results every 30 seconds
      setInterval(loadActiveVotePoll, 30000);
    }

    init();
  </script>
  <script type="module" src="js/invite-gate.js"></script>
  <script src="/js/navigation.js"></script>
</body>
</html>
