<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Episode Editor | Mansion Mayhem</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0a;--bg-card:#111;--bg-elevated:#1a1a1a;--border:#2a2a2a;--text:#fff;--text-dim:#888;--text-muted:#555;--gold:#d4af37;--rose:#e91e63;--purple:#9c27b0;--success:#4caf50;--warning:#ff9800}
    body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}
    .app{display:grid;grid-template-rows:56px 1fr 180px;height:100vh}
    
    /* Top Bar */
    .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:20px}
    .logo{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold);margin-right:20px}
    .episode-select{display:flex;align-items:center;gap:12px;background:var(--bg-elevated);padding:8px 16px;border-radius:8px;border:1px solid var(--border)}
    .episode-select select{background:transparent;border:none;color:var(--text);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer}
    .episode-select select:focus{outline:none}
    .status-badge{font-size:11px;font-weight:600;padding:4px 10px;border-radius:10px;background:var(--warning);color:var(--bg)}
    .top-actions{margin-left:auto;display:flex;gap:12px}
    .btn{padding:10px 20px;border-radius:8px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;border:none;display:flex;align-items:center;gap:6px;transition:all .2s}
    .btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text)}
    .btn-secondary:hover{border-color:var(--gold)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),#f4e4bc);color:var(--bg)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(212,175,55,.3)}
    .btn-publish{background:linear-gradient(135deg,var(--success),#2e7d32);color:#fff}
    
    /* Main */
    .main{display:grid;grid-template-columns:260px 1fr 300px;overflow:hidden}
    
    /* Scene Library */
    .library{background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
    .panel-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .panel-title{font-weight:700;font-size:13px;letter-spacing:1px}
    .icon-btn{width:30px;height:30px;border-radius:6px;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;font-size:12px}
    .icon-btn:hover{border-color:var(--gold);color:var(--gold)}
    .tabs{display:flex;border-bottom:1px solid var(--border)}
    .tab{flex:1;padding:10px;text-align:center;font-size:10px;font-weight:600;letter-spacing:1px;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent}
    .tab:hover{color:var(--text-dim)}
    .tab.active{color:var(--gold);border-color:var(--gold)}
    .scene-list{flex:1;overflow-y:auto;padding:12px}
    .scene-item{background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;cursor:grab;transition:all .2s}
    .scene-item:hover{border-color:var(--gold);transform:translateX(4px)}
    .scene-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .scene-dot{width:8px;height:8px;border-radius:50%}
    .scene-dot.confrontation{background:var(--rose)}
    .scene-dot.confessional{background:var(--purple)}
    .scene-dot.group{background:#2196f3}
    .scene-dot.transition{background:#607d8b}
    .scene-dot.reveal{background:var(--warning)}
    .scene-dot.montage{background:var(--success)}
    .scene-title{font-size:13px;font-weight:600;flex:1}
    .scene-duration{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-muted)}
    .scene-meta{display:flex;gap:6px;flex-wrap:wrap}
    .scene-chip{background:var(--bg);padding:2px 8px;border-radius:10px;font-size:10px;color:var(--text-dim)}
    .scene-status{font-size:10px;padding:2px 8px;border-radius:10px;margin-left:auto}
    .scene-status.done{background:rgba(76,175,80,.2);color:var(--success)}
    .scene-status.pending{background:rgba(255,152,0,.2);color:var(--warning)}
    
    /* Preview */
    .preview{background:var(--bg);display:flex;flex-direction:column}
    .preview-container{flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
    .video-box{width:100%;max-width:720px;aspect-ratio:16/9;background:var(--bg-card);border-radius:12px;position:relative;overflow:hidden}
    .video-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted)}
    .video-placeholder-icon{font-size:56px;margin-bottom:12px;opacity:.3}
    .video-controls{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:16px;display:flex;align-items:center;gap:12px}
    .play-btn{width:44px;height:44px;border-radius:50%;background:var(--gold);border:none;color:var(--bg);font-size:16px;cursor:pointer}
    .progress-bar{flex:1;height:4px;background:rgba(255,255,255,.2);border-radius:2px;cursor:pointer}
    .progress-fill{width:35%;height:100%;background:var(--gold);border-radius:2px}
    .time-display{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-dim)}
    .preview-info{padding:14px 20px;border-top:1px solid var(--border);background:var(--bg-card);display:flex;align-items:center;gap:16px}
    .preview-title{font-weight:600;font-size:14px}
    .preview-type{font-size:10px;padding:4px 10px;border-radius:10px;background:var(--rose);color:#fff}
    .preview-cast{display:flex;gap:6px;margin-left:auto}
    .cast-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--rose),var(--purple));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
    
    /* Details Panel */
    .details{background:var(--bg-card);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
    .details-content{flex:1;overflow-y:auto;padding:16px}
    .detail-group{margin-bottom:20px}
    .detail-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px}
    .detail-input,.detail-select,.detail-textarea{width:100%;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:inherit;font-size:13px}
    .detail-input:focus,.detail-select:focus,.detail-textarea:focus{outline:none;border-color:var(--gold)}
    .detail-textarea{resize:vertical;min-height:70px}
    .cast-selector{display:flex;flex-wrap:wrap;gap:6px}
    .cast-opt{display:flex;align-items:center;gap:6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:16px;padding:5px 10px;cursor:pointer;transition:all .2s}
    .cast-opt:hover{border-color:var(--gold)}
    .cast-opt.selected{border-color:var(--rose);background:rgba(233,30,99,.1)}
    .cast-opt-avatar{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--rose),var(--purple));font-size:7px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .cast-opt-name{font-size:11px;font-weight:500}
    .voice-player{background:var(--bg-elevated);border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px}
    .voice-btn{width:32px;height:32px;border-radius:50%;background:var(--rose);border:none;color:#fff;cursor:pointer;font-size:10px}
    .voice-info{flex:1}
    .voice-name{font-size:12px;font-weight:600}
    .voice-dur{font-size:11px;color:var(--text-muted)}
    .generate-btn{width:100%;background:linear-gradient(135deg,var(--rose),var(--purple));border:none;color:#fff;padding:14px;border-radius:10px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;margin-top:12px}
    .generate-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(233,30,99,.3)}
    
    /* Timeline */
    .timeline{background:#0d0d0d;border-top:1px solid var(--border);display:flex;flex-direction:column}
    .timeline-header{display:flex;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);gap:16px}
    .timeline-title{font-size:12px;font-weight:700;letter-spacing:1px}
    .timeline-dur{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--gold)}
    .timeline-tools{margin-left:auto;display:flex;gap:8px}
    .zoom{display:flex;align-items:center;gap:6px;background:var(--bg-elevated);border-radius:6px;padding:4px 8px}
    .zoom button{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:12px;padding:2px}
    .zoom button:hover{color:var(--gold)}
    .zoom span{font-size:10px;color:var(--text-muted);min-width:36px;text-align:center}
    .ruler{height:22px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;padding:0 16px;overflow-x:auto}
    .ruler-mark{flex-shrink:0;width:100px;border-left:1px solid var(--border);padding-left:4px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-muted);display:flex;align-items:center}
    .tracks{flex:1;overflow-x:auto;padding:10px 16px;position:relative}
    .playhead{position:absolute;top:0;bottom:0;width:2px;background:var(--gold);left:35%;z-index:10}
    .playhead::before{content:'';position:absolute;top:-4px;left:-5px;width:12px;height:12px;background:var(--gold);border-radius:50%}
    .track{display:flex;align-items:center;gap:4px;min-height:48px;margin-bottom:6px}
    .track-label{width:70px;flex-shrink:0;font-size:10px;font-weight:600;letter-spacing:1px;color:var(--text-muted)}
    .track-content{flex:1;display:flex;gap:3px;min-width:max-content}
    .clip{height:42px;border-radius:5px;padding:5px 8px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;transition:all .2s}
    .clip:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .clip.selected{outline:2px solid var(--gold);outline-offset:2px}
    .clip.confrontation{background:linear-gradient(135deg,var(--rose),#880e4f)}
    .clip.confessional{background:linear-gradient(135deg,var(--purple),#4a148c)}
    .clip.group{background:linear-gradient(135deg,#2196f3,#0d47a1)}
    .clip.transition{background:linear-gradient(135deg,#607d8b,#37474f)}
    .clip.reveal{background:linear-gradient(135deg,var(--warning),#e65100)}
    .clip.montage{background:linear-gradient(135deg,var(--success),#1b5e20)}
    .clip.audio{background:linear-gradient(135deg,#455a64,#263238)}
    .clip-title{font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .clip-meta{display:flex;justify-content:space-between;align-items:center}
    .clip-cast{display:flex;gap:2px}
    .clip-dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,.3);font-size:6px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .clip-dur{font-family:'JetBrains Mono',monospace;font-size:8px;opacity:.8}
    .drop-zone{min-width:80px;height:42px;border:2px dashed var(--border);border-radius:5px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px;transition:all .2s}
    .drop-zone.drag-over{border-color:var(--gold);background:rgba(212,175,55,.1);color:var(--gold)}
  </style>
  <link rel="stylesheet" href="../css/modern-theme.css">
</head>
<body>
  <!-- MANSION MAYHEM - Persistent Navigation Bar -->
  <!-- Navigation (loaded from include) -->
  <div id="globalNavPlaceholder"></div>
  <script>
    fetch('/includes/global-nav.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('globalNavPlaceholder').innerHTML = data;
      });
  </script>
  <!-- Navigation loaded - displays role-based links, notifications, and user menu -->

  <div class="app">
    <!-- Top Bar -->
    <header class="top-bar">
      <div class="logo">MANSION MAYHEM</div>
      <div class="episode-select">
        <span>üì∫</span>
        <select id="episodeSelect">
          <option value="">Select Episode...</option>
          <!-- Data loaded via JavaScript from Supabase -->
        </select>
        <span class="status-badge">Draft</span>
      </div>
      <div class="top-actions">
        <button class="btn btn-secondary">üíæ Save</button>
        <button class="btn btn-secondary">üëÅÔ∏è Preview</button>
        <button class="btn btn-primary">‚¨áÔ∏è Export</button>
        <button class="btn btn-publish">üöÄ Publish</button>
      </div>
    </header>
    
    <!-- Main -->
    <div class="main">
      <!-- Scene Library -->
      <aside class="library">
        <div class="panel-header">
          <span class="panel-title">üé¨ Scenes</span>
          <button class="icon-btn">‚ûï</button>
        </div>
        <div class="tabs">
          <div class="tab active">All</div>
          <div class="tab">Ready</div>
          <div class="tab">Pending</div>
        </div>
        <!-- Data loaded via JavaScript from Supabase -->
        <div class="scene-list" id="sceneList">
          <div style="padding: 40px 20px; text-align: center; color: var(--text-dim); font-size: 13px;">
            No scenes available
          </div>
        </div>
      </aside>
      
      <!-- Preview -->
      <main class="preview">
        <div class="preview-container">
          <div class="video-box">
            <div class="video-placeholder">
              <div class="video-placeholder-icon">üé¨</div>
              <p>Select a scene to preview</p>
            </div>
            <div class="video-controls">
              <button class="play-btn">‚ñ∂</button>
              <div class="progress-bar"><div class="progress-fill"></div></div>
              <span class="time-display">0:54 / 2:34</span>
            </div>
          </div>
        </div>
        <!-- Data loaded via JavaScript from Supabase -->
        <div class="preview-info" id="previewInfo">
          <span class="preview-title">Select a scene to preview</span>
          <span class="preview-type">Scene</span>
          <div class="preview-cast"></div>
        </div>
      </main>
      
      <!-- Details -->
      <aside class="details">
        <div class="panel-header">
          <span class="panel-title">üìù Details</span>
        </div>
        <!-- Data loaded via JavaScript from Supabase -->
        <div class="details-content" id="sceneDetails">
          <div style="padding: 40px 20px; text-align: center; color: var(--text-dim); font-size: 13px;">
            Select a scene to view details
          </div>
        </div>
      </aside>
    </div>
    
    <!-- Timeline -->
    <div class="timeline">
      <div class="timeline-header">
        <span class="timeline-title">üìê TIMELINE</span>
        <span class="timeline-dur" id="timelineDuration">00:00</span>
        <div class="timeline-tools">
          <div class="zoom"><button>‚àí</button><span>100%</span><button>+</button></div>
          <button class="icon-btn">‚Ü©Ô∏è</button>
        </div>
      </div>
      <div class="ruler">
        <div class="ruler-mark">0:00</div>
        <div class="ruler-mark">5:00</div>
        <div class="ruler-mark">10:00</div>
        <div class="ruler-mark">15:00</div>
        <div class="ruler-mark">20:00</div>
        <div class="ruler-mark">25:00</div>
        <div class="ruler-mark">30:00</div>
        <div class="ruler-mark">35:00</div>
        <div class="ruler-mark">40:00</div>
      </div>
      <!-- Data loaded via JavaScript from Supabase -->
      <div class="tracks" id="timelineTracks">
        <div class="playhead"></div>
        <div class="track">
          <div class="track-label">VIDEO</div>
          <div class="track-content">
            <div class="drop-zone">+ Drop Scene</div>
          </div>
        </div>
        <div class="track">
          <div class="track-label">AUDIO</div>
          <div class="track-content">
            <div class="drop-zone">+ Drop Audio</div>
          </div>
        </div>
        <div class="track">
          <div class="track-label">VOICE</div>
          <div class="track-content">
            <div class="drop-zone">+ Drop Voice</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.querySelectorAll('.clip').forEach(c=>c.addEventListener('click',function(){document.querySelectorAll('.clip').forEach(x=>x.classList.remove('selected'));this.classList.add('selected')}));
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',function(){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));this.classList.add('active')}));
    document.querySelectorAll('.cast-opt').forEach(o=>o.addEventListener('click',function(){this.classList.toggle('selected')}));
    document.querySelectorAll('.scene-item').forEach(s=>{s.addEventListener('click',function(){document.querySelectorAll('.scene-item').forEach(x=>x.style.borderColor='');this.style.borderColor='var(--gold)'})});
  </script>

  <!-- Auth Protection -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/auth.js"></script>
  <script>
    // Check if user is authenticated and has admin role
    async function checkAuth() {
      var supabase = window.supabase.createClient(
        'https://mllqzeaxqusoryt–µaxzg.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweGJocWliaW1la2pobHVtbm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUwODYsImV4cCI6MjA4NjYwMTA4Nn0.0BmbaObOERMZ5r4znb5BQbrGpB5lE5Fq6KnEzxA0YhY'
      );

      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        alert('Authentication required. Redirecting to sign in...');
        window.location.href = '/auth';
        return;
      }

      // TODO: Check if user has admin role in admin_users table
    }

    checkAuth();
  </script>
  <script type="module" src="js/invite-gate.js"></script>
  <script src="/js/navigation.js"></script>
</body>
</html>
