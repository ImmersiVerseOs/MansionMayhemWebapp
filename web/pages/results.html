<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results â€” Mansion Mayhem</title>
  <link rel="stylesheet" href="/css/candy.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .results-hero{text-align:center;padding:2.5rem 0 1.5rem}
    .crown{font-size:4.5rem;display:inline-block;animation:float 3s ease-in-out infinite}
    .winner-name{font-family:var(--font-display);font-size:2.5rem;font-weight:900;margin-top:0.5rem}
    .highlights{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:1.5rem}
    .hl{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1rem;text-align:center}
    .hl-icon{font-size:1.8rem;margin-bottom:0.3rem}
    .hl-label{font-size:0.65rem;color:var(--pink);font-weight:700;text-transform:uppercase;letter-spacing:0.06em}
    .hl-val{font-family:var(--font-display);font-weight:700;font-size:0.9rem;margin-top:0.15rem}
    .cast-row{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 0.8rem;background:var(--card);border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:0.4rem}
    .cast-row.winner{border-color:rgba(255,184,0,0.2);box-shadow:var(--glow-gold)}
    .cast-rank{width:28px;font-family:var(--font-display);font-weight:900;font-size:0.9rem;color:var(--text3);text-align:center}
    .cast-row.winner .cast-rank{color:var(--gold)}
    .director-quote{background:rgba(255,184,0,0.05);border-left:3px solid var(--gold);border-radius:0 var(--r-sm) var(--r-sm) 0;padding:0.55rem 0.75rem;margin-bottom:0.4rem;font-size:0.85rem;font-style:italic;color:var(--gold)}
  </style>
</head>
<body>
  <div class="page">
    <div class="orb3"></div>
    <div class="main"><div class="container-narrow" id="c"><div class="spinner" style="margin:5rem auto"></div></div></div>
  </div>
  <script type="module">
    import{waitForSupabase}from'/js/supabase.js';
    import{initSidebar}from'/js/sidebar.js';
    import*as userMod from'/js/supabase.js';
    const AI={wildcard:'ðŸƒ',strategist:'ðŸ§ ',sweetheart:'ðŸ’–',villain:'ðŸ˜ˆ',comedian:'ðŸ˜‚',troublemaker:'ðŸ’£',diva:'ðŸ‘‘',hothead:'ðŸ”¥'};
    async function init(){
      const sb=await waitForSupabase();await initSidebar('lobby',userMod);
      const gid=new URLSearchParams(location.search).get('game');if(!gid){location.href='/pages/lobby.html';return}
      const{data:game}=await sb.from('mm_games').select('*').eq('id',gid).single();
      const{data:cast}=await sb.from('mm_game_cast').select('*,cast_members(display_name,archetype,is_ai_player)').eq('game_id',gid).order('drama_points',{ascending:false});
      const{data:fights}=await sb.from('episode_fights').select('*').eq('game_id',gid);
      const{data:dir}=await sb.from('episode_director_log').select('*').eq('game_id',gid).order('created_at',{ascending:false}).limit(3);
      const el=document.getElementById('c');const w=cast?.find(c=>c.status==='active')||cast?.[0];const wn=w?.cast_members?.display_name||'Unknown';
      const ep=game?.episode_number||1,fc=fights?.length||0,md=Math.max(...(cast||[]).map(c=>c.drama_points||0),0);
      let h=`<div class="results-hero anim"><span class="pill pill-purple">Game Complete</span><div class="crown">ðŸ‘‘</div><div class="winner-name fire-text">${wn}</div><div style="font-family:var(--font-display);font-size:0.7rem;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:0.15em;margin-top:0.25rem">Queen of the Mansion</div></div>
      <div class="stats anim anim-d1" style="margin-bottom:1.5rem"><div class="stat"><div class="stat-val" style="color:var(--purple)">${ep}</div><div class="stat-lbl">Episodes</div></div><div class="stat"><div class="stat-val" style="color:var(--red)">${fc}</div><div class="stat-lbl">Fights</div></div><div class="stat"><div class="stat-val" style="color:var(--gold)">${md}</div><div class="stat-lbl">Peak Drama</div></div></div>
      <div class="highlights anim anim-d2"><div class="hl"><div class="hl-icon">ðŸ’¥</div><div class="hl-label">Most Dramatic</div><div class="hl-val">${cast?.[0]?.cast_members?.display_name||'â€”'}</div></div><div class="hl"><div class="hl-icon">ðŸ¤«</div><div class="hl-label">Best Spy</div><div class="hl-val">${(cast||[]).sort((a,b)=>(b.missions_completed||0)-(a.missions_completed||0))[0]?.cast_members?.display_name||'â€”'}</div></div></div>`;
      if(dir?.length){h+=`<div class="label anim anim-d3" style="color:var(--gold);margin-bottom:0.5rem">Director's Notes</div>${dir.map(d=>`<div class="director-quote anim">"${d.content}"</div>`).join('')}`}
      h+=`<div class="label anim anim-d4" style="color:var(--text3);margin:1rem 0 0.5rem">Final Rankings</div>`;
      (cast||[]).forEach((c,i)=>{const nm=c.cast_members?.display_name||'Player';const iw=c.status==='active'&&i===0;h+=`<div class="cast-row ${iw?'winner':''} anim" style="animation-delay:${0.2+i*0.03}s"><div class="cast-rank">${iw?'ðŸ‘‘':i+1}</div><div class="av av-sm">${AI[c.cast_members?.archetype]||'ðŸŽ­'}</div><div style="flex:1"><div style="font-weight:600;font-size:0.85rem">${nm}${c.cast_members?.is_ai_player?' ðŸ¤–':''}</div><div style="font-size:0.7rem;color:var(--text3)">${c.secret_role||c.cast_members?.archetype||'?'} Â· ${c.strike_count||0} strikes</div></div><div style="font-family:var(--font-display);font-weight:800;font-size:0.9rem;color:var(--pink)">${c.drama_points||0}</div></div>`});
      h+=`<button class="btn btn-fire btn-block btn-lg" style="margin-top:1.5rem" onclick="location.href='/pages/lobby.html'">Play Again</button>`;
      el.innerHTML=h;
    }
    init();
  </script>
</body>
</html>
