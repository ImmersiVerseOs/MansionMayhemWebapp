<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Photos | MANSION MAYHEM</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-dim: #888888;
      --text-muted: #555555;
      --gold: #d4af37;
      --gold-light: #f4e4bc;
      --rose: #e91e63;
      --rose-dark: #ad1457;
      --purple: #9c27b0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .page-bg {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at top right, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom left, rgba(233, 30, 99, 0.05) 0%, transparent 50%),
        var(--bg);
      z-index: -1;
    }

    .header {
      padding: 20px 40px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo span {
      font-weight: 400;
      font-size: 14px;
      letter-spacing: 4px;
      display: block;
      background: linear-gradient(135deg, var(--rose), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      margin-bottom: 30px;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 42px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 16px;
      line-height: 1.2;
    }

    .subtitle {
      text-align: center;
      color: var(--text-dim);
      font-size: 16px;
      margin-bottom: 40px;
    }

    .photo-upload-section {
      margin-bottom: 30px;
    }

    .photo-upload-section label {
      display: block;
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--gold);
    }

    .photo-upload-section input[type="file"] {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 2px dashed var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .photo-upload-section input[type="file"]:hover {
      border-color: var(--gold);
    }

    .photo-preview {
      display: none;
      max-width: 100%;
      max-height: 300px;
      margin-top: 16px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }

    .liveness-section {
      margin: 30px 0;
      padding: 30px;
      background: var(--bg-elevated);
      border: 2px solid var(--gold);
      border-radius: 12px;
    }

    .liveness-section h3 {
      color: var(--gold);
      font-size: 20px;
      margin-bottom: 16px;
      text-align: center;
    }

    .liveness-prompt {
      text-align: center;
      color: var(--text-dim);
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.6;
    }

    .video-container {
      position: relative;
      max-width: 500px;
      margin: 0 auto 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }

    #liveness-video {
      width: 100%;
      height: auto;
      display: block;
      transform: scaleX(-1); /* Mirror for selfie view */
    }

    .video-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      pointer-events: none;
    }

    .countdown {
      font-size: 72px;
      font-weight: bold;
      text-shadow: 0 0 20px rgba(0,0,0,0.8);
    }

    .recording-indicator {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--rose);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .recording-indicator.active {
      display: flex;
    }

    .recording-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .video-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .btn-video {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-video.primary {
      background: linear-gradient(135deg, var(--rose), var(--purple));
      color: white;
    }

    .btn-video.secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-video:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .btn-video:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .liveness-complete {
      text-align: center;
      color: var(--gold);
      font-size: 16px;
      font-weight: 600;
    }

    .instructions {
      background: var(--bg-elevated);
      border-left: 4px solid var(--gold);
      padding: 20px;
      margin: 30px 0;
      border-radius: 4px;
      font-size: 14px;
      line-height: 1.8;
    }

    .instructions strong {
      color: var(--gold);
      display: block;
      margin-bottom: 8px;
    }

    .instructions ul {
      list-style: none;
      padding-left: 0;
    }

    .instructions li {
      padding-left: 20px;
      position: relative;
      margin-bottom: 8px;
    }

    .instructions li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: var(--gold);
      font-weight: bold;
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--rose), var(--purple));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(233, 30, 99, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: rgba(233, 30, 99, 0.1);
      border: 1px solid var(--rose);
      color: var(--rose);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      display: none;
    }

    .loading-spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .footer {
      text-align: center;
      padding: 40px 20px;
      border-top: 1px solid var(--border);
      color: var(--text-dim);
      font-size: 14px;
      margin-top: 60px;
    }

    @media (max-width: 640px) {
      .header {
        padding: 16px 20px;
      }

      .container {
        padding: 40px 16px;
      }

      .card {
        padding: 24px;
      }

      h1 {
        font-size: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="page-bg"></div>

  <header class="header">
    <div class="logo">
      MANSION MAYHEM
      <span>FACECAST PHOTOS</span>
    </div>
  </header>

  <div class="container">
    <h1>Upload Your Photos & Video</h1>
    <p class="subtitle">Final step: Upload photos and record a quick verification video</p>

    <div class="card">
      <div class="error-message" id="error-message"></div>
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p id="loading-text">Uploading files...</p>
      </div>

      <form id="photo-upload-form">
        <div class="photo-upload-section">
          <label for="front-face">Front Face Photo</label>
          <input type="file" id="front-face" accept="image/*" required>
          <img id="front-preview" class="photo-preview" alt="Front face preview">
        </div>

        <div class="photo-upload-section">
          <label for="side-face">Side Profile Photo</label>
          <input type="file" id="side-face" accept="image/*" required>
          <img id="side-preview" class="photo-preview" alt="Side face preview">
        </div>

        <div class="liveness-section">
          <h3>Step 3: Quick Verification Video (3 seconds)</h3>
          <div class="liveness-prompt">
            Look at the camera and clearly say:<br>
            <strong>"I'm [Your Name] and I want to be on Mansion Mayhem"</strong>
          </div>

          <div class="video-container" id="video-container" style="display: none;">
            <video id="liveness-video" autoplay muted playsinline></video>
            <div class="video-overlay" id="video-overlay"></div>
            <div class="recording-indicator" id="recording-indicator">
              <div class="recording-dot"></div>
              <span id="recording-timer">0s</span>
            </div>
          </div>

          <div class="video-controls">
            <button type="button" class="btn-video primary" id="start-recording-btn">
              Start Recording (3 seconds)
            </button>
            <button type="button" class="btn-video secondary" id="redo-recording-btn" style="display: none;">
              Redo Recording
            </button>
          </div>

          <div class="liveness-complete" id="liveness-complete" style="display: none;">
            ‚úì Verification video recorded successfully
          </div>
        </div>

        <div class="instructions">
          <strong>Requirements:</strong>
          <ul>
            <li>Front photo: Looking directly at camera, neutral expression</li>
            <li>Side profile: 90-degree angle showing profile clearly</li>
            <li>Verification video: Clear view of face, say your name</li>
            <li>Good lighting with no harsh shadows</li>
            <li>No filters, glasses, or obstructions</li>
            <li>These will be used to train AI models for authentic content generation</li>
          </ul>
        </div>

        <button type="submit" class="btn" id="submit-btn">Upload Photos & Complete Application</button>
      </form>
    </div>
  </div>

  <footer class="footer">
    <p>¬© 2026 ImmersiVerse OS</p>
    <p style="margin-top: 8px;">Part of the <a href="/" style="color: var(--gold); text-decoration: none;">ImmersiVerse OS</a> platform</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase - MUST match main project
    const supabaseUrl = 'https://mllqzeaxqusoryteaxzg.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sbHF6ZWF4cXVzb3J5dGVheHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0ODA1NzAsImV4cCI6MjA4NjA1NjU3MH0.s9CAe91gUG8uZ7Nrjd1pIX9YYvpNKa2lOrt6HDUarec';
    let mmPhotoSupabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
    console.log('‚úÖ Photo upload Supabase initialized');

    // Get cast member ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const castMemberId = urlParams.get('id');

    if (!castMemberId) {
      showError('Missing application ID. Please complete the application form first.');
      document.getElementById('photo-upload-form').style.display = 'none';
    }

    // Preview images when selected
    document.getElementById('front-face').addEventListener('change', function(e) {
      previewImage(e.target, 'front-preview');
    });

    document.getElementById('side-face').addEventListener('change', function(e) {
      previewImage(e.target, 'side-preview');
    });

    function previewImage(input, previewId) {
      const preview = document.getElementById(previewId);
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    // ===================================================================
    // LIVENESS VIDEO RECORDING
    // ===================================================================
    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordedBlob = null;
    let recordingTimer = null;

    const startRecordingBtn = document.getElementById('start-recording-btn');
    const redoRecordingBtn = document.getElementById('redo-recording-btn');
    const videoContainer = document.getElementById('video-container');
    const videoElement = document.getElementById('liveness-video');
    const videoOverlay = document.getElementById('video-overlay');
    const recordingIndicator = document.getElementById('recording-indicator');
    const recordingTimerEl = document.getElementById('recording-timer');
    const livenessComplete = document.getElementById('liveness-complete');

    // Start recording button
    startRecordingBtn.addEventListener('click', async () => {
      try {
        // Request camera access
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: 1280, height: 720 },
          audio: true
        });

        videoElement.srcObject = mediaStream;
        videoContainer.style.display = 'block';
        startRecordingBtn.disabled = true;

        // Show countdown
        await countdown(3);

        // Start recording
        startRecording();

      } catch (error) {
        console.error('Camera access error:', error);
        showError('Could not access camera. Please allow camera permissions and try again.');
        stopCamera();
      }
    });

    // Redo recording button
    redoRecordingBtn.addEventListener('click', () => {
      recordedBlob = null;
      recordedChunks = [];
      livenessComplete.style.display = 'none';
      redoRecordingBtn.style.display = 'none';
      startRecordingBtn.style.display = 'inline-block';
      startRecordingBtn.disabled = false;
      videoContainer.style.display = 'none';
      stopCamera();
    });

    async function countdown(seconds) {
      for (let i = seconds; i > 0; i--) {
        videoOverlay.innerHTML = `<div class="countdown">${i}</div>`;
        await sleep(1000);
      }
      videoOverlay.innerHTML = '';
    }

    function startRecording() {
      recordedChunks = [];

      mediaRecorder = new MediaRecorder(mediaStream, {
        mimeType: 'video/webm;codecs=vp8,opus'
      });

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
        onRecordingComplete();
      };

      mediaRecorder.start();
      recordingIndicator.classList.add('active');

      // Auto-stop after 3 seconds
      let elapsed = 0;
      recordingTimer = setInterval(() => {
        elapsed++;
        recordingTimerEl.textContent = elapsed + 's';

        if (elapsed >= 3) {
          stopRecording();
        }
      }, 1000);
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }

      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }

      recordingIndicator.classList.remove('active');
      stopCamera();
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      videoElement.srcObject = null;
    }

    async function onRecordingComplete() {
      // Validate that video captured a face
      const isValid = await validateVideoCapture();

      if (!isValid) {
        showError('‚ö†Ô∏è No face detected in the video. Please ensure your face is clearly visible and well-lit, then try recording again.');
        recordedBlob = null;
        recordedChunks = [];
        startRecordingBtn.disabled = false;
        videoContainer.style.display = 'none';
        return;
      }

      videoContainer.style.display = 'none';
      livenessComplete.style.display = 'block';
      startRecordingBtn.style.display = 'none';
      redoRecordingBtn.style.display = 'inline-block';
    }

    async function validateVideoCapture() {
      try {
        // Create a video element to analyze the recorded video
        const testVideo = document.createElement('video');
        testVideo.src = URL.createObjectURL(recordedBlob);
        testVideo.muted = true;

        return new Promise((resolve) => {
          testVideo.onloadeddata = async () => {
            // Seek to middle of video
            testVideo.currentTime = 1.5;

            testVideo.onseeked = async () => {
              // Capture frame to canvas
              const canvas = document.createElement('canvas');
              canvas.width = testVideo.videoWidth;
              canvas.height = testVideo.videoHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(testVideo, 0, 0);

              // Check if video is not completely black/blank
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const brightness = calculateBrightness(imageData);

              console.log('üìπ Video validation - Brightness:', brightness);

              // If brightness is too low, video is likely black/blocked
              if (brightness < 10) {
                console.log('‚ùå Video too dark - likely no face captured');
                URL.revokeObjectURL(testVideo.src);
                resolve(false);
                return;
              }

              // Try to use Face Detection API if available
              if ('FaceDetector' in window) {
                try {
                  const faceDetector = new FaceDetector({ maxDetectedFaces: 1 });
                  const faces = await faceDetector.detect(canvas);
                  console.log('üë§ Faces detected:', faces.length);
                  URL.revokeObjectURL(testVideo.src);
                  resolve(faces.length > 0);
                  return;
                } catch (e) {
                  console.log('Face Detection API not available, using brightness check');
                }
              }

              // Fallback: If brightness is reasonable, assume face is present
              console.log('‚úÖ Video brightness acceptable');
              URL.revokeObjectURL(testVideo.src);
              resolve(true);
            };
          };

          testVideo.onerror = () => {
            console.log('‚ùå Video validation error');
            URL.revokeObjectURL(testVideo.src);
            resolve(false);
          };

          // Timeout after 5 seconds
          setTimeout(() => {
            URL.revokeObjectURL(testVideo.src);
            console.log('‚è±Ô∏è Video validation timeout - assuming valid');
            resolve(true);
          }, 5000);
        });
      } catch (error) {
        console.error('Video validation error:', error);
        return true; // Fail open - allow video if validation fails
      }
    }

    function calculateBrightness(imageData) {
      let totalBrightness = 0;
      const data = imageData.data;
      const pixelCount = data.length / 4;

      for (let i = 0; i < data.length; i += 4) {
        // Calculate perceived brightness
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const brightness = (r * 0.299 + g * 0.587 + b * 0.114);
        totalBrightness += brightness;
      }

      return totalBrightness / pixelCount;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Handle form submission
    document.getElementById('photo-upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const frontFile = document.getElementById('front-face').files[0];
      const sideFile = document.getElementById('side-face').files[0];

      // Validation
      if (!frontFile || !sideFile) {
        showError('Please select both front and side face photos.');
        return;
      }

      if (!recordedBlob) {
        showError('Please record the verification video (Step 3).');
        return;
      }

      // Show loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading-text').textContent = 'Uploading files...';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('error-message').style.display = 'none';

      try {
        // Upload front photo
        document.getElementById('loading-text').textContent = 'Uploading front photo...';
        const frontPath = `cast-photos/${castMemberId}/front-${Date.now()}.jpg`;
        const { data: frontData, error: frontError } = await mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .upload(frontPath, frontFile, {
            cacheControl: '3600',
            upsert: false
          });

        if (frontError) throw new Error(`Front photo upload failed: ${frontError.message}`);

        // Upload side photo
        document.getElementById('loading-text').textContent = 'Uploading side photo...';
        const sidePath = `cast-photos/${castMemberId}/side-${Date.now()}.jpg`;
        const { data: sideData, error: sideError } = await mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .upload(sidePath, sideFile, {
            cacheControl: '3600',
            upsert: false
          });

        if (sideError) throw new Error(`Side photo upload failed: ${sideError.message}`);

        // Upload liveness video
        document.getElementById('loading-text').textContent = 'Uploading verification video...';
        const videoPath = `cast-photos/${castMemberId}/liveness-${Date.now()}.webm`;
        const { data: videoData, error: videoError } = await mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .upload(videoPath, recordedBlob, {
            cacheControl: '3600',
            upsert: false,
            contentType: 'video/webm'
          });

        if (videoError) throw new Error(`Video upload failed: ${videoError.message}`);

        // Get public URLs
        const { data: { publicUrl: frontUrl } } = mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .getPublicUrl(frontPath);

        const { data: { publicUrl: sideUrl } } = mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .getPublicUrl(sidePath);

        const { data: { publicUrl: videoUrl } } = mmPhotoSupabase.storage
          .from('mansion-mayhem')
          .getPublicUrl(videoPath);

        // Update cast_members record
        document.getElementById('loading-text').textContent = 'Saving your information...';
        const { error: updateError } = await mmPhotoSupabase
          .from('cast_members')
          .update({
            front_face_url: frontUrl,
            side_face_url: sideUrl,
            liveness_video_url: videoUrl,
            photos_uploaded_at: new Date().toISOString()
          })
          .eq('id', castMemberId);

        if (updateError) throw new Error(`Failed to save URLs: ${updateError.message}`);

        // Trigger face embedding extraction (optional - happens in background)
        try {
          await fetch('/.netlify/functions/mansion-mayhem-extract-face', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cast_member_id: castMemberId,
              front_face_url: frontUrl,
              side_face_url: sideUrl,
              liveness_video_url: videoUrl
            })
          });
        } catch (embeddingError) {
          console.log('Face embedding extraction will be processed later:', embeddingError);
        }

        // Redirect to success page
        window.location.href = 'application-complete.html';

      } catch (error) {
        console.error('Upload error:', error);
        showError(error.message || 'Upload failed. Please try again.');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
      }
    });

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
  </script>
  <script type="module" src="js/invite-gate.js"></script>
</body>
</html>
