<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby ‚Äî Mansion Mayhem</title>
  <link rel="stylesheet" href="/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .lobby-header { padding: 1.5rem 0 1rem; text-align: center; }
    .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
    .mode-card { background: var(--card); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .mode-card.selected { border-color: var(--rose); box-shadow: var(--glow-rose); }
    .mode-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--gradient-brand); opacity: 0; transition: opacity 0.2s; }
    .mode-card.selected::before { opacity: 1; }
    .mode-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .mode-name { font-weight: 700; font-size: 0.95rem; }
    .mode-time { font-size: 0.75rem; color: var(--text-3); margin-top: 0.15rem; }
    .mode-players { font-size: 0.7rem; color: var(--purple); margin-top: 0.25rem; }

    .join-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1.5rem; }
    .join-row { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    .join-input { flex: 1; text-align: center; font-size: 1.25rem; font-family: var(--font-mono); letter-spacing: 0.2em; text-transform: uppercase; }

    .active-games { margin-top: 1rem; }
    .game-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 0.5rem; cursor: pointer; transition: all 0.15s; }
    .game-row:hover { border-color: rgba(255,255,255,0.12); background: var(--elevated); }
    .game-mode-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .game-info { flex: 1; }
    .game-info-title { font-weight: 600; font-size: 0.9rem; }
    .game-info-sub { font-size: 0.75rem; color: var(--text-3); }
    .game-players-count { font-family: var(--font-mono); font-size: 0.85rem; color: var(--gold); font-weight: 700; }

    .waiting-room { text-align: center; padding: 2rem 0; }
    .waiting-code { font-family: var(--font-mono); font-size: 2.5rem; font-weight: 700; letter-spacing: 0.3em; color: var(--gold); margin: 1rem 0; }
    .waiting-players { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin: 1.5rem 0; }
    .waiting-player { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-full); padding: 0.4rem 0.75rem; font-size: 0.8rem; display: flex; align-items: center; gap: 0.35rem; }
    .waiting-player .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
    .waiting-countdown { font-size: 3rem; font-weight: 900; margin: 1rem 0; font-family: var(--font-mono); }

    .empty-state { text-align: center; padding: 3rem 0; color: var(--text-3); }
    .empty-icon { font-size: 3rem; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="page">
    <!-- NAV -->
    <nav class="nav">
      <span class="nav-title">üëë Mansion Mayhem</span>
      <button class="btn btn-ghost btn-sm" onclick="goProfile()">Profile</button>
      <button class="btn btn-ghost btn-sm" onclick="handleSignOut()">Out</button>
    </nav>

    <div class="container page-padded">
      <!-- VIEW: CREATE/JOIN (default) -->
      <div id="viewMain">
        <div class="lobby-header">
          <h1 class="title-lg">Choose Your Mode</h1>
          <p class="body-sm" style="margin-top:0.25rem">Create a game or join with a code</p>
        </div>

        <!-- MODE SELECTION -->
        <div class="mode-grid" id="modeGrid">
          <div class="mode-card selected" data-mode="party" onclick="selectMode('party')">
            <div class="mode-icon">üéâ</div>
            <div class="mode-name">Party</div>
            <div class="mode-time">35 minutes</div>
            <div class="mode-players">8-20 players</div>
          </div>
          <div class="mode-card" data-mode="blitz" onclick="selectMode('blitz')">
            <div class="mode-icon">‚ö°</div>
            <div class="mode-name">Blitz</div>
            <div class="mode-time">15 minutes</div>
            <div class="mode-players">6-12 players</div>
          </div>
          <div class="mode-card" data-mode="sprint" onclick="selectMode('sprint')">
            <div class="mode-icon">üèÉ</div>
            <div class="mode-name">Sprint</div>
            <div class="mode-time">5 minutes</div>
            <div class="mode-players">4-8 players</div>
          </div>
          <div class="mode-card" data-mode="weekly" onclick="selectMode('weekly')">
            <div class="mode-icon">üìÖ</div>
            <div class="mode-name">Season</div>
            <div class="mode-time">10 weeks</div>
            <div class="mode-players">10-20 players</div>
          </div>
        </div>

        <button class="btn btn-primary btn-block btn-lg" onclick="createGame()" id="createBtn">Create Game</button>

        <!-- JOIN -->
        <div class="join-section">
          <div class="caption">Join with Code</div>
          <div class="join-row">
            <input class="input join-input" id="joinCode" placeholder="ABCDEF" maxlength="6">
            <button class="btn btn-secondary" onclick="joinGame()">Join</button>
          </div>
        </div>

        <!-- ACTIVE GAMES -->
        <div class="active-games">
          <div class="caption" style="margin-bottom:0.5rem">Open Games</div>
          <div id="gamesList"></div>
        </div>
      </div>

      <!-- VIEW: WAITING ROOM (after join/create) -->
      <div id="viewWaiting" style="display:none">
        <div class="waiting-room">
          <div style="font-size:2rem;margin-bottom:0.5rem">üè∞</div>
          <h2 class="title-lg">Waiting for Players</h2>
          <div class="waiting-code" id="waitingCode">------</div>
          <p class="body-sm">Share this code with friends</p>

          <div class="waiting-players" id="waitingPlayers"></div>

          <div id="waitingStatus" class="body-sm" style="color:var(--gold)">Waiting for players to join...</div>
          <div id="waitingCountdown" class="waiting-countdown" style="display:none"></div>

          <button class="btn btn-ghost" style="margin-top:1.5rem" onclick="leaveGame()">Leave Game</button>
        </div>
      </div>
    </div>

    <!-- TAB BAR -->
    <div class="tab-bar">
      <button class="tab-item active"><span class="tab-icon">üè†</span>Lobby</button>
      <a href="/pages/profile.html" class="tab-item"><span class="tab-icon">üë§</span>Profile</a>
      <a href="/pages/leaderboard.html" class="tab-item"><span class="tab-icon">üèÜ</span>Ranks</a>
      <a href="/pages/how-to-play.html" class="tab-item"><span class="tab-icon">üìñ</span>Rules</a>
    </div>
  </div>

  <script type="module">
    import { waitForSupabase, getUser, requireAuth, signOut, getSupabase } from '/js/supabase.js';

    let sb, user, selectedMode = 'party', currentGameId = null;

    async function init() {
      sb = await waitForSupabase();
      user = await requireAuth();
      if (!user) return;
      loadOpenGames();
      // Check if user is already in a game
      checkExistingGame();
    }

    window.selectMode = (mode) => {
      selectedMode = mode;
      document.querySelectorAll('.mode-card').forEach(c => c.classList.toggle('selected', c.dataset.mode === mode));
    };

    window.createGame = async () => {
      const btn = document.getElementById('createBtn');
      btn.disabled = true; btn.textContent = 'Creating...';

      // Generate 6-char code
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];

      const { data: game, error } = await sb.from('mm_games').insert({
        game_code: code,
        status: 'waiting_lobby',
        game_mode: selectedMode,
        max_players: selectedMode === 'party' ? 20 : selectedMode === 'blitz' ? 12 : selectedMode === 'sprint' ? 8 : 20,
        current_players: 0,
        current_phase: 'lobby',
        phase_started_at: new Date().toISOString(),
      }).select().single();

      if (error) { alert(error.message); btn.disabled = false; btn.textContent = 'Create Game'; return; }

      // Join as creator
      await sb.rpc('join_game', { p_game_id: game.id, p_user_id: user.id });

      // Schedule game events
      await sb.rpc('schedule_game_events', { p_game_id: game.id, p_mode: selectedMode });

      currentGameId = game.id;
      showWaitingRoom(game);
      btn.disabled = false; btn.textContent = 'Create Game';
    };

    window.joinGame = async () => {
      const code = document.getElementById('joinCode').value.trim().toUpperCase();
      if (code.length !== 6) { alert('Enter a 6-character code'); return; }

      const { data: game } = await sb.from('mm_games').select('*').eq('game_code', code).in('status', ['waiting_lobby', 'active_lobby', 'recruiting']).maybeSingle();
      if (!game) { alert('Game not found or already started'); return; }

      const result = await sb.rpc('join_game', { p_game_id: game.id, p_user_id: user.id });
      if (result.error) { alert(result.error.message); return; }

      currentGameId = game.id;
      showWaitingRoom(game);
    };

    window.joinExisting = async (gameId) => {
      const result = await sb.rpc('join_game', { p_game_id: gameId, p_user_id: user.id });
      const { data: game } = await sb.from('mm_games').select('*').eq('id', gameId).single();
      if (game) { currentGameId = gameId; showWaitingRoom(game); }
    };

    function showWaitingRoom(game) {
      document.getElementById('viewMain').style.display = 'none';
      document.getElementById('viewWaiting').style.display = 'block';
      document.getElementById('waitingCode').textContent = game.game_code || '------';

      // Subscribe to game changes
      sb.channel(`lobby-${game.id}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'mm_game_cast', filter: `game_id=eq.${game.id}` }, () => loadWaitingPlayers(game.id))
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'mm_games', filter: `id=eq.${game.id}` }, (payload) => {
          if (payload.new.status === 'active') {
            window.location.href = `/pages/episode-play.html?game=${game.id}`;
          }
        })
        .subscribe();

      loadWaitingPlayers(game.id);
    }

    async function loadWaitingPlayers(gameId) {
      const { data } = await sb.from('mm_game_cast').select('*, cast_members(display_name, is_ai_player)').eq('game_id', gameId);
      const el = document.getElementById('waitingPlayers');
      if (!data) return;
      el.innerHTML = data.map(gc => `<div class="waiting-player"><span class="dot"></span>${gc.cast_members?.display_name || 'Player'}${gc.cast_members?.is_ai_player ? ' ü§ñ' : ''}</div>`).join('');
      document.getElementById('waitingStatus').textContent = `${data.length} player${data.length !== 1 ? 's' : ''} in lobby`;
    }

    window.leaveGame = () => {
      currentGameId = null;
      document.getElementById('viewMain').style.display = 'block';
      document.getElementById('viewWaiting').style.display = 'none';
    };

    async function loadOpenGames() {
      const { data: games } = await sb.from('mm_games').select('*').in('status', ['waiting_lobby', 'active_lobby', 'recruiting']).order('created_at', { ascending: false }).limit(10);
      const el = document.getElementById('gamesList');
      if (!games || games.length === 0) {
        el.innerHTML = `<div class="empty-state"><div class="empty-icon">üè∞</div><p>No open games. Create one!</p></div>`;
        return;
      }
      const modeColors = { party: 'var(--rose)', blitz: 'var(--gold)', sprint: 'var(--cyan)', weekly: 'var(--purple)' };
      const modeIcons = { party: 'üéâ', blitz: '‚ö°', sprint: 'üèÉ', weekly: 'üìÖ' };
      el.innerHTML = games.map(g => `<div class="game-row" onclick="joinExisting('${g.id}')">
        <div class="game-mode-dot" style="background:${modeColors[g.game_mode] || 'var(--text-3)'}"></div>
        <div class="game-info">
          <div class="game-info-title">${modeIcons[g.game_mode] || 'üéÆ'} ${(g.game_mode || 'party').charAt(0).toUpperCase() + (g.game_mode || 'party').slice(1)} Game</div>
          <div class="game-info-sub">Code: ${g.game_code || '???'}</div>
        </div>
        <div class="game-players-count">${g.current_players || 0}/${g.max_players || 20}</div>
      </div>`).join('');
    }

    async function checkExistingGame() {
      // Check if user's cast member is in an active game
      const { data: castMembers } = await sb.from('cast_members').select('id').eq('user_id', user.id);
      if (!castMembers || castMembers.length === 0) return;

      const castIds = castMembers.map(c => c.id);
      const { data: activeGames } = await sb.from('mm_game_cast').select('game_id, mm_games(id, status, game_code, game_mode, current_phase)').in('cast_member_id', castIds).eq('status', 'active');

      if (activeGames) {
        for (const ag of activeGames) {
          const game = ag.mm_games;
          if (!game) continue;
          if (game.status === 'active' && game.current_phase !== 'lobby') {
            // Already in an active game ‚Äî redirect
            window.location.href = `/pages/episode-play.html?game=${game.id}`;
            return;
          }
          if (['waiting_lobby', 'active_lobby'].includes(game.status)) {
            currentGameId = game.id;
            showWaitingRoom(game);
            return;
          }
        }
      }
    }

    window.goProfile = () => { window.location.href = '/pages/profile.html'; };
    window.handleSignOut = async () => { await signOut(); };

    init();
  </script>
</body>
</html>
