<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Games | MANSION MAYHEM</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --bg-sidebar: #0d0d0d;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-dim: #888888;
      --text-muted: #555555;
      --gold: #d4af37;
      --gold-light: #f4e4bc;
      --rose: #e91e63;
      --rose-dark: #ad1457;
      --purple: #9c27b0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --premium: #9c27b0;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .app-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-header {
      padding: 0 20px 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .sidebar-logo {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .sidebar-logo span {
      display: block;
      font-size: 10px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      letter-spacing: 3px;
      background: linear-gradient(135deg, var(--rose), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 4px;
    }
    .tier-badge {
      margin-top: 16px;
      background: linear-gradient(135deg, var(--premium), var(--rose));
      padding: 12px;
      border-radius: 10px;
      font-size: 12px;
      text-align: center;
    }
    .tier-badge .tier-name {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .tier-badge .tier-limit {
      font-size: 11px;
      opacity: 0.9;
    }
    .tier-badge.free {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .upgrade-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--bg);
      padding: 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
      transition: transform 0.2s ease;
    }
    .upgrade-btn:hover {
      transform: translateY(-2px);
    }
    .nav-section { margin-bottom: 24px; }
    .nav-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 20px;
      margin-bottom: 8px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .nav-item:hover {
      background: var(--bg-elevated);
      color: var(--text);
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
      color: var(--gold);
      border-left: 3px solid var(--gold);
    }
    .nav-icon { font-size: 18px; }
    .main-content {
      padding: 32px;
      overflow-y: auto;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      font-weight: 700;
    }
    .page-subtitle {
      color: var(--text-dim);
      font-size: 14px;
      margin-top: 4px;
    }
    .header-actions {
      display: flex;
      gap: 12px;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--bg);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      border-color: var(--gold);
    }
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .game-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .game-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gold), var(--rose));
    }
    .game-card:hover {
      transform: translateY(-4px);
      border-color: var(--gold);
      box-shadow: 0 8px 24px rgba(212, 175, 55, 0.2);
    }
    .game-card.locked {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .game-card.locked:hover {
      transform: none;
      box-shadow: none;
    }
    .game-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 12px;
    }
    .game-status.active { background: rgba(76, 175, 80, 0.2); color: var(--success); }
    .game-status.lobby { background: rgba(255, 152, 0, 0.2); color: var(--warning); }
    .game-status.setup { background: rgba(136, 136, 136, 0.2); color: var(--text-dim); }
    .game-status.completed { background: rgba(233, 30, 99, 0.2); color: var(--rose); }
    .game-title {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .game-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--gold);
      margin-bottom: 12px;
    }
    .game-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .game-stat {
      text-align: center;
    }
    .game-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
    }
    .game-stat-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }
    .game-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .game-action-btn {
      flex: 1;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .game-action-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-dim);
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .empty-state-title {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .empty-state-description {
      font-size: 14px;
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
      background: var(--bg-elevated);
      color: var(--text);
    }
    .modal-body {
      padding: 24px;
    }
    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    .form-hint {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 8px;
    }
    .toggle-group {
      display: flex;
      gap: 12px;
    }
    .toggle-option {
      flex: 1;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
    }
    .toggle-option:hover {
      border-color: var(--gold);
    }
    .toggle-option.selected {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
      color: var(--gold);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .checkbox-group:hover {
      border-color: var(--gold);
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .checkbox-group label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
    }
    .upgrade-notice {
      background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(233, 30, 99, 0.2));
      border: 1px solid var(--premium);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .upgrade-notice-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .upgrade-notice-description {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 16px;
    }
    .feature-list {
      list-style: none;
      margin-bottom: 16px;
    }
    .feature-list li {
      padding: 8px 0;
      padding-left: 28px;
      position: relative;
      font-size: 13px;
    }
    .feature-list li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: var(--success);
      font-weight: 700;
    }
    .invite-section {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .invite-link-display {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }
    .invite-link-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      color: var(--gold);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      user-select: all;
    }
    .copy-btn {
      background: var(--gold);
      color: var(--bg);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .copy-btn:hover {
      transform: scale(1.05);
    }

    /* Settings & Billing Styles */
    .settings-container, .billing-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .settings-section, .billing-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .settings-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }
    .settings-toggle:last-child {
      border-bottom: none;
    }
    .toggle-label {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    .toggle-description {
      font-size: 13px;
      color: var(--text-dim);
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--rose);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .settings-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 24px;
    }
    .subscription-card {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(233, 30, 99, 0.1));
      border: 1px solid var(--gold);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .subscription-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .subscription-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .subscription-tier {
      font-size: 24px;
      font-weight: 900;
      color: var(--gold);
      font-family: 'Playfair Display', serif;
    }
    .subscription-status {
      background: var(--success);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 700;
    }
    .subscription-features {
      margin: 20px 0;
    }
    .subscription-actions {
      display: flex;
      justify-content: flex-end;
    }
    .empty-state-small {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-dim);
    }

    @media (max-width: 992px) {
      .app-layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .games-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- MANSION MAYHEM - Persistent Navigation Bar -->
  <!-- Navigation (loaded from include) -->
  <div id="globalNavPlaceholder"></div>
  <script>
    fetch('/includes/global-nav.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('globalNavPlaceholder').innerHTML = data;
      });
  </script>
  <!-- Navigation loaded - displays role-based links, notifications, and user menu -->

  <div class="app-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          MANSION MAYHEM
          <span>My Games</span>
        </div>
        <div class="tier-badge" id="tierBadge">
          <div class="tier-name" id="tierName">Loading...</div>
          <div class="tier-limit" id="tierLimit"></div>
        </div>
      </div>
      <nav>
        <div class="nav-section">
          <div class="nav-label">Games</div>
          <a href="#" class="nav-item active" onclick="showView('dashboard')"><span class="nav-icon">üéÆ</span>My Games</a>
          <a href="#" class="nav-item" onclick="showView('browse')"><span class="nav-icon">üåê</span>Browse Games</a>
        </div>
        <div class="nav-section">
          <div class="nav-label">Account</div>
          <a href="#" class="nav-item" onclick="showView('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</a>
          <a href="#" class="nav-item" onclick="showView('billing')"><span class="nav-icon">üí≥</span>Billing</a>
        </div>
        <div class="nav-section">
          <div class="nav-label">Platform</div>
          <a href="cast-portal.html" class="nav-item"><span class="nav-icon">üë•</span>Cast Portal</a>
          <a href="/" class="nav-item"><span class="nav-icon">üè†</span>Home</a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <div id="dashboardView">
        <div class="page-header">
          <div>
            <h1 class="page-title">My Games</h1>
            <p class="page-subtitle">Create and manage your own Mansion Mayhem experiences</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="openCreateGameModal()" id="createGameBtn">
              üé¨ Create Game
            </button>
          </div>
        </div>

        <!-- Upgrade Notice (shown for free users) -->
        <div class="upgrade-notice" id="upgradeNotice" style="display: none;">
          <div class="upgrade-notice-title">
            <span>‚≠ê</span> Upgrade to Premium
          </div>
          <div class="upgrade-notice-description">
            Create your own games, recruit cast members, and use AI-powered autopilot scenarios!
          </div>
          <ul class="feature-list">
            <li>Create up to 5 games</li>
            <li>Recruit up to 50 cast members per game</li>
            <li>AI scenario generation</li>
            <li>Autopilot mode for hands-free drama</li>
            <li>Advanced analytics</li>
          </ul>
          <button class="upgrade-btn" onclick="showUpgradeModal()">Upgrade Now - $9.99/month</button>
        </div>

        <!-- Games Grid -->
        <div class="games-grid" id="gamesGrid">
          <!-- Games loaded dynamically -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <div class="empty-state-icon">üé≠</div>
          <div class="empty-state-title">No games yet</div>
          <div class="empty-state-description">
            Create your first game to start directing your own drama-filled reality experience!
          </div>
          <button class="btn btn-primary" onclick="openCreateGameModal()" style="margin: 0 auto;">
            üé¨ Create Your First Game
          </button>
        </div>
      </div>

      <!-- Settings View -->
      <div id="settingsView" style="display: none;">
        <div class="page-header">
          <div>
            <h1 class="page-title">‚öôÔ∏è Settings</h1>
            <p class="page-subtitle">Manage your account preferences</p>
          </div>
        </div>

        <div class="settings-container">
          <div class="settings-section">
            <h3 class="section-title">Account Information</h3>
            <form id="accountSettingsForm">
              <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" class="form-input" id="settingsDisplayName" placeholder="Your display name">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="settingsEmail" disabled>
                <div class="form-hint">Email cannot be changed</div>
              </div>
            </form>
          </div>

          <div class="settings-section">
            <h3 class="section-title">Notification Preferences</h3>
            <div class="settings-toggle">
              <div>
                <div class="toggle-label">Email Notifications</div>
                <div class="toggle-description">Receive updates about scenarios and game activity</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="emailNotifications">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-toggle">
              <div>
                <div class="toggle-label">Push Notifications</div>
                <div class="toggle-description">Get notified about urgent scenarios</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="pushNotifications">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
          </div>
        </div>
      </div>

      <!-- Billing View -->
      <div id="billingView" style="display: none;">
        <div class="page-header">
          <div>
            <h1 class="page-title">üí≥ Billing</h1>
            <p class="page-subtitle">Manage your subscription and payment methods</p>
          </div>
        </div>

        <div class="billing-container">
          <div class="subscription-card">
            <div class="subscription-header">
              <div>
                <h3 class="subscription-title">Current Plan</h3>
                <p class="subscription-tier" id="currentPlanTier">Loading...</p>
              </div>
              <div class="subscription-status" id="subscriptionStatus">Active</div>
            </div>
            <div class="subscription-features" id="planFeatures">
              <!-- Features loaded dynamically -->
            </div>
            <div class="subscription-actions">
              <button class="btn btn-primary" onclick="showUpgradeModal()" id="upgradeButton">Upgrade Plan</button>
            </div>
          </div>

          <div class="billing-section">
            <h3 class="section-title">Payment History</h3>
            <div class="empty-state-small">
              <p>No payment history available</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Game Modal -->
  <div class="modal" id="createGameModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create New Game</div>
        <button class="modal-close" onclick="closeModal('createGameModal')">√ó</button>
      </div>
      <div class="modal-body">
        <form id="createGameForm">
          <div class="form-group">
            <label class="form-label">Game Title</label>
            <input type="text" class="form-input" id="gameTitle" placeholder="e.g., My Bachelor Mansion" required>
            <div class="form-hint">Give your game a catchy name</div>
          </div>

          <div class="form-group">
            <label class="form-label">Game Code</label>
            <input type="text" class="form-input" id="gameCode" placeholder="e.g., BACHELOR-2024" required>
            <div class="form-hint">Unique identifier (letters, numbers, hyphens only)</div>
          </div>

          <div class="form-group">
            <label class="form-label">Theme</label>
            <select class="form-select" id="gameTheme">
              <option value="mansion-mayhem" selected>üè∞ Mansion Mayhem</option>
            </select>
            <div class="form-hint">More locations coming soon! (Premium feature)</div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="gameDescription" placeholder="Describe your game..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Visibility</label>
            <div class="toggle-group">
              <div class="toggle-option selected" data-value="public" onclick="selectToggle(this, 'visibility')">
                üåê Public<br><small style="opacity: 0.7;">Anyone can find</small>
              </div>
              <div class="toggle-option" data-value="private" onclick="selectToggle(this, 'visibility')">
                üîí Private<br><small style="opacity: 0.7;">Only you can see</small>
              </div>
              <div class="toggle-option" data-value="invite-only" onclick="selectToggle(this, 'visibility')">
                üìß Invite Only<br><small style="opacity: 0.7;">Link required</small>
              </div>
            </div>
            <input type="hidden" id="gameVisibility" value="public">
          </div>

          <!-- Invite Link Section (shows when invite-only selected) -->
          <div class="form-group" id="inviteLinkSection" style="display: none;">
            <label class="form-label">üìß Invite Link</label>
            <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 12px; padding: 1rem;">
              <div style="margin-bottom: 0.75rem; color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">
                Share this link with players you want to invite
              </div>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                <input
                  type="text"
                  readonly
                  id="inviteLinkDisplay"
                  class="form-input"
                  value="Link will be generated after game is created"
                  style="flex: 1; background: rgba(0, 0, 0, 0.3); cursor: default;"
                >
                <button type="button" class="btn btn-secondary" onclick="copyInviteLink()" id="copyInviteBtn" disabled>
                  üìã Copy
                </button>
              </div>
              <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5);">
                üí° Tip: Invite link will be generated when you create the game
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Max Cast Members</label>
            <select class="form-select" id="maxCastMembers">
              <option value="8">8 cast members</option>
              <option value="12">12 cast members</option>
              <option value="16">16 cast members</option>
              <option value="20" selected>20 cast members</option>
              <option value="30">30 cast members</option>
              <option value="50">50 cast members</option>
            </select>
          </div>

          <div class="form-group">
            <div class="checkbox-group" onclick="toggleCheckbox('autopilotEnabled')">
              <input type="checkbox" id="autopilotEnabled">
              <label>
                <strong>Enable Autopilot Mode</strong><br>
                <small style="color: var(--text-dim);">AI generates scenarios and responses automatically</small>
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createGameModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createGame()">Create Game</button>
      </div>
    </div>
  </div>

  <!-- Game Management Modal -->
  <div class="modal" id="gameManageModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="manageGameTitle">Manage Game</div>
        <button class="modal-close" onclick="closeModal('gameManageModal')">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Game Details -->
        <div class="form-group">
          <label class="form-label">Game Status</label>
          <select class="form-select" id="manageGameStatus">
            <option value="setup">Setup - Not started yet</option>
            <option value="lobby">Lobby - Waiting for cast to join</option>
            <option value="active">Active - Game in progress</option>
            <option value="paused">Paused - Temporarily stopped</option>
            <option value="completed">Completed - Game finished</option>
          </select>
        </div>

        <!-- Invite Section -->
        <div class="invite-section">
          <label class="form-label">Invite Cast Members</label>
          <p style="font-size: 13px; color: var(--text-dim); margin-bottom: 12px;">
            Share this link to invite people to join your game as cast members
          </p>
          <div class="invite-link-display">
            <input type="text" class="invite-link-input" id="inviteLinkDisplay" readonly>
            <button class="copy-btn" onclick="copyInviteLink()">üìã Copy</button>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 12px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="regenerateInviteLink()">üîÑ Regenerate</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="shareInviteLink()">üì§ Share</button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="form-group">
          <label class="form-label">Quick Actions</label>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-secondary" onclick="goToDirectorConsole()">
              üé¨ Launch Scenario
            </button>
            <button class="btn btn-secondary" onclick="browseCastMembers()">
              üë• Browse & Recruit Cast
            </button>
            <button class="btn btn-secondary" onclick="viewGameAnalytics()">
              üìä View Analytics
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('gameManageModal')">Close</button>
        <button class="btn btn-primary" onclick="saveGameSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Supabase Integration -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Wait for Supabase library to load, then initialize client
    (function initSupabase() {
      if (typeof window.supabase === 'undefined') {
        setTimeout(initSupabase, 50);
        return;
      }

      // Initialize Supabase Client (global scope for navigation.js)
      var supabase = window.supabase.createClient(
        'https://mllqzeaxqusoryt–µaxzg.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweGJocWliaW1la2pobHVtbm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUwODYsImV4cCI6MjA4NjYwMTA4Nn0.0BmbaObOERMZ5r4znb5BQbrGpB5lE5Fq6KnEzxA0YhY'
      );
      window.supabase = supabase; // Also assign to window for consistency
    })();

    // currentUser is declared in navigation.js
    let userTier = null;
    let userGames = [];
    let currentGameId = null;

    // ========================================
    // AUTHENTICATION & TIER CHECK
    // ========================================
    async function checkAuth() {
      // navigation.js already handles auth - this is just to get current user
      try {
        // Wait a moment for navigation.js to set currentUser
        let attempts = 0;
        while (!currentUser && attempts < 20) {
          await new Promise(resolve => setTimeout(resolve, 50));
          attempts++;
        }

        if (!currentUser) {
          // Get user directly from Supabase
          const { data: { user }, error } = await supabase.auth.getUser();
          if (user) {
            currentUser = user;
          } else {
            console.log('No user session found, but continuing anyway');
            return true;
          }
        }

      // Load user's subscription tier
      const { data: profile } = await supabase
        .from('profiles')
        .select('subscription_tier, games_created_count')
        .eq('id', currentUser.id)
        .single();

      if (profile) {
        await loadTierInfo(profile.subscription_tier || 'free');
        updateTierDisplay();
      }

      return true;
      } catch (err) {
        console.error('Auth check failed:', err);
        alert('Authentication error. Please sign in again.');
        window.location.href = '/pages/sign-in.html';
        return false;
      }
    }

    async function loadTierInfo(tierName) {
      const { data } = await supabase
        .from('subscription_tiers')
        .select('*')
        .eq('tier_name', tierName)
        .single();

      userTier = data || {
        tier_name: 'free',
        display_name: 'Free',
        can_create_games: false,
        max_games: 0
      };
    }

    function updateTierDisplay() {
      const tierBadge = document.getElementById('tierBadge');
      const tierName = document.getElementById('tierName');
      const tierLimit = document.getElementById('tierLimit');
      const createGameBtn = document.getElementById('createGameBtn');
      const upgradeNotice = document.getElementById('upgradeNotice');

      tierName.textContent = userTier.display_name;

      if (userTier.tier_name === 'free') {
        tierBadge.classList.add('free');
        tierLimit.textContent = 'Viewing only';
        upgradeNotice.style.display = 'block';

        // Show upgrade button instead of create game
        createGameBtn.innerHTML = '‚≠ê Upgrade to Create Games';
        createGameBtn.onclick = showUpgradeModal;
      } else {
        tierLimit.textContent = `${userGames.length}/${userTier.max_games || '‚àû'} games`;
        upgradeNotice.style.display = 'none';
      }
    }

    async function checkCanCreateGame() {
      const { data, error } = await supabase
        .rpc('can_user_create_game', { user_id_param: currentUser.id });

      if (error) {
        console.error('Error checking game creation:', error);
        return { can_create: false, reason: 'Error checking permissions' };
      }

      return data[0] || { can_create: false, reason: 'Unknown error' };
    }

    // ========================================
    // LOAD USER'S GAMES
    // ========================================
    async function loadGames() {
      const { data, error } = await supabase
        .from('mm_games')
        .select(`
          *,
          mm_game_cast(count)
        `)
        .eq('creator_id', currentUser.id)
        .order('created_at', { ascending: false });

      // Get scenario counts separately
      if (data) {
        for (let game of data) {
          const { count } = await supabase
            .from('scenarios')
            .select('*', { count: 'exact', head: true })
            .eq('game_id', game.id);
          game.scenarios_count = count || 0;
        }
      }

      if (error) {
        console.error('Error loading games:', error);
        return;
      }

      userGames = data || [];
      renderGames();
      updateTierDisplay();
    }

    function renderGames() {
      const grid = document.getElementById('gamesGrid');
      const emptyState = document.getElementById('emptyState');

      if (!userGames || userGames.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      emptyState.style.display = 'none';

      grid.innerHTML = userGames.map(game => {
        const castCount = game.cast_joined_count || 0;
        const scenariosCount = game.scenarios_launched_count || 0;
        const statusClass = game.status || 'setup';

        return `
          <div class="game-card" onclick="openGameManageModal('${game.id}')">
            <div class="game-status ${statusClass}">${game.status || 'Setup'}</div>
            <div class="game-title">${game.title}</div>
            <div class="game-code">${game.game_code}</div>
            <p style="font-size: 13px; color: var(--text-dim); margin-bottom: 16px;">
              ${game.description || 'No description'}
            </p>
            <div class="game-stats">
              <div class="game-stat">
                <div class="game-stat-value">${castCount}</div>
                <div class="game-stat-label">Cast</div>
              </div>
              <div class="game-stat">
                <div class="game-stat-value">${scenariosCount}</div>
                <div class="game-stat-label">Scenarios</div>
              </div>
              <div class="game-stat">
                <div class="game-stat-value">${game.autopilot_enabled ? 'ON' : 'OFF'}</div>
                <div class="game-stat-label">Autopilot</div>
              </div>
            </div>
            <div class="game-actions" onclick="event.stopPropagation()">
              <button class="game-action-btn" onclick="goToDirectorConsole('${game.id}')">
                üé¨ Scenarios
              </button>
              <button class="game-action-btn" onclick="openGameManageModal('${game.id}')">
                ‚öôÔ∏è Manage
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========================================
    // CREATE GAME
    // ========================================
    async function openCreateGameModal() {
      // Check if user can create games
      const permission = await checkCanCreateGame();

      if (!permission.can_create) {
        alert(permission.reason);
        if (userTier.tier_name === 'free') {
          showUpgradeModal();
        }
        return;
      }

      document.getElementById('createGameModal').classList.add('active');
    }

    async function createGame() {
      const title = document.getElementById('gameTitle').value.trim();
      const code = document.getElementById('gameCode').value.trim().toUpperCase();
      const theme = document.getElementById('gameTheme').value;
      const description = document.getElementById('gameDescription').value.trim();
      const visibility = document.getElementById('gameVisibility').value;
      const maxCast = parseInt(document.getElementById('maxCastMembers').value);
      const autopilot = document.getElementById('autopilotEnabled').checked;

      // Validation
      if (!title || title.length < 3) {
        alert('Please enter a game title (at least 3 characters)');
        return;
      }

      if (!code || !/^[A-Z0-9-]+$/.test(code)) {
        alert('Game code must contain only letters, numbers, and hyphens');
        return;
      }

      // Theme is auto-selected (only Mansion Mayhem available)

      // Check autopilot permission
      if (autopilot && !userTier.can_use_autopilot) {
        alert('Autopilot mode requires Premium subscription');
        return;
      }

      try {
        // Generate invite link token if invite-only
        const inviteToken = visibility === 'invite-only' ? crypto.randomUUID() : null;

        const { data, error } = await supabase
          .from('mm_games')
          .insert({
            game_code: code,
            title: title,
            description: description,
            theme: theme,
            visibility: visibility,
            max_cast_members: maxCast,
            autopilot_enabled: autopilot,
            creator_id: currentUser.id,
            status: 'setup',
            game_type: 'production',
            invite_link_token: inviteToken
          })
          .select()
          .single();

        if (error) throw error;

        // Show invite link if created
        if (visibility === 'invite-only' && inviteToken) {
          const inviteLink = `${window.location.origin}/join.html?invite=${inviteToken}`;
          const inviteLinkDisplay = document.getElementById('inviteLinkDisplay');
          const copyInviteBtn = document.getElementById('copyInviteBtn');

          if (inviteLinkDisplay) {
            inviteLinkDisplay.value = inviteLink;
          }
          if (copyInviteBtn) {
            copyInviteBtn.disabled = false;
          }

          alert(`‚úÖ Game created successfully!\n\nüìß Invite Link:\n${inviteLink}\n\nShare this link with players to join your game!`);
        } else {
          alert('‚úÖ Game created successfully!');
        }

        closeModal('createGameModal');
        await loadGames();

        // Open the new game's management modal
        openGameManageModal(data.id);

      } catch (error) {
        console.error('Error creating game:', error);
        alert('Failed to create game: ' + error.message);
      }
    }

    // ========================================
    // MANAGE GAME
    // ========================================
    async function openGameManageModal(gameId) {
      currentGameId = gameId;

      const game = userGames.find(g => g.id === gameId);
      if (!game) return;

      document.getElementById('manageGameTitle').textContent = game.title;
      document.getElementById('manageGameStatus').value = game.status || 'setup';

      // Generate invite link
      const inviteLink = `${window.location.origin}/join/${game.invite_link_token}`;
      document.getElementById('inviteLinkDisplay').value = inviteLink;

      document.getElementById('gameManageModal').classList.add('active');
    }

    async function saveGameSettings() {
      const status = document.getElementById('manageGameStatus').value;

      try {
        const { error } = await supabase
          .from('mm_games')
          .update({ status: status })
          .eq('id', currentGameId);

        if (error) throw error;

        alert('‚úÖ Game settings saved!');
        closeModal('gameManageModal');
        await loadGames();

      } catch (error) {
        console.error('Error saving game:', error);
        alert('Failed to save settings: ' + error.message);
      }
    }

    function copyInviteLink() {
      const input = document.getElementById('inviteLinkDisplay');
      input.select();
      document.execCommand('copy');

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    }

    async function regenerateInviteLink() {
      if (!confirm('Regenerate invite link? The old link will stop working.')) return;

      try {
        const newToken = Math.random().toString(36).substring(2, 15);

        const { error } = await supabase
          .from('mm_games')
          .update({ invite_link_token: newToken })
          .eq('id', currentGameId);

        if (error) throw error;

        const newLink = `${window.location.origin}/join/${newToken}`;
        document.getElementById('inviteLinkDisplay').value = newLink;
        alert('‚úÖ New invite link generated!');

      } catch (error) {
        console.error('Error regenerating link:', error);
        alert('Failed to regenerate link: ' + error.message);
      }
    }

    function shareInviteLink() {
      const link = document.getElementById('inviteLinkDisplay').value;

      if (navigator.share) {
        navigator.share({
          title: 'Join my Mansion Mayhem game!',
          text: 'You\'re invited to join as a cast member',
          url: link
        });
      } else {
        copyInviteLink();
        alert('Link copied! Share it with your cast members.');
      }
    }

    function goToDirectorConsole(gameId = null) {
      const id = gameId || currentGameId;
      window.location.href = `/director-console.html?game=${id}`;
    }

    function browseCastMembers() {
      const gameId = currentGameId;
      window.location.href = `/browse-cast.html?game=${gameId}`;
    }

    function viewGameAnalytics() {
      alert('Analytics feature coming soon!');
      // TODO: Implement game analytics dashboard
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function selectToggle(element, groupName) {
      const siblings = element.parentElement.querySelectorAll('.toggle-option');
      siblings.forEach(s => s.classList.remove('selected'));
      element.classList.add('selected');

      const hiddenInput = document.getElementById('game' + groupName.charAt(0).toUpperCase() + groupName.slice(1));
      if (hiddenInput) {
        hiddenInput.value = element.dataset.value;
      }

      // Show/hide invite link section based on visibility selection
      if (groupName === 'visibility') {
        const inviteLinkSection = document.getElementById('inviteLinkSection');
        if (inviteLinkSection) {
          inviteLinkSection.style.display = element.dataset.value === 'invite-only' ? 'block' : 'none';
        }
      }
    }

    function toggleCheckbox(id) {
      const checkbox = document.getElementById(id);
      checkbox.checked = !checkbox.checked;
    }

    function showUpgradeModal() {
      alert('Upgrade to Premium: $9.99/month\n\n‚úì Create up to 5 games\n‚úì Up to 50 cast per game\n‚úì AI scenario generation\n‚úì Autopilot mode\n‚úì Advanced analytics\n\nPayment integration coming soon!');
      // TODO: Implement payment integration
    }

    function copyInviteLink() {
      const inviteLinkInput = document.getElementById('inviteLinkDisplay');
      if (!inviteLinkInput || inviteLinkInput.value.includes('will be generated')) {
        alert('Please create the game first to generate an invite link');
        return;
      }

      inviteLinkInput.select();
      inviteLinkInput.setSelectionRange(0, 99999); // For mobile

      try {
        navigator.clipboard.writeText(inviteLinkInput.value);
        alert('‚úÖ Invite link copied to clipboard!\n\nShare it with players to join your game.');
      } catch (err) {
        // Fallback for older browsers
        document.execCommand('copy');
        alert('‚úÖ Invite link copied!');
      }
    }

    function showView(viewName) {
      // Hide all views
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('settingsView').style.display = 'none';
      document.getElementById('billingView').style.display = 'none';

      // Show selected view
      if (viewName === 'dashboard') {
        document.getElementById('dashboardView').style.display = 'block';
      } else if (viewName === 'settings') {
        document.getElementById('settingsView').style.display = 'block';
        loadSettingsView();
      } else if (viewName === 'billing') {
        document.getElementById('billingView').style.display = 'block';
        loadBillingView();
      }

      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('active');
      }
    }

    async function loadSettingsView() {
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        // Populate settings form
        document.getElementById('settingsDisplayName').value = profile.display_name || '';
        document.getElementById('settingsEmail').value = currentUser.email || '';
        document.getElementById('emailNotifications').checked = profile.email_notifications || false;
        document.getElementById('pushNotifications').checked = profile.push_notifications || false;
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    async function saveSettings() {
      try {
        const displayName = document.getElementById('settingsDisplayName').value;
        const emailNotifications = document.getElementById('emailNotifications').checked;
        const pushNotifications = document.getElementById('pushNotifications').checked;

        const { error } = await supabase
          .from('profiles')
          .update({
            display_name: displayName,
            email_notifications: emailNotifications,
            push_notifications: pushNotifications
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        alert('Settings saved successfully!');
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings: ' + error.message);
      }
    }

    async function loadBillingView() {
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('subscription_tier')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        const tier = profile.subscription_tier || 'free';
        const tierDisplay = tier === 'premium' ? 'Premium Director' : 'Free Tier';
        document.getElementById('currentPlanTier').textContent = tierDisplay;

        // Show features based on tier
        const featuresDiv = document.getElementById('planFeatures');
        if (tier === 'premium') {
          featuresDiv.innerHTML = `
            <ul class="feature-list">
              <li>‚úì Create up to 5 games</li>
              <li>‚úì Up to 50 cast members per game</li>
              <li>‚úì AI scenario generation</li>
              <li>‚úì Autopilot mode</li>
              <li>‚úì Advanced analytics</li>
            </ul>
          `;
          document.getElementById('upgradeButton').style.display = 'none';
        } else {
          featuresDiv.innerHTML = `
            <ul class="feature-list">
              <li>‚úì Join existing games as cast member</li>
              <li>‚úì View leaderboard and episodes</li>
              <li>‚úì Respond to scenarios</li>
            </ul>
          `;
          document.getElementById('upgradeButton').style.display = 'inline-block';
        }
      } catch (error) {
        console.error('Error loading billing:', error);
      }
    }

    // ========================================
    // INITIALIZE APP
    // ========================================
    async function init() {
      const isAuthenticated = await checkAuth();
      if (!isAuthenticated) return;

      await loadGames();

      // Close modals on outside click
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });
    }

    // Start the app - wait for navigation.js to initialize first
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(init, 100); // Small delay to let navigation.js finish
      });
    } else {
      setTimeout(init, 100);
    }
  </script>
  <script src="/js/navigation.js"></script>
</body>
</html>
