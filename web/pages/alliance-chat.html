<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alliance Chat - Mansion Mayhem</title>
  <link rel="icon" type="image/png" href="/assets/logo/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0A0E27;
      --bg-secondary: #151936;
      --bg-card: #1E2139;
      --accent-pink: #E91E63;
      --accent-purple: #9C27B0;
      --accent-gold: #FFC107;
      --text-primary: #FFFFFF;
      --text-secondary: #B8B9C5;
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #00C853;
      --warning: #FF6D00;
      --danger: #D32F2F;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* LEFT SIDEBAR - Alliance List */
    .alliance-sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 2rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-title {
      font-size: 1.75rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--accent-pink);
    }

    .alliance-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .alliance-room {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .alliance-room:hover {
      border-color: var(--accent-pink);
      background: rgba(233, 30, 99, 0.05);
    }

    .alliance-room.active {
      border-color: var(--accent-pink);
      background: rgba(233, 30, 99, 0.1);
    }

    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .room-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .unread-badge {
      background: var(--accent-pink);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
    }

    .room-preview {
      color: var(--text-secondary);
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .room-members {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .member-avatar-small {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }

    /* MAIN CHAT AREA */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
    }

    .chat-header {
      padding: 2rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
    }

    .chat-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.25rem;
    }

    .chat-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .group-badge {
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .chat-members {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .member-tag {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.875rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      font-size: 0.85rem;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      display: flex;
      gap: 1rem;
      max-width: 70%;
    }

    .message.own {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .message-sender {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .message-time {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .message-text {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      padding: 1rem;
      border-radius: 12px;
      line-height: 1.6;
    }

    .message.own .message-text {
      background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(156, 39, 176, 0.15));
      border-color: var(--accent-pink);
    }

    .voice-note {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
    }

    .play-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-pink);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-duration {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .typing-indicator {
      padding: 0.5rem 2rem;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-style: italic;
      min-height: 30px;
    }

    .input-area {
      padding: 1.5rem 2rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 1rem;
    }

    .message-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      height: 60px;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--accent-pink);
    }

    .send-options {
      display: flex;
      gap: 0.75rem;
    }

    .icon-btn {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      border-color: var(--accent-pink);
      background: rgba(233, 30, 99, 0.1);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
      border: none;
      color: white;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 3rem;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
    }

    .empty-title {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .empty-text {
      color: var(--text-secondary);
      max-width: 400px;
    }

    @media (max-width: 768px) {
      .alliance-sidebar {
        width: 100%;
        display: none;
      }

      .alliance-sidebar.mobile-show {
        display: flex;
      }

      .chat-container {
        display: none;
      }

      .chat-container.mobile-show {
        display: flex;
      }

      .message {
        max-width: 85%;
      }
    }
  </style>
  <link rel="stylesheet" href="css/modern-theme.css">
</head>
<body>
  <div class="container">
    <!-- LEFT SIDEBAR -->
    <aside class="alliance-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">üí¨ Alliance Chat</div>
        <a href="/pages/player-dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
      </div>

      <div id="allianceList" class="alliance-list">
        <!-- Alliance rooms will be loaded here -->
      </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main id="chatContainer" class="chat-container">
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">üí¨</div>
        <div class="empty-title">Select an Alliance</div>
        <p class="empty-text">Choose an alliance from the sidebar to start chatting with your team</p>
      </div>

      <div id="activeChat" style="display: none; flex: 1; display: flex; flex-direction: column;">
        <div class="chat-header">
          <div class="chat-title" id="chatTitle">Alliance Name</div>
          <div class="chat-subtitle">
            <span class="group-badge">üîì Group Chat</span>
            <span id="memberCount">0 members</span>
            <span style="color: var(--text-secondary);">‚Ä¢ All members can see and respond</span>
          </div>
          <div class="chat-members" id="chatMembers">
            <!-- Members will be loaded here -->
          </div>
        </div>

        <div id="messagesArea" class="messages-area">
          <!-- Messages will be loaded here -->
        </div>

        <div id="typingIndicator" class="typing-indicator"></div>

        <div class="input-area">
          <textarea id="messageInput" class="message-input" placeholder="Type your message..." rows="2"></textarea>
          <div class="send-options">
            <button class="icon-btn" onclick="recordVoiceNote()" title="Record voice note">
              üé§
            </button>
            <button class="icon-btn send-btn" onclick="sendMessage()">
              ‚û§
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://mllqzeaxqusoryt–µaxzg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweGJocWliaW1la2pobHVtbm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUwODYsImV4cCI6MjA4NjYwMTA4Nn0.0BmbaObOERMZ5r4znb5BQbrGpB5lE5Fq6KnEzxA0YhY'
    )

    let currentUser = null
    let currentCastMember = null
    let currentAlliance = null
    let messageSubscription = null

    async function init() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = '/pages/sign-in.html'
        return
      }
      currentUser = user

      const { data: castMember } = await supabase
        .from('cast_members')
        .select('*')
        .eq('user_id', user.id)
        .single()

      if (!castMember) {
        alert('No cast member profile found')
        return
      }
      currentCastMember = castMember

      loadAlliances()
    }

    async function loadAlliances() {
      const { data: alliances } = await supabase
        .from('mm_alliance_rooms')
        .select('*')
        .contains('member_ids', [currentCastMember.id])
        .eq('status', 'active')
        .order('updated_at', { ascending: false })

      if (!alliances || alliances.length === 0) {
        document.getElementById('allianceList').innerHTML = `
          <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <p>No active alliances</p>
            <a href="/pages/alliances.html" style="color: var(--accent-pink); text-decoration: none; margin-top: 1rem; display: block;">
              View Alliances
            </a>
          </div>
        `
        return
      }

      const html = alliances.map(alliance => `
        <div class="alliance-room ${currentAlliance?.id === alliance.id ? 'active' : ''}" onclick="selectAlliance('${alliance.id}')">
          <div class="room-header">
            <div class="room-name">${alliance.name || 'Secret Alliance'}</div>
          </div>
          <div class="room-preview">Click to open chat...</div>
          <div class="room-members" id="members-${alliance.id}">
            <!-- Members loaded separately -->
          </div>
        </div>
      `).join('')

      document.getElementById('allianceList').innerHTML = html

      // Load members for each alliance
      alliances.forEach(alliance => loadAllianceMembers(alliance))
    }

    async function loadAllianceMembers(alliance) {
      if (!alliance.member_ids || alliance.member_ids.length === 0) return

      const { data: members } = await supabase
        .from('cast_members')
        .select('id, display_name')
        .in('id', alliance.member_ids)
        .limit(5)

      if (!members) return

      const html = members.map(m => `
        <div class="member-avatar-small">${m.display_name.charAt(0)}</div>
      `).join('')

      const container = document.getElementById(`members-${alliance.id}`)
      if (container) {
        container.innerHTML = html + (alliance.member_ids.length > 5 ? `<div class="member-avatar-small">+${alliance.member_ids.length - 5}</div>` : '')
      }
    }

    async function selectAlliance(allianceId) {
      const { data: alliance } = await supabase
        .from('mm_alliance_rooms')
        .select('*')
        .eq('id', allianceId)
        .single()

      if (!alliance) return

      currentAlliance = alliance

      // Update UI
      document.getElementById('emptyState').style.display = 'none'
      document.getElementById('activeChat').style.display = 'flex'
      document.getElementById('chatTitle').textContent = alliance.name || 'Secret Alliance'

      // Load members
      const { data: members } = await supabase
        .from('cast_members')
        .select('id, display_name')
        .in('id', alliance.member_ids || [])

      if (members) {
        const html = members.map(m => `
          <div class="member-tag">
            <div class="member-avatar-small">${m.display_name.charAt(0)}</div>
            ${m.display_name}
          </div>
        `).join('')
        document.getElementById('chatMembers').innerHTML = html
        document.getElementById('memberCount').textContent = `${members.length} member${members.length !== 1 ? 's' : ''}`
      }

      // Load messages
      loadMessages()

      // Subscribe to new messages
      subscribeToMessages()

      // Update sidebar selection
      loadAlliances()
    }

    async function loadMessages() {
      if (!currentAlliance) return

      const { data: messages } = await supabase
        .from('mm_alliance_messages')
        .select('*, cast_members(display_name)')
        .eq('room_id', currentAlliance.id)
        .order('created_at', { ascending: true })
        .limit(100)

      // System message at top
      let html = `
        <div style="text-align: center; padding: 1.5rem; margin-bottom: 2rem; background: rgba(233, 30, 99, 0.05); border: 1px dashed var(--accent-pink); border-radius: 12px;">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üí¨ Alliance Group Chat</div>
          <div style="color: var(--text-secondary); font-size: 0.9rem;">
            This is a private group chat. All ${currentAlliance.member_ids?.length || 0} alliance members can see and respond to messages in real-time.
          </div>
        </div>
      `

      if (!messages || messages.length === 0) {
        document.getElementById('messagesArea').innerHTML = html + `
          <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
            No messages yet. Be the first to start the conversation!
          </div>
        `
        return
      }

      html += messages.map(msg => {
        const isOwn = msg.sender_cast_id === currentCastMember.id
        const time = new Date(msg.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
        const initial = msg.cast_members?.display_name?.charAt(0) || '?'

        if (msg.message_type === 'voice') {
          return `
            <div class="message ${isOwn ? 'own' : ''}">
              <div class="message-avatar">${initial}</div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-sender">${msg.cast_members?.display_name || 'Unknown'}</span>
                  <span class="message-time">${time}</span>
                </div>
                <div class="voice-note">
                  <button class="play-btn">‚ñ∂</button>
                  <span class="voice-duration">${msg.voice_note_duration_seconds || 0}s</span>
                </div>
              </div>
            </div>
          `
        }

        return `
          <div class="message ${isOwn ? 'own' : ''}">
            <div class="message-avatar">${initial}</div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-sender">${msg.cast_members?.display_name || 'Unknown'}</span>
                <span class="message-time">${time}</span>
              </div>
              <div class="message-text">${msg.message_text || ''}</div>
            </div>
          </div>
        `
      }).join('')

      document.getElementById('messagesArea').innerHTML = html

      // Scroll to bottom
      const messagesArea = document.getElementById('messagesArea')
      messagesArea.scrollTop = messagesArea.scrollHeight
    }

    function subscribeToMessages() {
      // Unsubscribe from previous
      if (messageSubscription) {
        messageSubscription.unsubscribe()
      }

      // Subscribe to new messages
      messageSubscription = supabase
        .channel(`alliance-${currentAlliance.id}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'mm_alliance_messages',
          filter: `room_id=eq.${currentAlliance.id}`
        }, () => {
          loadMessages()
        })
        .subscribe()
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput')
      const text = input.value.trim()

      if (!text || !currentAlliance) return

      const { error } = await supabase
        .from('mm_alliance_messages')
        .insert({
          room_id: currentAlliance.id,
          sender_cast_id: currentCastMember.id,
          message_text: text,
          message_type: 'text'
        })

      if (error) {
        console.error('Error sending message:', error)
        alert('Failed to send message')
        return
      }

      input.value = ''
      loadMessages()
    }

    function recordVoiceNote() {
      alert('Voice recording coming soon! Use the record-voice.html page for now.')
    }

    // Send message on Enter (Shift+Enter for new line)
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('messageInput')
      if (input) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault()
            sendMessage()
          }
        })
      }
    })

    init()
  </script>
</body>
</html>
