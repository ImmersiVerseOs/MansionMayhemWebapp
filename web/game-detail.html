<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Details | MANSION MAYHEM</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/navigation.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0a0a0a;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --bg-sidebar: #0d0d0d;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-dim: #888888;
      --text-muted: #555555;
      --gold: #d4af37;
      --gold-light: #f4e4bc;
      --rose: #e91e63;
      --rose-dark: #ad1457;
      --purple: #9c27b0;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .app-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-header {
      padding: 0 20px 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .sidebar-logo {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .sidebar-logo span {
      display: block;
      font-size: 10px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      letter-spacing: 3px;
      background: linear-gradient(135deg, var(--rose), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 4px;
    }
    .back-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }
    .back-link:hover {
      background: var(--bg-elevated);
      color: var(--text);
    }
    .nav-section { margin-bottom: 24px; }
    .nav-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 20px;
      margin-bottom: 8px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .nav-item:hover {
      background: var(--bg-elevated);
      color: var(--text);
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
      color: var(--gold);
      border-left: 3px solid var(--gold);
    }
    .nav-icon { font-size: 18px; }
    .main-content {
      padding: 32px;
      overflow-y: auto;
      max-height: 100vh;
    }
    .page-header {
      margin-bottom: 32px;
    }
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }
    .breadcrumb a {
      color: var(--text-dim);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      color: var(--gold);
    }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
    }
    .game-title-section {
      flex: 1;
    }
    .game-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--gold);
      font-weight: 600;
      margin-bottom: 8px;
    }
    .game-title {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .game-subtitle {
      color: var(--text-dim);
      font-size: 14px;
    }
    .game-status-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .game-status-badge.lobby { background: var(--warning); color: white; }
    .game-status-badge.active { background: var(--success); color: white; }
    .game-status-badge.paused { background: var(--purple); color: white; }
    .game-status-badge.completed { background: var(--text-dim); color: white; }
    .game-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--bg);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
    }
    .btn-secondary {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover { border-color: var(--gold); }
    .btn-success {
      background: var(--success);
      color: white;
    }
    .btn-success:hover { background: #388e3c; }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover { background: #d32f2f; }
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    .btn-warning:hover { background: #f57c00; }
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 32px;
    }
    .tab {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dim);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .tab:hover {
      color: var(--text);
      background: rgba(212, 175, 55, 0.05);
    }
    .tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.rose { color: var(--rose); }
    .stat-value.success { color: var(--success); }
    .stat-value.purple { color: var(--purple); }
    .stat-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .card-header {
      background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-body { padding: 24px; }
    .cast-list {
      display: grid;
      gap: 12px;
    }
    .cast-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .cast-item.joined {
      border-color: var(--success);
      background: rgba(76, 175, 80, 0.05);
    }
    .cast-item.eliminated {
      opacity: 0.5;
    }
    .cast-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--rose), var(--purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      border: 2px solid var(--gold);
    }
    .cast-info {
      flex: 1;
    }
    .cast-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .cast-meta {
      font-size: 13px;
      color: var(--text-dim);
    }
    .cast-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .cast-status.joined { background: var(--success); color: white; }
    .cast-status.invited { background: var(--warning); color: white; }
    .cast-status.active { background: var(--gold); color: var(--bg); }
    .cast-status.eliminated { background: var(--danger); color: white; }
    .timeline {
      position: relative;
      padding-left: 40px;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }
    .timeline-item {
      position: relative;
      padding: 20px 0;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -34px;
      top: 24px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gold);
      border: 2px solid var(--bg-card);
    }
    .timeline-time {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .timeline-desc {
      font-size: 13px;
      color: var(--text-dim);
    }
    .form-group { margin-bottom: 20px; }
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    .form-select, .form-input {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }
    .form-select:focus, .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
    }
    .form-textarea {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .scenario-list {
      display: grid;
      gap: 16px;
    }
    .scenario-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    .scenario-type {
      font-size: 24px;
    }
    .scenario-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .scenario-status.active { background: var(--success); color: white; }
    .scenario-status.closed { background: var(--text-dim); color: white; }
    .scenario-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .scenario-meta {
      display: flex;
      gap: 20px;
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }
    .response-list {
      display: grid;
      gap: 12px;
    }
    .response-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    .response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .response-cast {
      font-weight: 600;
      font-size: 14px;
    }
    .response-time {
      font-size: 12px;
      color: var(--text-dim);
    }
    .response-text {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 12px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .alert {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert-success {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }
    .alert-error {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- MANSION MAYHEM - Persistent Navigation Bar -->
  <!-- Navigation (loaded from include) -->
  <div id="globalNavPlaceholder"></div>
  <script>
    fetch('/includes/global-nav.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('globalNavPlaceholder').innerHTML = data;
      });
  </script>
  <!-- Navigation loaded - displays role-based links, notifications, and user menu -->

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          MANSION MAYHEM
          <span>Game Management</span>
        </div>
      </div>

      <a href="game-start.html" class="back-link">
        <span>‚Üê</span> Back to Games
      </a>

      <nav>
        <div class="nav-section">
          <div class="nav-label">Navigation</div>
          <div class="nav-item active" data-tab="overview">
            <span class="nav-icon">üìä</span>
            Overview
          </div>
          <div class="nav-item" data-tab="cast">
            <span class="nav-icon">üë•</span>
            Cast Members
          </div>
          <div class="nav-item" data-tab="scenarios">
            <span class="nav-icon">üé≠</span>
            Scenarios
          </div>
          <div class="nav-item" data-tab="responses">
            <span class="nav-icon">üí¨</span>
            Responses
          </div>
          <div class="nav-item" data-tab="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
          </div>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Loading State -->
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 16px;">Loading game details...</p>
      </div>

      <!-- Content -->
      <div id="gameContent" class="hidden">
        <!-- Header -->
        <div class="page-header">
          <div class="breadcrumb">
            <a href="game-start.html">Games</a>
            <span>‚Ä∫</span>
            <span id="breadcrumbCode">MM-BETA-001</span>
          </div>

          <div class="game-header">
            <div class="game-title-section">
              <div class="game-code" id="headerGameCode">MM-BETA-001</div>
              <h1 class="game-title" id="headerGameTitle">Loading...</h1>
              <p class="game-subtitle" id="headerGameSubtitle">Loading...</p>
            </div>
            <div>
              <div class="game-status-badge" id="headerGameStatus">LOBBY</div>
              <div class="game-actions" id="headerGameActions">
                <!-- Actions populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Tabs -->
        <div class="tabs">
          <div class="tab active" data-tab="overview">Overview</div>
          <div class="tab" data-tab="cast">Cast Members</div>
          <div class="tab" data-tab="scenarios">Scenarios</div>
          <div class="tab" data-tab="responses">Responses</div>
          <div class="tab" data-tab="settings">Settings</div>
        </div>

        <!-- Tab: Overview -->
        <div class="tab-content active" id="tab-overview">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value gold" id="stat-cast">0</div>
              <div class="stat-label">Cast Joined</div>
            </div>
            <div class="stat-card">
              <div class="stat-value rose" id="stat-scenarios">0</div>
              <div class="stat-label">Scenarios</div>
            </div>
            <div class="stat-card">
              <div class="stat-value success" id="stat-responses">0</div>
              <div class="stat-label">Responses</div>
            </div>
            <div class="stat-card">
              <div class="stat-value purple" id="stat-voice">0</div>
              <div class="stat-label">Voice Notes</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">üìÖ Timeline</div>
            </div>
            <div class="card-body">
              <div class="timeline" id="timeline">
                <!-- Timeline populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Cast Members -->
        <div class="tab-content" id="tab-cast">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üë• Cast Members</div>
              <button class="btn btn-secondary" onclick="addCastMember()">
                + Add Cast
              </button>
            </div>
            <div class="card-body">
              <div class="cast-list" id="castList">
                <div class="loading">Loading cast...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Scenarios -->
        <div class="tab-content" id="tab-scenarios">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üé≠ Scenarios</div>
              <button class="btn btn-primary" onclick="createScenario()">
                + Create Scenario
              </button>
            </div>
            <div class="card-body">
              <div class="scenario-list" id="scenarioList">
                <div class="loading">Loading scenarios...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Responses -->
        <div class="tab-content" id="tab-responses">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üí¨ All Responses</div>
            </div>
            <div class="card-body">
              <div class="response-list" id="responseList">
                <div class="loading">Loading responses...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Settings -->
        <div class="tab-content" id="tab-settings">
          <div class="card">
            <div class="card-header">
              <div class="card-title">‚öôÔ∏è Game Settings</div>
            </div>
            <div class="card-body">
              <form id="settingsForm">
                <div class="form-group">
                  <label class="form-label">Game Title</label>
                  <input type="text" id="settings-title" class="form-input" required>
                </div>

                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea id="settings-description" class="form-textarea"></textarea>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Max Cast Members</label>
                    <input type="number" id="settings-max-cast" class="form-input" min="2" max="20">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Episode Length (Days)</label>
                    <input type="number" id="settings-episode-length" class="form-input" min="1" max="30">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Season Number</label>
                    <input type="number" id="settings-season" class="form-input" min="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Episode Number</label>
                    <input type="number" id="settings-episode" class="form-input" min="1">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Admin Notes</label>
                  <textarea id="settings-notes" class="form-textarea" placeholder="Internal notes for directors..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                  üíæ Save Settings
                </button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">‚ö†Ô∏è Danger Zone</div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-dim); margin-bottom: 16px;">
                Permanent actions that cannot be undone.
              </p>
              <button class="btn btn-danger" onclick="deleteGame()">
                üóëÔ∏è Delete Game
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://mllqzeaxqusoryt–µaxzg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweGJocWliaW1la2pobHVtbm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjUwODYsImV4cCI6MjA4NjYwMTA4Nn0.0BmbaObOERMZ5r4znb5BQbrGpB5lE5Fq6KnEzxA0YhY';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentGame = null;
    let currentGameId = null;
    let castMembers = [];
    let scenarios = [];

    // Initialize
    async function init() {
      await checkAuth();

      // Get game ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentGameId = urlParams.get('game');

      if (!currentGameId) {
        alert('No game specified');
        window.location.href = 'game-start.html';
        return;
      }

      await loadGame();
      setupTabs();
      setupRealtimeSubscription();
    }

    // Check authentication
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login.html';
        return;
      }

      // Check if user is admin
      const { data: admin } = await supabase
        .from('admin_users')
        .select('*')
        .eq('user_id', session.user.id)
        .single();

      if (!admin) {
        alert('Access denied. Admin privileges required.');
        window.location.href = '/';
      }
    }

    // Load game details
    async function loadGame() {
      try {
        const { data: game, error } = await supabase
          .from('mm_games')
          .select('*')
          .eq('id', currentGameId)
          .single();

        if (error || !game) {
          alert('Game not found');
          window.location.href = 'game-start.html';
          return;
        }

        currentGame = game;
        renderGameHeader(game);
        await loadAllData();

        // Show content, hide loading
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('gameContent').classList.remove('hidden');

      } catch (error) {
        console.error('Error loading game:', error);
        alert('Failed to load game');
      }
    }

    // Render game header
    function renderGameHeader(game) {
      document.getElementById('breadcrumbCode').textContent = game.game_code;
      document.getElementById('headerGameCode').textContent = game.game_code;
      document.getElementById('headerGameTitle').textContent = game.title;
      document.getElementById('headerGameSubtitle').textContent = game.description || 'No description';

      const statusBadge = document.getElementById('headerGameStatus');
      statusBadge.textContent = game.status.toUpperCase();
      statusBadge.className = `game-status-badge ${game.status}`;

      // Render actions based on status
      const actionsContainer = document.getElementById('headerGameActions');
      let actions = '';

      if (game.status === 'lobby') {
        actions = `
          <button class="btn btn-success" onclick="launchGame()">
            <span>üöÄ</span> Launch Game
          </button>
          <button class="btn btn-danger" onclick="cancelGame()">
            <span>‚ùå</span> Cancel
          </button>
        `;
      } else if (game.status === 'active') {
        actions = `
          <button class="btn btn-warning" onclick="pauseGame()">
            <span>‚è∏Ô∏è</span> Pause
          </button>
          <button class="btn btn-danger" onclick="endGame()">
            <span>üèÅ</span> End Game
          </button>
        `;
      } else if (game.status === 'paused') {
        actions = `
          <button class="btn btn-success" onclick="resumeGame()">
            <span>‚ñ∂Ô∏è</span> Resume
          </button>
          <button class="btn btn-danger" onclick="endGame()">
            <span>üèÅ</span> End Game
          </button>
        `;
      }

      actionsContainer.innerHTML = actions;
    }

    // Load all data
    async function loadAllData() {
      await Promise.all([
        loadCastMembers(),
        loadScenarios(),
        loadResponses(),
        loadTimeline(),
        loadStats()
      ]);
      populateSettingsForm();
    }

    // Load cast members
    async function loadCastMembers() {
      const { data, error } = await supabase
        .from('mm_game_cast')
        .select('*, cast_members(*)')
        .eq('game_id', currentGameId)
        .order('joined_at', { ascending: false, nullsFirst: false });

      if (error) {
        console.error('Error loading cast:', error);
        return;
      }

      castMembers = data || [];
      renderCastList(data);
    }

    // Render cast list
    function renderCastList(members) {
      const container = document.getElementById('castList');
      if (!members || members.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><p>No cast members yet</p></div>';
        return;
      }

      container.innerHTML = members.map(member => {
        const castMember = member.cast_members;
        const name = castMember.full_name || castMember.display_name;
        const initials = getInitials(name);
        const statusClass = member.status;
        const statusText = member.status.charAt(0).toUpperCase() + member.status.slice(1);

        return `
          <div class="cast-item ${statusClass === 'joined' || statusClass === 'active' ? 'joined' : ''} ${statusClass === 'eliminated' ? 'eliminated' : ''}">
            <div class="cast-avatar">${initials}</div>
            <div class="cast-info">
              <div class="cast-name">${name}</div>
              <div class="cast-meta">
                ${castMember.archetype || 'Cast Member'} ‚Ä¢
                ${member.scenarios_received || 0} scenarios ‚Ä¢
                ${member.responses_submitted || 0} responses
              </div>
            </div>
            <div class="cast-status ${statusClass}">${statusText}</div>
          </div>
        `;
      }).join('');
    }

    // Load scenarios
    async function loadScenarios() {
      const { data, error } = await supabase
        .from('scenarios')
        .select(`
          *,
          scenario_targets(count),
          scenario_responses(count)
        `)
        .eq('game_id', currentGameId)
        .order('launched_at', { ascending: false });

      if (error) {
        console.error('Error loading scenarios:', error);
        return;
      }

      scenarios = data || [];
      renderScenarioList(data);
    }

    // Render scenario list
    function renderScenarioList(scenarios) {
      const container = document.getElementById('scenarioList');
      if (!scenarios || scenarios.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üé≠</div><p>No scenarios created yet</p></div>';
        return;
      }

      const iconMap = {
        confrontation: 'üî•',
        power: 'üëë',
        betrayal: 'üó°Ô∏è',
        revelation: 'üé≠',
        alliance: 'ü§ù',
        elimination: 'üó≥Ô∏è'
      };

      container.innerHTML = scenarios.map(scenario => {
        const icon = iconMap[scenario.scenario_type] || '‚ú®';
        const targetCount = scenario.scenario_targets?.[0]?.count || 0;
        const responseCount = scenario.scenario_responses?.[0]?.count || 0;

        return `
          <div class="scenario-card">
            <div class="scenario-header">
              <div class="scenario-type">${icon}</div>
              <div class="scenario-status ${scenario.status}">${scenario.status}</div>
            </div>
            <div class="scenario-title">${scenario.title || scenario.prompt_text.slice(0, 80)}...</div>
            <div class="scenario-meta">
              <span>üéØ ${targetCount} targets</span>
              <span>üí¨ ${responseCount} responses</span>
              <span>‚è∞ ${scenario.deadline_hours}h deadline</span>
              <span>üìÖ ${formatDate(scenario.launched_at)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load responses
    async function loadResponses() {
      const { data, error } = await supabase
        .from('scenario_responses')
        .select(`
          *,
          cast_members(full_name, display_name),
          scenarios(title, prompt_text, scenario_type)
        `)
        .in('scenario_id', scenarios.map(s => s.id))
        .eq('status', 'submitted')
        .order('submitted_at', { ascending: false });

      if (error) {
        console.error('Error loading responses:', error);
        return;
      }

      renderResponseList(data);
    }

    // Render response list
    function renderResponseList(responses) {
      const container = document.getElementById('responseList');
      if (!responses || responses.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><p>No responses yet</p></div>';
        return;
      }

      container.innerHTML = responses.map(response => {
        const castName = response.cast_members.full_name || response.cast_members.display_name;
        const scenarioTitle = response.scenarios.title || response.scenarios.prompt_text.slice(0, 50);

        return `
          <div class="response-item">
            <div class="response-header">
              <div class="response-cast">${castName}</div>
              <div class="response-time">${formatDate(response.submitted_at)}</div>
            </div>
            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">
              Re: ${scenarioTitle}
            </div>
            <div class="response-text">${response.custom_response || 'Selected option'}</div>
            ${response.voice_note_url ? '<div style="color: var(--gold); font-size: 12px;">üé§ Voice note attached</div>' : ''}
          </div>
        `;
      }).join('');
    }

    // Load timeline
    async function loadTimeline() {
      const timeline = document.getElementById('timeline');
      const events = [];

      // Game created
      events.push({
        time: currentGame.created_at,
        title: 'Game Created',
        desc: `${currentGame.game_code} created`
      });

      // Lobby opened
      if (currentGame.lobby_opened_at) {
        events.push({
          time: currentGame.lobby_opened_at,
          title: 'Invitations Sent',
          desc: `${currentGame.max_cast_members} cast members invited`
        });
      }

      // Game started
      if (currentGame.started_at) {
        events.push({
          time: currentGame.started_at,
          title: 'Game Started',
          desc: `${currentGame.cast_joined_count} cast members joined`
        });
      }

      // Scenarios launched
      scenarios.forEach(scenario => {
        events.push({
          time: scenario.launched_at,
          title: 'Scenario Launched',
          desc: scenario.title || scenario.prompt_text.slice(0, 50)
        });
      });

      // Sort by time
      events.sort((a, b) => new Date(b.time) - new Date(a.time));

      timeline.innerHTML = events.map(event => `
        <div class="timeline-item">
          <div class="timeline-time">${formatDate(event.time)}</div>
          <div class="timeline-title">${event.title}</div>
          <div class="timeline-desc">${event.desc}</div>
        </div>
      `).join('');
    }

    // Load stats
    function loadStats() {
      document.getElementById('stat-cast').textContent = currentGame.cast_joined_count || 0;
      document.getElementById('stat-scenarios').textContent = currentGame.scenarios_launched_count || 0;
      document.getElementById('stat-responses').textContent = currentGame.total_responses_count || 0;
      document.getElementById('stat-voice').textContent = currentGame.total_voice_notes_count || 0;
    }

    // Populate settings form
    function populateSettingsForm() {
      document.getElementById('settings-title').value = currentGame.title || '';
      document.getElementById('settings-description').value = currentGame.description || '';
      document.getElementById('settings-max-cast').value = currentGame.max_cast_members || 8;
      document.getElementById('settings-episode-length').value = currentGame.episode_length_days || 7;
      document.getElementById('settings-season').value = currentGame.season_number || '';
      document.getElementById('settings-episode').value = currentGame.episode_number || '';
      document.getElementById('settings-notes').value = currentGame.admin_notes || '';

      document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    }

    // Save settings
    async function saveSettings(e) {
      e.preventDefault();

      const updates = {
        title: document.getElementById('settings-title').value,
        description: document.getElementById('settings-description').value,
        max_cast_members: parseInt(document.getElementById('settings-max-cast').value),
        episode_length_days: parseInt(document.getElementById('settings-episode-length').value),
        season_number: parseInt(document.getElementById('settings-season').value) || null,
        episode_number: parseInt(document.getElementById('settings-episode').value) || null,
        admin_notes: document.getElementById('settings-notes').value
      };

      const { error } = await supabase
        .from('mm_games')
        .update(updates)
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to save settings');
        return;
      }

      showAlert('success', 'Settings saved successfully');
      await loadGame();
    }

    // Game actions
    async function launchGame() {
      if (!confirm('Launch this game? Cast members will be notified and the game will start.')) {
        return;
      }

      const { error } = await supabase
        .from('mm_games')
        .update({
          status: 'active',
          started_at: new Date().toISOString()
        })
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to launch game');
        return;
      }

      showAlert('success', 'Game launched successfully!');
      await loadGame();
    }

    async function pauseGame() {
      if (!confirm('Pause this game?')) return;

      const { error } = await supabase
        .from('mm_games')
        .update({
          status: 'paused',
          paused_at: new Date().toISOString()
        })
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to pause game');
        return;
      }

      showAlert('success', 'Game paused');
      await loadGame();
    }

    async function resumeGame() {
      if (!confirm('Resume this game?')) return;

      const { error } = await supabase
        .from('mm_games')
        .update({ status: 'active' })
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to resume game');
        return;
      }

      showAlert('success', 'Game resumed');
      await loadGame();
    }

    async function endGame() {
      if (!confirm('End this game? It will be marked as completed.')) return;

      const { error } = await supabase
        .from('mm_games')
        .update({
          status: 'completed',
          completed_at: new Date().toISOString()
        })
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to end game');
        return;
      }

      showAlert('success', 'Game ended');
      await loadGame();
    }

    async function cancelGame() {
      if (!confirm('Delete this game? This cannot be undone.')) return;

      await deleteGame();
    }

    async function deleteGame() {
      if (!confirm('Are you absolutely sure? This will permanently delete the game and all associated data.')) {
        return;
      }

      const { error } = await supabase
        .from('mm_games')
        .delete()
        .eq('id', currentGameId);

      if (error) {
        showAlert('error', 'Failed to delete game');
        return;
      }

      alert('Game deleted successfully');
      window.location.href = 'game-start.html';
    }

    function addCastMember() {
      alert('Navigate to game-start.html to add more cast members');
    }

    function createScenario() {
      window.location.href = `director-console.html?game=${currentGameId}`;
    }

    // Setup tabs
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab, .nav-item[data-tab]');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab, .nav-item[data-tab]').forEach(t => {
        if (t.dataset.tab === tabName) {
          t.classList.add('active');
        } else {
          t.classList.remove('active');
        }
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Setup realtime subscription
    function setupRealtimeSubscription() {
      supabase
        .channel(`game:${currentGameId}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'mm_games',
          filter: `id=eq.${currentGameId}`
        }, () => {
          loadGame();
        })
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'mm_game_cast',
          filter: `game_id=eq.${currentGameId}`
        }, () => {
          loadCastMembers();
        })
        .subscribe();
    }

    // Helper functions
    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);

      setTimeout(() => alert.remove(), 5000);
    }

    function getInitials(name) {
      if (!name) return '??';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
  <script type="module" src="js/invite-gate.js"></script>
  <script src="/js/navigation.js"></script>
</body>
</html>
