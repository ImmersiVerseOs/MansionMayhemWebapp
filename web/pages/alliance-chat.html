<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alliance Chat â€” Mansion Mayhem</title>
  <link rel="stylesheet" href="/css/candy.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .chat-shell{margin-left:var(--sidebar-w);height:100vh;display:flex;flex-direction:column}
    .chat-top{padding:0.75rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.75rem;background:rgba(12,4,24,0.6);backdrop-filter:blur(12px)}
    .chat-top-name{font-family:var(--font-display);font-weight:700;font-size:1rem;flex:1}
    .chat-members{display:flex;gap:-6px}
    .chat-members .av{margin-left:-8px;border:2px solid var(--bg)}.chat-members .av:first-child{margin-left:0}
    .whisper-bar{text-align:center;padding:0.35rem;font-size:0.65rem;color:var(--cyan);background:var(--cyan-s);font-weight:600;letter-spacing:0.04em}
    .chat-feed{flex:1;overflow-y:auto;padding:1rem 1.5rem;display:flex;flex-direction:column;gap:0.5rem;max-width:700px}
    .chat-empty{text-align:center;color:var(--text3);padding:4rem;font-size:0.9rem}
    .chat-input-row{padding:0.75rem 1.5rem;display:flex;gap:0.5rem;border-top:1px solid var(--border);background:rgba(12,4,24,0.8);max-width:700px}
  </style>
</head>
<body>
  <div class="page">
    <div class="orb3"></div>
    <div class="chat-shell">
      <div class="chat-top">
        <button onclick="goBack()" style="background:none;border:none;color:var(--text2);font-size:1.4rem;cursor:pointer">â†</button>
        <span class="ice-text" style="font-size:1.2rem">ğŸ¤«</span>
        <div class="chat-top-name" id="allianceName">Secret Chat</div>
        <span class="pill pill-cyan"><span class="live-dot"></span> Live</span>
        <div class="chat-members" id="memberAvatars"></div>
      </div>
      <div class="whisper-bar">ğŸ”’ Only alliance members can see these messages</div>
      <div class="chat-feed" id="chatFeed"><div class="chat-empty">Loading...</div></div>
      <div class="chat-input-row">
        <input class="input input-lg" id="msgInput" placeholder="Whisper to your alliance..." style="flex:1">
        <button class="btn btn-cyan" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
  <script type="module">
    import{waitForSupabase,requireAuth}from'/js/supabase.js';
    import{initSidebar}from'/js/sidebar.js';
    import*as userMod from'/js/supabase.js';
    let sb,user,gameId,allianceId,castId,alliance=null,members=[];
    const AI={wildcard:'ğŸƒ',strategist:'ğŸ§ ',sweetheart:'ğŸ’–',villain:'ğŸ˜ˆ',comedian:'ğŸ˜‚',troublemaker:'ğŸ’£',diva:'ğŸ‘‘',hothead:'ğŸ”¥'};
    async function init(){
      sb=await waitForSupabase();user=await requireAuth();if(!user)return;
      await initSidebar('alliances',userMod);
      const p=new URLSearchParams(location.search);gameId=p.get('game');allianceId=p.get('alliance');
      if(!gameId||!allianceId){location.href='/pages/lobby.html';return}
      const{data:cm}=await sb.from('cast_members').select('id').eq('user_id',user.id).maybeSingle();castId=cm?.id;
      const{data:a}=await sb.from('mm_alliance_rooms').select('*').eq('id',allianceId).single();
      if(!a||!a.member_ids?.includes(castId)){location.href=`/pages/alliance-room.html?game=${gameId}`;return}
      alliance=a;
      const{data:cms}=await sb.from('cast_members').select('id,display_name,archetype').in('id',a.member_ids);members=cms||[];
      document.getElementById('allianceName').textContent=alliance.room_name||'Alliance';
      document.getElementById('memberAvatars').innerHTML=members.map(m=>`<div class="av av-sm av-cyan">${AI[m.archetype]||'ğŸ­'}</div>`).join('');
      await loadMessages();subscribe();
    }
    async function loadMessages(){const{data}=await sb.from('mm_alliance_messages').select('*').eq('alliance_room_id',allianceId).order('created_at',{ascending:true}).limit(200);renderMessages(data||[])}
    function renderMessages(msgs){const feed=document.getElementById('chatFeed');if(!msgs.length){feed.innerHTML='<div class="chat-empty">ğŸ¤« No messages yet. Start strategizing.</div>';return}feed.innerHTML=msgs.map(m=>{const sender=members.find(x=>x.id===m.cast_member_id);const mine=m.cast_member_id===castId;const time=new Date(m.created_at).toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});return`<div class="bubble ${mine?'mine':''}">${!mine?`<div class="bubble-name" style="color:var(--cyan)">${sender?.display_name||'?'}</div>`:''}${m.content}<div class="bubble-time">${time}</div></div>`}).join('');feed.scrollTop=feed.scrollHeight}
    function subscribe(){sb.channel('ac-'+allianceId).on('postgres_changes',{event:'INSERT',schema:'public',table:'mm_alliance_messages',filter:`alliance_room_id=eq.${allianceId}`},async()=>{await loadMessages()}).subscribe()}
    window.sendMsg=async()=>{const input=document.getElementById('msgInput');const text=input.value.trim();if(!text)return;input.value='';await sb.from('mm_alliance_messages').insert({alliance_room_id:allianceId,cast_member_id:castId,content:text,message_type:'text'})};
    document.getElementById('msgInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendMsg()});
    window.goBack=()=>{location.href=`/pages/alliance-room.html?game=${gameId}`};
    init();
  </script>
</body>
</html>
