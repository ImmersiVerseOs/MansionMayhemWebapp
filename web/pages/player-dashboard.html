<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Mansion Mayhem</title>
  <link rel="icon" type="image/png" href="/assets/logo/favicon.png">
  <link rel="icon" type="image/x-icon" href="/assets/logo/favicon.ico">

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --color-dark: #0a0a0a;
      --color-gold: #D4AF37;
      --color-rose: #C04E63;
      --color-purple: #8B5CF6;
      --color-cyan: #06B6D4;
      --color-success: #10B981;
      --gradient-gold: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--color-dark);
      color: white;
      min-height: 100vh;
    }
    
    .animated-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(192, 78, 99, 0.1) 0%, transparent 40%);
      animation: bgShift 20s ease-in-out infinite;
    }
    
    @keyframes bgShift {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .admin-card {
      text-decoration: none;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .admin-card:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-2px);
    }

    #directorConsoleBtn {
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    #directorConsoleBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }
    
    .main-container {
      padding: 6rem 2rem 4rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .page-header {
      margin-bottom: 3rem;
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .welcome-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .welcome-text h1 {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      background: var(--gradient-gold);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .welcome-text p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.125rem;
    }
    
    .quick-actions {
      display: flex;
      gap: 1rem;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--gradient-gold);
      color: var(--color-dark);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(212, 175, 55, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--color-gold);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s;
      animation: fadeInUp 0.8s ease-out;
    }
    
    .stat-card:hover {
      border-color: var(--color-gold);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
    }
    
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .stat-icon {
      font-size: 2rem;
    }
    
    .stat-trend {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .trend-up {
      background: rgba(16, 185, 129, 0.2);
      color: var(--color-success);
    }
    
    .trend-down {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 900;
      background: var(--gradient-gold);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .section-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 2rem;
      animation: fadeInUp 1s ease-out;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-gold);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-link {
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.3s;
    }
    
    .section-link:hover {
      color: var(--color-gold);
    }
    
    .scenario-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .scenario-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .scenario-item:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: var(--color-gold);
    }
    
    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
    }
    
    .scenario-title {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      font-size: 1rem;
    }
    
    .scenario-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-urgent {
      background: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }
    
    .badge-pending {
      background: rgba(251, 191, 36, 0.2);
      color: #F59E0B;
    }
    
    .scenario-meta {
      display: flex;
      gap: 1.5rem;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .earnings-summary {
      background: var(--gradient-gold);
      border-radius: 16px;
      padding: 2rem;
      color: var(--color-dark);
      margin-bottom: 1.5rem;
    }
    
    .earnings-value {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
    }
    
    .earnings-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }
    
    .earnings-breakdown {
      display: grid;
      gap: 0.75rem;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      font-size: 0.875rem;
    }
    
    .breakdown-value {
      font-weight: 700;
    }
    
    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .activity-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      transition: all 0.3s;
    }
    
    .activity-item:hover {
      background: rgba(255, 255, 255, 0.04);
    }
    
    .activity-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    
    .activity-time {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.75rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .welcome-section {
        flex-direction: column;
        align-items: start;
        gap: 1rem;
      }
      
      .quick-actions {
        width: 100%;
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .welcome-text h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="animated-bg"></div>

  <!-- Include global nav -->
  <div id="globalNavContainer"></div>
  
  <div class="main-container">
    <div class="page-header">
      <div class="welcome-section">
        <div class="welcome-text">
          <h1 id="welcomeMessage">Loading...</h1>
          <p id="scenarioCount">Checking for active scenarios...</p>
        </div>
        <div class="quick-actions">
          <button id="respondNowBtn" class="btn btn-primary" onclick="handleRespondNow()" style="text-decoration:none;">
            <span>‚ö°</span>
            <span>Respond Now</span>
          </button>
          <a href="how-to-play.html" class="btn btn-secondary">
            <span>üìö</span>
            <span>How to Play</span>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üí∞</span>
        </div>
        <div class="stat-value" id="totalEarnings">$0.00</div>
        <div class="stat-label">Total Earnings</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üé¨</span>
        </div>
        <div class="stat-value" id="totalEpisodes">0</div>
        <div class="stat-label">Episodes Featured</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">‚è±Ô∏è</span>
        </div>
        <div class="stat-value" id="totalScreenTime">0m</div>
        <div class="stat-label">Total Screen Time</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üé§</span>
        </div>
        <div class="stat-value" id="voiceNotesPosted">0</div>
        <div class="stat-label">Voice Notes Posted</div>
      </div>
    </div>

    <!-- Admin Panel (only visible to admins) -->
    <div id="adminPanel" style="display: block; margin-bottom: 2rem;">
      <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 20px; padding: 2rem; box-shadow: 0 10px 40px rgba(139, 92, 246, 0.2);">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
            üëë
          </div>
          <div>
            <h2 style="font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.25rem;">
              Admin Control Panel
            </h2>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">
              Manage content, moderate voice notes, and view analytics
            </p>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <a href="admin-dashboard.html" class="admin-card">
            <div style="width: 40px; height: 40px; background: rgba(139, 92, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
              üìä
            </div>
            <div>
              <div style="font-weight: 700; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.25rem;">Dashboard</div>
              <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6);">Platform overview</div>
            </div>
          </a>

          <a href="admin-moderation.html" class="admin-card">
            <div style="width: 40px; height: 40px; background: rgba(236, 72, 153, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
              üõ°Ô∏è
            </div>
            <div>
              <div style="font-weight: 700; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.25rem;">Moderation</div>
              <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6);">Approve voice notes</div>
            </div>
          </a>

          <a href="admin-analytics.html" class="admin-card">
            <div style="width: 40px; height: 40px; background: rgba(6, 182, 212, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
              üìà
            </div>
            <div>
              <div style="font-weight: 700; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.25rem;">Analytics</div>
              <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6);">View platform stats</div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Active Scenarios -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-title">
            <span>‚ö°</span>
            <span>Active Scenarios</span>
          </div>
          <a href="#" class="section-link">View all ‚Üí</a>
        </div>
        
        <div class="scenario-list" id="scenariosList">
          <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
            Loading scenarios...
          </div>
        </div>
      </div>
      
      <!-- Sidebar -->
      <div>
        <!-- Earnings Summary -->
        <div class="section-card" id="earningsCard">
          <div class="earnings-summary">
            <div class="earnings-value" id="monthlyEarnings">$0.00</div>
            <div class="earnings-label">This Month's Earnings</div>
            <div class="earnings-breakdown" id="earningsBreakdown">
              <div class="breakdown-item">
                <span>Screen Time</span>
                <span class="breakdown-value">$0.00</span>
              </div>
              <div class="breakdown-item">
                <span>Tips</span>
                <span class="breakdown-value">$0.00</span>
              </div>
              <div class="breakdown-item">
                <span>Ad Revenue</span>
                <span class="breakdown-value">$0.00</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="width: 100%; justify-content: center;" id="payoutBtn" disabled>
            <span>üí∏</span>
            <span>Request Payout</span>
          </button>
        </div>
        
        <!-- Recent Activity -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">
              <span>üìä</span>
              <span>Recent Activity</span>
            </div>
          </div>
          
          <div class="activity-list" id="activityList">
            <div class="activity-item">
              <div class="activity-icon">üé¨</div>
              <div class="activity-content">
                <div class="activity-text">Episode 3 published</div>
                <div class="activity-time">2 hours ago</div>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon">üí∞</div>
              <div class="activity-content">
                <div class="activity-text">Earned $127 from tips</div>
                <div class="activity-time">5 hours ago</div>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon">‚≠ê</div>
              <div class="activity-content">
                <div class="activity-text">New follower milestone: 10K</div>
                <div class="activity-time">1 day ago</div>
              </div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon">üìù</div>
              <div class="activity-content">
                <div class="activity-text">Responded to 3 scenarios</div>
                <div class="activity-time">2 days ago</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuth, handleSignOut as authHandleSignOut } from '../js/auth-handler.js'
    import { getCharacterDashboard, getActiveScenarios, calculateCharacterEarnings } from '../js/api.js'
    import { supabaseClient as supabase } from '../js/supabase-module.js'

    window.handleSignOut = async function() {
      if (confirm('Are you sure you want to sign out?')) {
        const result = await authHandleSignOut()
        if (result.success) {
          window.location.href = '/index.html'
        }
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount || 0)
    }

    function formatTime(seconds) {
      if (!seconds) return '0m'
      const hours = Math.floor(seconds / 3600)
      const minutes = Math.floor((seconds % 3600) / 60)
      if (hours > 0) return `${hours}h ${minutes}m`
      return `${minutes}m`
    }

    async function initDashboard() {
      const user = await requireAuth()
      if (!user) return

      const displayName = user.user_metadata?.display_name || user.email.split('@')[0]
      const userName = document.getElementById('userName')
      if (userName) userName.textContent = displayName

      // Force scenarios to load after 2 seconds if not loaded yet
      setTimeout(async () => {
        const scenariosList = document.getElementById('scenariosList')
        if (scenariosList && scenariosList.innerHTML.includes('Loading scenarios')) {
          console.log('‚è∞ Timeout - forcing scenarios to load...')
          try {
            await loadScenarios(user.id, 0)
          } catch (e) {
            console.error('‚ùå Timeout load failed:', e)
            scenariosList.innerHTML = `<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);"><div style="margin-bottom:1rem;">‚ö†Ô∏è Unable to load scenarios</div><div style="font-size:0.9rem;">Please refresh the page</div></div>`
          }
        }
      }, 2000)

      // Check if user is admin and show admin features
      try {
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single()

        console.log('üîç Admin check - Profile:', profile, 'Error:', profileError)
        console.log('üîç User role:', profile?.role)
        console.log('üîç Is admin?', profile?.role === 'admin')

        if (!profileError && profile?.role === 'admin') {
          // Show admin panel
          const adminPanel = document.getElementById('adminPanel')
          const directorBtn = document.getElementById('directorConsoleBtn')

          console.log('üîç Admin panel element:', adminPanel)
          console.log('üîç Director button element:', directorBtn)

          if (adminPanel) adminPanel.style.display = 'block'
          if (directorBtn) directorBtn.style.display = 'inline-block'

          console.log('‚úÖ Admin features enabled for admin user')
        } else {
          console.log('‚ùå Not admin or error:', profileError)
        }
      } catch (error) {
        console.error('Error checking admin status:', error)
      }

      try {
        const stats = await getCharacterDashboard(user.id)
        console.log('üìä Dashboard stats:', stats)

        document.getElementById('welcomeMessage').textContent = `Welcome back, ${displayName}! üëã`
        document.getElementById('totalEarnings').textContent = formatCurrency(stats.total_earnings)
        document.getElementById('totalEpisodes').textContent = stats.total_episodes || 0
        document.getElementById('totalScreenTime').textContent = formatTime(stats.total_screen_time)
        document.getElementById('voiceNotesPosted').textContent = stats.voice_notes_posted || 0

        const pendingCount = stats.pending_scenarios || 0
        document.getElementById('scenarioCount').textContent =
          pendingCount === 0 ? 'No active scenarios at the moment' :
          `You have ${pendingCount} active scenario${pendingCount > 1 ? 's' : ''} waiting for your response`

        await loadScenarios(user.id, pendingCount)
        await loadEarnings(user.id, stats)
        await loadActivity(user.id)

      } catch (error) {
        console.error('‚ùå Error loading dashboard:', error)
        document.getElementById('welcomeMessage').textContent = `Welcome back, ${displayName}! üëã`
        document.getElementById('scenarioCount').textContent = 'Dashboard loaded'

        // Try to load scenarios anyway, even if dashboard stats failed
        console.log('‚ö†Ô∏è Attempting to load scenarios despite error...')
        try {
          await loadScenarios(user.id, 0)
        } catch (scenarioError) {
          console.error('‚ùå Failed to load scenarios:', scenarioError)
        }
      }
    }

    async function loadScenarios(userId, count) {
      console.log('üìã Loading scenarios for user:', userId, 'Expected count:', count)
      const scenariosList = document.getElementById('scenariosList')

      try {
        console.log('üìã Fetching active scenarios...')
        const scenarios = await getActiveScenarios(userId)
        console.log('üìã Scenarios fetched:', scenarios)

        if (!scenarios || scenarios.length === 0) {
          console.log('üìã No scenarios found')
          scenariosList.innerHTML = `<div style="text-align:center;padding:3rem;color:rgba(255,255,255,0.5);"><div style="font-size:3rem;margin-bottom:1rem;opacity:0.7;">‚úÖ</div><div style="font-size:1.1rem;font-weight:600;color:rgba(255,255,255,0.9);margin-bottom:0.5rem;">All Clear!</div><div style="font-size:0.9rem;">No active scenarios right now. Check back soon!</div></div>`
        } else {
          console.log('üìã Rendering', scenarios.length, 'scenarios')
          scenariosList.innerHTML = scenarios.map(s => `<div class="scenario-item" onclick="window.location.href='scenario-response.html?id=${s.id}'" style="cursor:pointer;"><div class="scenario-header"><div class="scenario-title">${s.scenario_type === 'confession' ? 'üí≠' : s.scenario_type === 'confrontation' ? 'üî•' : s.scenario_type === 'alliance' ? 'ü§ù' : s.scenario_type === 'challenge' ? '‚ö°' : 'üìù'} ${s.title}</div><div class="scenario-badge badge-pending">${formatTimeRemaining(s.time_remaining)}</div></div><p style="color:rgba(255,255,255,0.7);font-size:0.9rem;margin-bottom:0.75rem;">${s.description || 'Respond to this scenario'}</p><div class="scenario-meta"><div class="meta-item"><span>${s.has_responded ? '‚úÖ' : '‚è≥'}</span><span>${s.has_responded ? 'Responded' : 'Pending'}</span></div></div></div>`).join('')
          console.log('‚úÖ Scenarios rendered successfully')
        }
      } catch (error) {
        console.error('‚ùå Error loading scenarios:', error)
        scenariosList.innerHTML = `<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);"><div style="margin-bottom:1rem;">‚ö†Ô∏è Unable to load scenarios</div><div style="font-size:0.9rem;">Error: ${error.message}</div></div>`
      }
    }

    async function loadEarnings(userId, stats) {
      try {
        const now = new Date()
        const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]
        const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]
        const earnings = await calculateCharacterEarnings(userId, startDate, endDate)
        const data = earnings[0] || {}
        document.getElementById('monthlyEarnings').textContent = formatCurrency(data.total)
        document.getElementById('earningsBreakdown').innerHTML = `<div class="breakdown-item"><span>Screen Time</span><span class="breakdown-value">${formatCurrency(data.screen_time_revenue)}</span></div><div class="breakdown-item"><span>Tips</span><span class="breakdown-value">${formatCurrency(data.tip_revenue)}</span></div><div class="breakdown-item"><span>Ad Revenue</span><span class="breakdown-value">${formatCurrency(data.ad_revenue)}</span></div>`
      } catch (error) {
        console.error('Error loading earnings:', error)
      }
    }

    async function loadActivity(userId) {
      const activityList = document.getElementById('activityList')
      try {
        const { data: episodes } = await supabase.from('episode_cast').select('created_at, episodes(title)').eq('user_id', userId).order('created_at', { ascending: false }).limit(3)
        const { data: voiceNotes } = await supabase.from('voice_notes').select('created_at, status').eq('user_id', userId).order('created_at', { ascending: false }).limit(3)
        const { data: earnings } = await supabase.from('earnings').select('amount, source_type, created_at').eq('user_id', userId).order('created_at', { ascending: false }).limit(3)

        const activities = []
        if (episodes) episodes.forEach(e => activities.push({ icon: 'üé¨', text: `Featured in: ${e.episodes?.title || 'Episode'}`, time: getRelativeTime(e.created_at) }))
        if (voiceNotes) voiceNotes.forEach(v => activities.push({ icon: 'üé§', text: `Voice note ${v.status}`, time: getRelativeTime(v.created_at) }))
        if (earnings) earnings.forEach(e => activities.push({ icon: 'üí∞', text: `Earned ${formatCurrency(e.amount)}`, time: getRelativeTime(e.created_at) }))

        if (activities.length === 0) {
          activityList.innerHTML = `<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);"><div style="font-size:2rem;margin-bottom:0.5rem;">üé¨</div><div style="font-size:0.9rem;">No activity yet</div></div>`
        } else {
          activityList.innerHTML = activities.slice(0, 5).map(a => `<div class="activity-item"><div class="activity-icon">${a.icon}</div><div class="activity-content"><div class="activity-text">${a.text}</div><div class="activity-time">${a.time}</div></div></div>`).join('')
        }
      } catch (error) {
        console.error('Error loading activity:', error)
      }
    }

    function getRelativeTime(timestamp) {
      if (!timestamp) return 'Recently'
      const diff = new Date() - new Date(timestamp)
      const minutes = Math.floor(diff / 60000)
      const hours = Math.floor(diff / 3600000)
      const days = Math.floor(diff / 86400000)
      if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`
      if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`
      return `${days} day${days !== 1 ? 's' : ''} ago`
    }

    function formatTimeRemaining(timeRemaining) {
      // timeRemaining can be ms (number) or PostgreSQL interval object
      if (!timeRemaining) return 'Expired'

      // If it's an interval object from PostgreSQL, convert to ms
      let ms = timeRemaining
      if (typeof timeRemaining === 'object' && timeRemaining.milliseconds) {
        ms = timeRemaining.milliseconds
      } else if (typeof timeRemaining === 'string') {
        // Parse PostgreSQL interval format if needed
        return timeRemaining
      }

      if (ms < 0) return 'Expired'
      const hours = Math.floor(ms / 3600000)
      const minutes = Math.floor((ms % 3600000) / 60000)
      if (hours > 24) return `${Math.floor(hours / 24)}d remaining`
      if (hours > 0) return `${hours}h remaining`
      return `${minutes}m remaining`
    }

    // Handle Respond Now button click
    async function handleRespondNow() {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) {
          window.location.href = '/index.html'
          return
        }

        // Find active game cast membership
        const { data: membership } = await supabase
          .from('mm_game_cast')
          .select('game_id, cast_member_id')
          .eq('user_id', user.id)
          .eq('status', 'active')
          .limit(1)
          .maybeSingle()

        if (!membership) {
          alert('Join a game first to respond to scenarios!')
          window.location.href = '/pages/browse-games.html'
          return
        }

        // Get oldest unanswered scenario in active game
        const { data: scenario } = await supabase
          .from('scenarios')
          .select('id, title, deadline_at')
          .eq('game_id', membership.game_id)
          .eq('status', 'active')
          .not('id', 'in', `(
            SELECT scenario_id FROM scenario_responses
            WHERE user_id = '${user.id}'
          )`)
          .order('created_at', { ascending: true })
          .limit(1)
          .maybeSingle()

        if (scenario) {
          // Navigate to oldest unanswered scenario
          window.location.href = `/pages/scenario-response.html?id=${scenario.id}`
        } else {
          alert('‚úÖ All caught up! No scenarios awaiting your response.')
        }

      } catch (error) {
        console.error('Error handling respond now:', error)
        alert('Error finding scenarios. Please try again.')
      }
    }

    // Expose to global scope for inline onclick handler
    window.handleRespondNow = handleRespondNow

    // Helper function to make current user an admin
    window.makeAdmin = async function() {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) {
          console.error('No user logged in')
          return
        }

        const { error } = await supabase
          .from('profiles')
          .update({ role: 'admin' })
          .eq('id', user.id)

        if (error) {
          console.error('Error setting admin role:', error)
        } else {
          console.log('‚úÖ Admin role set! Refreshing page...')
          setTimeout(() => window.location.reload(), 1000)
        }
      } catch (error) {
        console.error('Error:', error)
      }
    }

    document.addEventListener('DOMContentLoaded', initDashboard)
  </script>

  <!-- Load global nav -->
  <script type="module">
    fetch('/includes/global-nav.html')
      .then(res => res.text())
      .then(html => {
        const container = document.getElementById('globalNavContainer')
        container.innerHTML = html

        // Execute scripts manually since innerHTML doesn't run them
        const scripts = container.querySelectorAll('script')
        scripts.forEach(script => {
          const newScript = document.createElement('script')
          if (script.type) newScript.type = script.type
          if (script.src) {
            newScript.src = script.src
          } else {
            newScript.textContent = script.textContent
          }
          document.body.appendChild(newScript)
          script.remove() // Remove the non-executing script
        })
      })
      .catch(err => console.error('Failed to load navigation:', err))
  </script>

</body>
</html>
