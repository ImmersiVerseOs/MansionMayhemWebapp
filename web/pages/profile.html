<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile â€” Mansion Mayhem</title>
  <link rel="stylesheet" href="/css/candy.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page">
    <div class="orb3"></div>
    <div class="main"><div class="container-narrow" id="c" style="text-align:center"><div class="spinner" style="margin:5rem auto"></div></div></div>
  </div>
  <script type="module">
    import{waitForSupabase,requireAuth,getProfile,signOut}from'/js/supabase.js';
    import{initSidebar}from'/js/sidebar.js';
    import*as userMod from'/js/supabase.js';
    async function init(){
      const sb=await waitForSupabase();const user=await requireAuth();if(!user)return;
      await initSidebar('profile',userMod);
      const p=await getProfile(user.id)||{};const gp=p.games_played||0,gw=p.games_won||0,wr=gp>0?Math.round(gw/gp*100):0;
      document.getElementById('c').innerHTML=`
        <div class="av av-xl av-pink anim" style="margin:0 auto">${p.display_name?p.display_name[0].toUpperCase():'?'}</div>
        <h2 class="display-lg anim anim-d1" style="margin-top:0.75rem">${p.display_name||'Player'}</h2>
        <span class="pill pill-purple anim anim-d2" style="margin-top:0.35rem">${p.role||'Player'}</span>
        <div class="stats anim anim-d3" style="margin-top:1.5rem">
          <div class="stat"><div class="stat-val fire-text">${gp}</div><div class="stat-lbl">Games</div></div>
          <div class="stat"><div class="stat-val" style="color:var(--green)">${gw}</div><div class="stat-lbl">Wins</div></div>
          <div class="stat"><div class="stat-val" style="color:var(--cyan)">${wr}%</div><div class="stat-lbl">Win Rate</div></div>
        </div>
        <div class="grid-2 anim anim-d4" style="margin-top:1.5rem;text-align:left">
          <div class="card card-accent"><div class="label" style="color:var(--text3);margin-bottom:0.75rem">Account</div><div style="display:flex;justify-content:space-between;font-size:0.88rem;margin-bottom:0.4rem"><span style="color:var(--text2)">Email</span><span>${user.email||'â€”'}</span></div><div style="display:flex;justify-content:space-between;font-size:0.88rem"><span style="color:var(--text2)">Joined</span><span>${p.created_at?new Date(p.created_at).toLocaleDateString():'â€”'}</span></div></div>
          <div class="card"><div class="label" style="color:var(--text3);margin-bottom:0.75rem">Recent Games</div><div id="recent" class="body-md">Loading...</div></div>
        </div>`;
      const{data:cms}=await sb.from('cast_members').select('id').eq('user_id',user.id);
      if(cms?.length){const{data:games}=await sb.from('mm_game_cast').select('status,placement,mm_games(game_mode,status,created_at)').in('cast_member_id',cms.map(c=>c.id)).order('joined_at',{ascending:false}).limit(5);const r=document.getElementById('recent');if(!games?.length){r.textContent='No games yet.';return}const mi={party:'ðŸŽ‰',blitz:'âš¡',sprint:'ðŸƒ',weekly:'ðŸ“…'};r.innerHTML=games.map(g=>{const gm=g.mm_games;return`<div class="row" style="margin-bottom:0.5rem"><span style="font-size:1.2rem">${mi[gm?.game_mode]||'ðŸŽ®'}</span><div style="flex:1"><div style="font-weight:600;font-size:0.85rem">${(gm?.game_mode||'Game')[0].toUpperCase()+(gm?.game_mode||'').slice(1)}</div><div style="font-size:0.7rem;color:var(--text3)">${gm?.created_at?new Date(gm.created_at).toLocaleDateString():''}</div></div><span class="pill ${g.placement===1?'pill-gold':g.status==='eliminated'?'pill-red':'pill-ghost'}">${g.placement===1?'ðŸ‘‘ Won':g.status==='eliminated'?'Out':g.status}</span></div>`}).join('')}
    }
    init();
  </script>
</body>
</html>
