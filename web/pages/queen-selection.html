<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Queen Selection | Mansion Mayhem</title>
<link rel="icon" type="image/png" href="/assets/logo/favicon.png">
<link rel="icon" type="image/x-icon" href="/assets/logo/favicon.ico">

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800;900&family=Cormorant+Garamond:wght@300;400;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root {
  --gold: #FFC107;
  --gold-light: #FFD54F;
  --gold-dark: #FFA000;
  --pink: #E91E63;
  --purple: #9C27B0;
  --rose: #E91E63;
  --rose-deep: #AD1457;
  --gradient: linear-gradient(135deg, #FFC107 0%, #E91E63 50%, #9C27B0 100%);
  --black: #0A0E27;
  --surface: #0C0C0C;
  --card: rgba(255, 255, 255, 0.03);
  --text: #F0EDE5;
  --text-dim: rgba(255, 255, 255, 0.6);
  --border: rgba(255, 255, 255, 0.1);
}

body {
  background: var(--black);
  color: var(--text);
  font-family: 'Cormorant Garamond', serif;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

/* ========== BACKGROUND ATMOSPHERE ========== */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 800px 600px at 50% 30%, rgba(255,193,7,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 400px 400px at 20% 80%, rgba(233,30,99,0.05) 0%, transparent 70%),
    radial-gradient(ellipse 400px 400px at 80% 70%, rgba(156,39,176,0.04) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* Noise texture */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* ========== PARTICLE CANVAS ========== */
#particles {
  position: fixed;
  inset: 0;
  z-index: 1;
  pointer-events: none;
}

/* ========== HEADER ========== */
.header {
  position: relative;
  z-index: 10;
  text-align: center;
  padding: 48px 24px 20px;
}

.header-week {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 14px;
  letter-spacing: 6px;
  color: var(--gold);
  text-transform: uppercase;
  margin-bottom: 8px;
}

.header-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(36px, 7vw, 72px);
  font-weight: 900;
  line-height: 1;
  margin-bottom: 6px;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 8px rgba(233,30,99,0.3));
}

.header-sub {
  font-size: 18px;
  color: var(--text-dim);
  font-weight: 300;
  letter-spacing: 1px;
}

.header-divider {
  width: 120px;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  margin: 20px auto 0;
}

/* ========== STATS BAR ========== */
.stats-bar {
  position: relative;
  z-index: 10;
  display: flex;
  justify-content: center;
  gap: 40px;
  padding: 16px 24px;
  margin-bottom: 8px;
}

.stat {
  text-align: center;
}

.stat-value {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  color: var(--gold);
  line-height: 1;
}

.stat-label {
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 2px;
}

/* ========== QUEEN GRID (THE CAST) ========== */
.cast-section {
  position: relative;
  z-index: 10;
  padding: 0 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.cast-label {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 13px;
  letter-spacing: 4px;
  color: var(--text-dim);
  text-transform: uppercase;
  text-align: center;
  margin-bottom: 20px;
}

.queen-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 12px;
  margin-bottom: 32px;
}

.queen-cell {
  position: relative;
  aspect-ratio: 3/4;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  border: 1px solid var(--border);
  background: var(--card);
}

.queen-cell:hover {
  transform: translateY(-4px) scale(1.03);
  border-color: var(--pink);
  box-shadow: 0 8px 32px rgba(233,30,99,0.2), 0 0 0 1px rgba(233,30,99,0.3);
}

.queen-cell.eliminated {
  opacity: 0.25;
  filter: grayscale(1);
  pointer-events: none;
  border-color: #1a1a1a;
}

.queen-cell.eliminated::after {
  content: 'ELIMINATED';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--rose);
  background: rgba(0,0,0,0.6);
}

.queen-cell.selected {
  border-color: var(--pink);
  box-shadow:
    0 0 30px rgba(233,30,99,0.4),
    0 0 60px rgba(233,30,99,0.2),
    inset 0 0 20px rgba(233,30,99,0.15);
  animation: selectedPulse 2s ease infinite;
}

@keyframes selectedPulse {
  0%, 100% { box-shadow: 0 0 30px rgba(233,30,99,0.4), 0 0 60px rgba(233,30,99,0.2); }
  50% { box-shadow: 0 0 40px rgba(233,30,99,0.6), 0 0 80px rgba(233,30,99,0.3); }
}

.queen-cell.cycling {
  border-color: var(--rose);
  box-shadow: 0 0 20px rgba(233,30,99,0.3);
}

.queen-gradient {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent 40%, rgba(5,5,5,0.95) 100%);
  z-index: 1;
}

.queen-avatar {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.queen-avatar-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--gold);
  background: linear-gradient(135deg, #0f0f0f 0%, #1a1a18 100%);
}

.queen-info {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 8px 10px;
  z-index: 2;
}

.queen-name {
  font-family: 'Playfair Display', serif;
  font-size: 11px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.queen-archetype {
  font-size: 9px;
  color: var(--gold);
  letter-spacing: 0.5px;
  font-weight: 600;
}

/* ========== SELECTION STAGE ========== */
.stage {
  position: relative;
  z-index: 10;
  text-align: center;
  padding: 24px;
  margin-bottom: 32px;
}

.stage-frame {
  width: 220px;
  height: 290px;
  margin: 0 auto 24px;
  position: relative;
  border-radius: 16px;
  overflow: hidden;
}

/* Ornate gold border */
.stage-frame::before {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 18px;
  background: linear-gradient(135deg, var(--gold-light), var(--gold), var(--gold-dark), var(--gold), var(--gold-light));
  z-index: -1;
  animation: borderShimmer 3s linear infinite;
  background-size: 200% 200%;
}

@keyframes borderShimmer {
  0% { background-position: 0% 0%; }
  100% { background-position: 200% 200%; }
}

.stage-frame-inner {
  width: 100%;
  height: 100%;
  background: var(--black);
  border-radius: 14px;
  overflow: hidden;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.stage-placeholder {
  font-family: 'Playfair Display', serif;
  font-size: 48px;
  color: var(--gold);
  opacity: 0.2;
}

.stage-cycling-name {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 16px;
  background: linear-gradient(transparent, rgba(0,0,0,0.9));
  text-align: center;
  z-index: 5;
}

.stage-cycling-name .name {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.stage-cycling-name .arch {
  font-size: 12px;
  color: var(--gold);
  letter-spacing: 1px;
}

/* ========== REVEAL STATE ========== */
.stage-frame.revealed {
  transform: scale(1.05);
  transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.stage-frame.revealed::before {
  animation: revealBorder 1.5s ease infinite;
}

@keyframes revealBorder {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.5); }
}

/* ========== BUTTONS ========== */
.controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  flex-wrap: wrap;
}

.btn {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 18px;
  letter-spacing: 3px;
  padding: 14px 40px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative;
  overflow: hidden;
}

.btn-select {
  background: var(--gradient);
  color: var(--black);
  box-shadow: 0 4px 24px rgba(233,30,99,0.3);
}

.btn-select:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(233,30,99,0.5);
}

.btn-select:active { transform: translateY(0); }

.btn-select:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-reset {
  background: transparent;
  color: var(--text-dim);
  border: 1px solid var(--border);
}

.btn-reset:hover {
  border-color: var(--text-dim);
  color: var(--text);
}

/* ========== REVEAL OVERLAY ========== */
.reveal-overlay {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  background: rgba(0,0,0,0.92);
  backdrop-filter: blur(8px);
}

.reveal-overlay.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.reveal-crown {
  font-size: 64px;
  margin-bottom: 16px;
  animation: crownBounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
}

@keyframes crownBounce {
  from { transform: scale(0) rotate(-20deg); opacity: 0; }
  to { transform: scale(1) rotate(0deg); opacity: 1; }
}

.reveal-announce {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 16px;
  letter-spacing: 6px;
  color: var(--gold);
  text-transform: uppercase;
  margin-bottom: 8px;
  animation: slideUp 0.5s ease 0.5s both;
}

.reveal-name {
  font-family: 'Playfair Display', serif;
  font-size: clamp(40px, 8vw, 80px);
  font-weight: 900;
  background: var(--gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  animation: slideUp 0.6s ease 0.7s both;
  text-align: center;
  padding: 0 20px;
}

.reveal-archetype {
  font-size: 20px;
  color: var(--text-dim);
  letter-spacing: 2px;
  margin-bottom: 32px;
  animation: slideUp 0.5s ease 0.9s both;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.reveal-traits {
  display: flex;
  gap: 24px;
  margin-bottom: 32px;
  animation: slideUp 0.5s ease 1.1s both;
}

.reveal-trait {
  text-align: center;
}

.reveal-trait-value {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  color: var(--gold);
}

.reveal-trait-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.reveal-quote {
  max-width: 500px;
  text-align: center;
  font-style: italic;
  font-size: 18px;
  color: var(--text-dim);
  line-height: 1.6;
  margin-bottom: 40px;
  animation: slideUp 0.5s ease 1.3s both;
  padding: 0 20px;
}

.btn-continue {
  background: var(--gradient);
  color: var(--black);
  font-family: 'Bebas Neue', sans-serif;
  font-size: 16px;
  letter-spacing: 4px;
  padding: 12px 48px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  animation: slideUp 0.5s ease 1.5s both;
  transition: all 0.2s;
}

.btn-continue:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(233,30,99,0.4); }

/* ========== HISTORY ========== */
.history-section {
  position: relative;
  z-index: 10;
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 24px;
}

.history-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 13px;
  letter-spacing: 4px;
  color: var(--text-dim);
  text-transform: uppercase;
  text-align: center;
  margin-bottom: 16px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.history-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
}

.history-week {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 14px;
  letter-spacing: 2px;
  color: var(--gold);
  width: 70px;
  flex-shrink: 0;
}

.history-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Playfair Display', serif;
  font-size: 14px;
  font-weight: 800;
  color: var(--black);
  flex-shrink: 0;
}

.history-name {
  font-family: 'Playfair Display', serif;
  font-size: 15px;
  font-weight: 700;
  flex: 1;
}

.history-arch {
  font-size: 12px;
  color: var(--text-dim);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .queen-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .stats-bar { gap: 24px; }
  .reveal-traits { gap: 16px; }
  .stage-frame { width: 180px; height: 240px; }
}

@media (max-width: 480px) {
  .queen-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
  .header { padding: 32px 16px 16px; }
}
</style>
  <link rel="stylesheet" href="../css/modern-theme.css">
</head>
<body>

<canvas id="particles"></canvas>

<!-- HEADER -->
<div class="header">
  <div class="header-week" id="weekLabel">WEEK 1 OF 20</div>
  <h1 class="header-title">Queen Selection</h1>
  <p class="header-sub">The Crown Chooses Its Wearer</p>
  <div class="header-divider"></div>
</div>

<!-- STATS -->
<div class="stats-bar">
  <div class="stat"><div class="stat-value" id="statRemaining">20</div><div class="stat-label">Remaining</div></div>
  <div class="stat"><div class="stat-value" id="statEliminated">0</div><div class="stat-label">Eliminated</div></div>
  <div class="stat"><div class="stat-value" id="statWeek">1</div><div class="stat-label">Week</div></div>
</div>

<!-- SELECTION STAGE -->
<div class="stage">
  <div class="stage-frame" id="stageFrame">
    <div class="stage-frame-inner" id="stageInner">
      <div class="stage-placeholder" id="stagePlaceholder">&#x265B;</div>
    </div>
  </div>
  <div class="controls">
    <button class="btn btn-select" id="btnSelect" onclick="startSelection()">SELECT THIS WEEK'S QUEEN</button>
    <button class="btn btn-reset" onclick="resetWeek()">RESET</button>
  </div>
</div>

<!-- CAST GRID -->
<div class="cast-section">
  <div class="cast-label" id="castLabel">THE CAST &mdash; SEASON 1</div>
  <div class="queen-grid" id="queenGrid"></div>
</div>

<!-- SELECTION HISTORY -->
<div class="history-section" id="historySection" style="display:none">
  <div class="history-title">PAST SELECTIONS</div>
  <div class="history-list" id="historyList"></div>
</div>

<!-- REVEAL OVERLAY -->
<div class="reveal-overlay" id="revealOverlay">
  <div class="reveal-crown">&#128081;</div>
  <div class="reveal-announce">THIS WEEK'S QUEEN IS</div>
  <div class="reveal-name" id="revealName"></div>
  <div class="reveal-archetype" id="revealArchetype"></div>
  <div class="reveal-traits" id="revealTraits"></div>
  <div class="reveal-quote" id="revealQuote"></div>
  <button class="btn-continue" onclick="closeReveal()">CONTINUE</button>
</div>

<script type="module">
// ============================================
// SUPABASE INITIALIZATION
// ============================================
import { supabaseClient as supabase } from '../js/supabase-module.js'

// ============================================
// QUEEN DATA - Loaded from Database
// ============================================
let QUEENS = []
let gameId = null

// ============================================
// STATE
// ============================================
let currentWeek = 1;
let eliminatedIds = [];
let selectionHistory = [];
let isSelecting = false;
let cycleInterval = null;

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  // Get game ID from URL
  const urlParams = new URLSearchParams(window.location.search)
  gameId = urlParams.get('game')

  if (!gameId) {
    alert('No game specified')
    return
  }

  try {
    // Load cast members from database
    const { data: castMembers, error: castError } = await supabase
      .from('mm_game_cast')
      .select('cast_members(id, display_name, archetype)')
      .eq('game_id', gameId)
      .eq('status', 'active')

    if (castError) throw castError

    if (castMembers && castMembers.length > 0) {
      QUEENS = castMembers.map(m => ({
        id: m.cast_members.id,
        name: m.cast_members.display_name,
        archetype: m.cast_members.archetype,
        initials: m.cast_members.display_name.substring(0, 2).toUpperCase()
      }))
    }

    // Load selection history from database
    const { data: selections, error: selectError } = await supabase
      .from('mm_queen_selections')
      .select('week_number, round_number, selected_queen_id, selected_queen:cast_members!selected_queen_id(display_name, archetype)')
      .eq('game_id', gameId)
      .order('week_number', { ascending: false })

    if (selectError) throw selectError

    if (selections && selections.length > 0) {
      selectionHistory = selections.map(s => ({
        id: s.selected_queen_id,
        week: s.week_number,
        name: s.selected_queen?.display_name || 'Unknown',
        archetype: s.selected_queen?.archetype || 'Unknown'
      }))
      currentWeek = (selections[0]?.week_number || 0) + 1
    }

    // Load eliminated players
    const { data: eliminated, error: elimError } = await supabase
      .from('mm_game_cast')
      .select('cast_member_id')
      .eq('game_id', gameId)
      .eq('status', 'eliminated')

    if (!elimError && eliminated) {
      eliminatedIds = eliminated.map(e => e.cast_member_id)
    }

    // Render initial UI
    render()

  } catch (error) {
    console.error('Error loading game data:', error)
    alert('Failed to load game data: ' + error.message)
  }
}

// Load saved state (fallback for local testing)
try {
  const saved = localStorage.getItem('mm_queen_selection');
  if (saved) {
    const s = JSON.parse(saved);
    currentWeek = s.currentWeek || 1;
    eliminatedIds = s.eliminatedIds || [];
    selectionHistory = s.selectionHistory || [];
  }
} catch(e) {}

function saveState() {
  try {
    localStorage.setItem('mm_queen_selection', JSON.stringify({ currentWeek, eliminatedIds, selectionHistory }));
  } catch(e) {}
}

// ============================================
// RENDER
// ============================================
function getActive() {
  return QUEENS.filter(q => !eliminatedIds.includes(q.id));
}

function render() {
  // Header
  document.getElementById('weekLabel').textContent = `WEEK ${currentWeek} OF 20`;
  document.getElementById('statRemaining').textContent = getActive().length;
  document.getElementById('statEliminated').textContent = eliminatedIds.length;
  document.getElementById('statWeek').textContent = currentWeek;
  
  // Grid
  const grid = document.getElementById('queenGrid');
  grid.innerHTML = QUEENS.map(q => {
    const elim = eliminatedIds.includes(q.id);
    const selected = selectionHistory.some(s => s.id === q.id && s.week === currentWeek);
    return `<div class="queen-cell ${elim ? 'eliminated' : ''} ${selected ? 'selected' : ''}" data-id="${q.id}" id="queen-${q.id}">
      <div class="queen-avatar-placeholder">${q.initials}</div>
      <div class="queen-gradient"></div>
      <div class="queen-info">
        <div class="queen-name">${q.name}</div>
        <div class="queen-archetype">${q.archetype}</div>
      </div>
    </div>`;
  }).join('');
  
  // History
  const histSection = document.getElementById('historySection');
  const histList = document.getElementById('historyList');
  if (selectionHistory.length > 0) {
    histSection.style.display = '';
    histList.innerHTML = selectionHistory.slice().reverse().map(s => {
      const q = QUEENS.find(qq => qq.id === s.id);
      return `<div class="history-item">
        <div class="history-week">WEEK ${s.week}</div>
        <div class="history-avatar">${q.initials}</div>
        <div class="history-name">${q.name}</div>
        <div class="history-arch">${q.archetype}</div>
      </div>`;
    }).join('');
  } else {
    histSection.style.display = 'none';
  }
  
  // Button state
  const active = getActive();
  const btn = document.getElementById('btnSelect');
  const alreadySelected = selectionHistory.some(s => s.week === currentWeek);
  if (active.length === 0) {
    btn.disabled = true;
    btn.textContent = 'SEASON COMPLETE';
  } else if (alreadySelected) {
    btn.disabled = true;
    btn.textContent = 'QUEEN SELECTED THIS WEEK';
  } else {
    btn.disabled = false;
    btn.textContent = 'SELECT THIS WEEK\'S QUEEN';
  }
  
  // Reset stage
  if (!isSelecting && !alreadySelected) {
    document.getElementById('stageInner').innerHTML = '<div class="stage-placeholder">&#x265B;</div>';
    document.getElementById('stageFrame').classList.remove('revealed');
  }
}

// ============================================
// SELECTION LOTTERY
// ============================================
function startSelection() {
  if (isSelecting) return;
  const active = getActive();
  if (active.length === 0) return;
  
  isSelecting = true;
  document.getElementById('btnSelect').disabled = true;
  document.getElementById('btnSelect').textContent = 'SELECTING...';
  
  // Sound-like visual feedback - rapid cycling through queens
  let cycleCount = 0;
  const totalCycles = 30 + Math.floor(Math.random() * 15); // 30-45 cycles
  let currentCycleIdx = 0;
  let lastHighlighted = null;
  
  // Pre-select the winner (random from active)
  const winnerIdx = Math.floor(Math.random() * active.length);
  const winner = active[winnerIdx];
  
  // Ensure last few cycles land on the winner
  const cycleSpeed = (count) => {
    if (count < totalCycles * 0.5) return 60;   // Fast
    if (count < totalCycles * 0.75) return 120;  // Medium
    if (count < totalCycles * 0.9) return 200;   // Slow
    return 350; // Very slow (tension building)
  };
  
  function cycle() {
    // Remove previous highlight
    if (lastHighlighted !== null) {
      const el = document.getElementById('queen-' + lastHighlighted);
      if (el) el.classList.remove('cycling');
    }
    
    // Determine which queen to show
    let showQueen;
    if (cycleCount >= totalCycles - 3) {
      // Last 3 cycles: land on winner
      showQueen = winner;
    } else {
      showQueen = active[currentCycleIdx % active.length];
      currentCycleIdx++;
    }
    
    // Highlight in grid
    const el = document.getElementById('queen-' + showQueen.id);
    if (el) el.classList.add('cycling');
    lastHighlighted = showQueen.id;
    
    // Update stage
    document.getElementById('stageInner').innerHTML = `
      <div class="queen-avatar-placeholder" style="font-size:60px;">${showQueen.initials}</div>
      <div class="stage-cycling-name">
        <div class="name">${showQueen.name}</div>
        <div class="arch">${showQueen.archetype}</div>
      </div>`;
    
    cycleCount++;
    
    if (cycleCount < totalCycles) {
      setTimeout(cycle, cycleSpeed(cycleCount));
    } else {
      // FINAL - REVEAL THE WINNER
      setTimeout(() => revealWinner(winner), 500);
    }
  }
  
  cycle();
}

function revealWinner(queen) {
  isSelecting = false;
  
  // Remove all cycling highlights
  document.querySelectorAll('.queen-cell.cycling').forEach(el => el.classList.remove('cycling'));
  
  // Mark as selected in grid
  const el = document.getElementById('queen-' + queen.id);
  if (el) el.classList.add('selected');
  
  // Update stage with winner
  document.getElementById('stageFrame').classList.add('revealed');
  document.getElementById('stageInner').innerHTML = `
    <div class="queen-avatar-placeholder" style="font-size:72px;background:linear-gradient(135deg,#1a1810,#0f0f0a);">${queen.initials}</div>
    <div class="stage-cycling-name">
      <div class="name" style="font-size:22px;">${queen.name}</div>
      <div class="arch">${queen.archetype}</div>
    </div>`;
  
  // Record selection
  selectionHistory.push({ id: queen.id, week: currentWeek, name: queen.name, archetype: queen.archetype });
  saveState();
  
  // Trigger gold particle burst
  burstParticles();
  
  // Show dramatic reveal overlay
  setTimeout(() => {
    document.getElementById('revealName').textContent = queen.name;
    document.getElementById('revealArchetype').textContent = queen.archetype;
    document.getElementById('revealTraits').innerHTML = `
      <div class="reveal-trait"><div class="reveal-trait-value">${queen.confidence}</div><div class="reveal-trait-label">Confidence</div></div>
      <div class="reveal-trait"><div class="reveal-trait-value">${queen.drama}</div><div class="reveal-trait-label">Drama</div></div>
      <div class="reveal-trait"><div class="reveal-trait-value">${queen.charm}</div><div class="reveal-trait-label">Charm</div></div>`;
    document.getElementById('revealQuote').textContent = `"${queen.catchphrase}"`;
    document.getElementById('revealOverlay').classList.add('show');
  }, 800);
  
  render();
}

function closeReveal() {
  document.getElementById('revealOverlay').classList.remove('show');
}

function resetWeek() {
  if (selectionHistory.length === 0) return;
  if (!confirm('Reset this week\'s selection?')) return;
  
  const lastSelection = selectionHistory.pop();
  saveState();
  render();
  document.getElementById('stageInner').innerHTML = '<div class="stage-placeholder">&#x265B;</div>';
  document.getElementById('stageFrame').classList.remove('revealed');
}

// Admin function - simulate elimination (call from console: eliminateQueen(id))
window.eliminateQueen = function(id) {
  if (!eliminatedIds.includes(id)) {
    eliminatedIds.push(id);
    currentWeek++;
    saveState();
    render();
  }
};

// Admin: advance to next week
window.nextWeek = function() {
  currentWeek++;
  saveState();
  render();
};

// Admin: full reset
window.fullReset = function() {
  if (!confirm('Full reset? This clears all data.')) return;
  currentWeek = 1;
  eliminatedIds = [];
  selectionHistory = [];
  saveState();
  render();
  document.getElementById('stageInner').innerHTML = '<div class="stage-placeholder">&#x265B;</div>';
  document.getElementById('stageFrame').classList.remove('revealed');
};

// ============================================
// PARTICLE SYSTEM
// ============================================
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let particles = [];
let animFrame;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
  constructor(x, y, burst = false) {
    this.x = x || Math.random() * canvas.width;
    this.y = y || Math.random() * canvas.height;
    this.size = burst ? Math.random() * 4 + 1 : Math.random() * 2 + 0.5;
    this.speedX = burst ? (Math.random() - 0.5) * 8 : (Math.random() - 0.5) * 0.3;
    this.speedY = burst ? (Math.random() - 0.5) * 8 - 2 : -Math.random() * 0.5 - 0.1;
    this.life = burst ? 1 : 0.3 + Math.random() * 0.4;
    this.decay = burst ? 0.015 : 0.001;
    const rand = Math.random();
    this.color = rand > 0.6 ? 'rgba(233,30,99,' : rand > 0.3 ? 'rgba(255,193,7,' : 'rgba(156,39,176,';
  }
  
  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    this.life -= this.decay;
    if (this.life < 0) this.life = 0;
    this.speedY += 0.02; // gravity for burst
  }
  
  draw() {
    ctx.fillStyle = this.color + this.life + ')';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

// Ambient particles
for (let i = 0; i < 30; i++) particles.push(new Particle());

function burstParticles() {
  const cx = canvas.width / 2;
  const cy = canvas.height * 0.35;
  for (let i = 0; i < 80; i++) particles.push(new Particle(cx, cy, true));
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  particles = particles.filter(p => p.life > 0);
  
  // Replenish ambient particles
  while (particles.filter(p => p.decay < 0.01).length < 25) {
    particles.push(new Particle());
  }
  
  particles.forEach(p => { p.update(); p.draw(); });
  animFrame = requestAnimationFrame(animateParticles);
}

animateParticles();

// ============================================
// INIT
// ============================================
init();
</script>
</body>
</html>
