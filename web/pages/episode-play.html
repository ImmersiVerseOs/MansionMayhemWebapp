<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mansion Mayhem ‚Äî Live</title>
  <link rel="stylesheet" href="/css/candy.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .g-top{position:fixed;top:0;left:var(--sidebar-w);right:0;z-index:90;background:rgba(12,4,24,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0.5rem 1.5rem;display:flex;align-items:center;gap:0.75rem}
    .phase-pill{padding:0.25rem 0.7rem;border-radius:var(--r-pill);font-family:var(--font-display);font-size:0.6rem;font-weight:800;text-transform:uppercase;letter-spacing:0.06em}
    .phase-pill.arrival{background:var(--purple-s);color:var(--purple)}.phase-pill.social{background:var(--cyan-s);color:var(--cyan)}.phase-pill.challenge{background:var(--pink-s);color:var(--pink)}.phase-pill.whisper{background:var(--card);color:var(--text3)}.phase-pill.confrontation{background:var(--orange-s);color:var(--orange)}.phase-pill.deliberation{background:var(--gold-s);color:var(--gold)}.phase-pill.elimination{background:var(--red-s);color:var(--red)}
    .g-timer{font-family:var(--font-display);font-size:1.5rem;font-weight:900;min-width:4rem;text-align:center}
    .g-timer.warn{color:var(--gold)}.g-timer.crit{color:var(--red);animation:pulse 0.5s infinite alternate}
    .g-drama{flex:1;height:6px;background:rgba(255,255,255,0.04);border-radius:3px;overflow:hidden}
    .g-drama-fill{height:100%;border-radius:3px;transition:width 0.5s,background 0.5s}
    .g-ep{font-family:var(--font-display);font-size:0.7rem;color:var(--text3)}

    .g-layout{display:grid;grid-template-columns:1fr 380px;gap:0;min-height:100vh;margin-left:var(--sidebar-w)}
    .g-left{padding:3.5rem 1.5rem 1.5rem;overflow-y:auto;display:flex;flex-direction:column;gap:0.75rem}
    .g-right{border-left:1px solid var(--border);display:flex;flex-direction:column;padding-top:3.5rem}
    .g-right-tabs{display:flex;border-bottom:1px solid var(--border)}
    .g-right-tab{flex:1;padding:0.6rem;background:none;border:none;color:var(--text3);font-family:var(--font-display);font-size:0.7rem;font-weight:700;cursor:pointer;transition:all 0.15s;border-bottom:2px solid transparent}
    .g-right-tab.on{color:var(--pink);border-bottom-color:var(--pink)}
    .g-right-body{flex:1;overflow-y:auto;padding:0.75rem;display:flex;flex-direction:column;gap:0.4rem}
    .g-right-input{padding:0.5rem 0.75rem;display:flex;gap:0.4rem;border-top:1px solid var(--border)}

    .dir-ov{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);justify-content:center;align-items:center;padding:2rem;text-align:center}
    .dir-ov.on{display:flex;animation:fadeIn 0.3s ease}
    .dir-icon{font-size:4rem;animation:float 2.5s ease-in-out infinite}
    .dir-text{font-family:var(--font-display);font-size:1.15rem;font-weight:600;line-height:1.5;color:var(--gold);max-width:450px;margin-top:1rem}
    .dir-close{margin-top:1.25rem;background:none;border:1px solid rgba(255,255,255,0.1);color:var(--text3);padding:0.4rem 1.5rem;border-radius:var(--r-pill);font-size:0.75rem;font-family:var(--font);cursor:pointer}

    /* Player grid ‚Äî wider on desktop */
    .p-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.5rem}
    .p-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r-sm);padding:0.65rem;text-align:center;position:relative;transition:all 0.15s}
    .p-card.immune{border-color:rgba(0,220,130,0.3)}.p-card.struck{border-color:rgba(255,71,87,0.3)}.p-card.elim{opacity:0.3;filter:grayscale(1)}.p-card.me{border-color:rgba(168,85,247,0.3);box-shadow:0 0 16px rgba(168,85,247,0.1)}
    .p-av{width:42px;height:42px;border-radius:50%;background:var(--elevated);margin:0 auto 0.3rem;display:flex;align-items:center;justify-content:center;font-size:1.4rem;border:2px solid var(--border)}
    .p-nm{font-size:0.75rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .p-meta{font-size:0.6rem;color:var(--text3);margin-top:0.05rem}
    .p-strikes{position:absolute;top:4px;right:4px;display:flex;gap:2px}
    .p-strike{width:7px;height:7px;border-radius:50%;background:var(--red)}
    .p-btn{width:100%;margin-top:0.35rem;padding:0.3rem;border-radius:6px;font-size:0.65rem;font-weight:700;border:1px solid;cursor:pointer;background:none;font-family:var(--font-display)}
    .p-btn.vote{color:var(--pink);border-color:rgba(255,50,100,0.25)}.p-btn.vote:hover{background:var(--pink-s)}
    .p-btn.fight{color:var(--orange);border-color:rgba(255,107,43,0.25)}.p-btn.fight:hover{background:var(--orange-s)}
    .df-msg{background:rgba(255,184,0,0.05);border-left:3px solid var(--gold);padding:0.4rem 0.65rem;border-radius:0 var(--r-sm) var(--r-sm) 0;font-size:0.78rem;font-style:italic;color:var(--gold);margin-bottom:0.3rem}
    .role-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.5rem;text-align:center;position:relative;overflow:hidden}
    .role-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--grad-fire)}
    .challenge{background:var(--card);border:1px solid rgba(255,50,100,0.15);border-radius:var(--r);padding:1.25rem;text-align:center}
    .secret-box{background:linear-gradient(135deg,rgba(255,107,43,0.08),rgba(255,50,100,0.08));border:1px solid rgba(255,107,43,0.2);border-radius:var(--r-sm);padding:0.65rem}
    .mission{background:var(--card);border:1px solid rgba(255,184,0,0.12);border-radius:var(--r-sm);padding:0.75rem}
  </style>
</head>
<body>
  <div class="page">
    <div class="orb3"></div>
    <div id="loading" class="loading"><div class="spinner"></div><div class="loading-text">Entering the Mansion...</div></div>
    <div class="dir-ov" id="dirOv"><div><div class="dir-icon">üé≠</div><div class="dir-text" id="dirText"></div><button class="dir-close" onclick="dismissDir()">Continue</button></div></div>

    <div class="g-top">
      <div class="phase-pill" id="phasePill">LOBBY</div>
      <div class="g-timer" id="gTimer">--:--</div>
      <div class="g-drama"><div class="g-drama-fill" id="dramaFill" style="width:0%"></div></div>
      <div class="g-ep" id="gEp">EP 1</div>
    </div>

    <div class="g-layout">
      <div class="g-left" id="gLeft"></div>
      <div class="g-right">
        <div class="g-right-tabs">
          <button class="g-right-tab on" onclick="swRight('chat',this)">üí¨ Chat</button>
          <button class="g-right-tab" onclick="swRight('missions',this)">üìã Missions</button>
          <button class="g-right-tab" onclick="swRight('powers',this)">‚ö° Powers</button>
        </div>
        <div class="g-right-body" id="gRight"></div>
        <div class="g-right-input" id="gRightInput">
          <input class="input" id="chatIn" placeholder="Say something...">
          <button class="btn btn-fire btn-sm" onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import{waitForSupabase,requireAuth,getSupabase,getUser}from'/js/supabase.js';
    import{initSidebar}from'/js/sidebar.js';
    import*as userMod from'/js/supabase.js';

    let sb,user,gameId,castId;
    let S={phase:'lobby',ep:1,drama:0,phaseAt:null,mode:'party',players:[],myRole:null,myMissions:[],myPowers:[],dirMsgs:[],secrets:[],challenge:null};
    let dur={arrival:180,social:480,challenge:420,whisper:300,confrontation:300,deliberation:240,elimination:180};
    let timerIv=null,rightTab='chat';
    const PL={arrival:'Arrival',social:'Social Hour',challenge:'The Challenge',whisper:'Whisper Hour',confrontation:'Confrontation',deliberation:'Deliberation',elimination:'Elimination'};
    const AI={wildcard:'üÉè',strategist:'üß†',sweetheart:'üíñ',villain:'üòà',comedian:'üòÇ',troublemaker:'üí£',diva:'üëë',hothead:'üî•'};

    async function init(){
      const p=new URLSearchParams(location.search);gameId=p.get('game');
      if(!gameId){location.href='/pages/lobby.html';return}
      sb=await waitForSupabase();user=await requireAuth();if(!user)return;
      await initSidebar('game',userMod);
      const{data:cm}=await sb.from('cast_members').select('id').eq('user_id',user.id).maybeSingle();castId=cm?.id;
      await loadGame();await loadPlayers();await loadMyRole();await loadMyMissions();await loadMyPowers();await loadDir();await loadChallenge();
      subscribe();startTimer();render();document.getElementById('loading').style.display='none';
    }

    async function loadGame(){const{data:g}=await sb.from('mm_games').select('*').eq('id',gameId).single();if(!g)return;S.phase=g.current_phase||'lobby';S.phaseAt=g.phase_started_at;S.drama=g.drama_level||0;S.ep=g.episode_number||1;S.mode=g.game_mode||'party';const{data:ph}=await sb.from('episode_phase_templates').select('*').eq('mode_name',S.mode).order('phase_order');if(ph)ph.forEach(p=>dur[p.phase_name]=p.duration_secs)}
    async function loadPlayers(){const{data}=await sb.from('mm_game_cast').select('*,cast_members(id,display_name,archetype,is_ai_player)').eq('game_id',gameId);S.players=(data||[]).map(gc=>({id:gc.cast_member_id,name:gc.cast_members?.display_name||'?',arch:gc.cast_members?.archetype||'wildcard',ai:gc.cast_members?.is_ai_player,status:gc.status,strikes:gc.strike_count||0,immunity:gc.immunity,drama:gc.drama_points||0}))}
    async function loadMyRole(){if(!castId)return;const{data}=await sb.from('episode_player_roles').select('*,episode_role_templates(*)').eq('game_id',gameId).eq('episode_number',S.ep).eq('cast_member_id',castId).maybeSingle();S.myRole=data?{name:data.role_name,t:data.episode_role_templates,uses:data.ability_uses_remaining}:null}
    async function loadMyMissions(){if(!castId)return;const{data}=await sb.from('episode_missions').select('*,episode_mission_templates(*)').eq('game_id',gameId).eq('episode_number',S.ep).eq('cast_member_id',castId).in('status',['active']);S.myMissions=data||[]}
    async function loadMyPowers(){if(!castId)return;const{data}=await sb.from('episode_powers').select('*').eq('game_id',gameId).eq('cast_member_id',castId).eq('is_used',false);S.myPowers=data||[]}
    async function loadDir(){const{data}=await sb.from('episode_director_log').select('*').eq('game_id',gameId).eq('episode_number',S.ep).order('created_at',{ascending:false}).limit(8);S.dirMsgs=(data||[]).reverse()}
    async function loadChallenge(){const{data}=await sb.from('episode_challenges').select('*,episode_challenge_templates(*)').eq('game_id',gameId).eq('episode_number',S.ep).eq('status','active').maybeSingle();S.challenge=data}

    function subscribe(){
      sb.channel('g-'+gameId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'mm_games',filter:`id=eq.${gameId}`},async(p)=>{const old=S.phase;const g=p.new;S.phase=g.current_phase||S.phase;S.phaseAt=g.phase_started_at;S.drama=g.drama_level||0;S.ep=g.episode_number||S.ep;if(g.current_phase!==old){await onPhaseChange();startTimer()}if(g.status==='completed')location.href=`/pages/results.html?game=${gameId}`;render()}).subscribe();
      sb.channel('p-'+gameId).on('postgres_changes',{event:'*',schema:'public',table:'mm_game_cast',filter:`game_id=eq.${gameId}`},async()=>{await loadPlayers();render()}).subscribe();
      sb.channel('d-'+gameId).on('postgres_changes',{event:'INSERT',schema:'public',table:'episode_director_log',filter:`game_id=eq.${gameId}`},(p)=>{S.dirMsgs.push(p.new);if(S.dirMsgs.length>15)S.dirMsgs.shift();if(['phase_intro','announce','coronation'].includes(p.new.message_type))showDir(p.new.content);render()}).subscribe();
      sb.channel('f-'+gameId).on('postgres_changes',{event:'INSERT',schema:'public',table:'episode_fights',filter:`game_id=eq.${gameId}`},async(p)=>{const i=S.players.find(x=>x.id===p.new.initiator_id);const t=S.players.find(x=>x.id===p.new.target_id);showDir(`üí• ${i?.name||'???'} confronted ${t?.name||'???'}!`);await loadPlayers();render()}).subscribe();
      sb.channel('m-'+gameId).on('postgres_changes',{event:'*',schema:'public',table:'episode_missions',filter:`game_id=eq.${gameId}`},async(p)=>{if(p.new?.cast_member_id===castId){await loadMyMissions();render()}}).subscribe();
      sb.channel('pw-'+gameId).on('postgres_changes',{event:'INSERT',schema:'public',table:'episode_powers',filter:`game_id=eq.${gameId}`},async(p)=>{if(p.new?.cast_member_id===castId){await loadMyPowers();render()}}).subscribe();
      sb.channel('s-'+gameId).on('postgres_changes',{event:'UPDATE',schema:'public',table:'episode_secrets',filter:`game_id=eq.${gameId}`},(p)=>{if(p.new?.is_revealed){S.secrets.push(p.new);showDir(`üî• "${p.new.content}"`);render()}}).subscribe();
    }
    async function onPhaseChange(){if(S.phase==='arrival')await loadMyRole();if(['social','whisper'].includes(S.phase))await loadMyMissions();if(S.phase==='challenge')await loadChallenge()}
    function startTimer(){if(timerIv)clearInterval(timerIv);timerIv=setInterval(()=>{const d=dur[S.phase]||300;const el=(Date.now()-new Date(S.phaseAt||Date.now()).getTime())/1000;const r=Math.max(0,Math.round(d-el));const pct=d>0?r/d:0;const te=document.getElementById('gTimer');te.textContent=`${Math.floor(r/60)}:${(r%60).toString().padStart(2,'0')}`;te.className='g-timer'+(pct<0.15?' crit':pct<0.3?' warn':'');const df=document.getElementById('dramaFill');df.style.width=S.drama+'%';df.style.background=S.drama<25?'var(--green)':S.drama<50?'var(--gold)':S.drama<75?'var(--orange)':'var(--red)'},1000)}
    function showDir(t){document.getElementById('dirText').textContent=t;document.getElementById('dirOv').classList.add('on');setTimeout(()=>document.getElementById('dirOv').classList.remove('on'),5500)}
    window.dismissDir=()=>document.getElementById('dirOv').classList.remove('on');

    function render(){
      const pp=document.getElementById('phasePill');pp.textContent=(PL[S.phase]||S.phase).toUpperCase();pp.className='phase-pill '+S.phase;
      document.getElementById('gEp').textContent='EP '+S.ep;
      renderLeft();renderRight();
    }

    function renderLeft(){
      const a=document.getElementById('gLeft');let h='';
      const msgs=S.dirMsgs.slice(-3);if(msgs.length)h+=msgs.map(m=>`<div class="df-msg">"${m.content}"</div>`).join('');
      if(S.phase==='confrontation'&&S.secrets.length){const s=S.secrets[S.secrets.length-1];h+=`<div class="secret-box"><span style="font-family:var(--font-display);font-size:0.6rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.08em">üî• Secret Revealed</span><div style="font-size:0.88rem;font-weight:600;font-style:italic;margin-top:0.2rem">${s.content}</div></div>`}
      if(S.phase==='challenge'&&S.challenge?.episode_challenge_templates){const c=S.challenge.episode_challenge_templates;h+=`<div class="challenge"><div style="font-size:2.5rem;margin-bottom:0.3rem">${c.icon}</div><div style="font-family:var(--font-display);font-weight:700;font-size:1rem">${c.display_name}</div><div style="font-size:0.82rem;color:var(--text2);margin-top:0.3rem">${c.description}</div></div>`}
      if(S.myRole?.t){const r=S.myRole.t;h+=`<div style="display:flex;align-items:center;gap:0.65rem;background:var(--card);border:1px solid var(--border);border-radius:var(--r-sm);padding:0.6rem"><span style="font-size:1.8rem">${r.icon||'üé≠'}</span><div style="flex:1"><div class="fire-text" style="font-family:var(--font-display);font-weight:700;font-size:0.85rem">${r.display_name||S.myRole.name}</div><div style="font-size:0.65rem;color:var(--text3)">${r.ability_name} ¬∑ ${S.myRole.uses} use(s)</div></div></div>`}
      if(S.phase==='arrival'&&S.myRole?.t){const r=S.myRole.t;h+=`<div class="role-card anim"><div style="font-size:3.5rem;margin-bottom:0.5rem">${r.icon}</div><div class="fire-text" style="font-family:var(--font-display);font-size:1.3rem;font-weight:800">${r.display_name}</div><div style="font-size:0.85rem;color:var(--text2);margin-top:0.4rem;line-height:1.5">${r.description}</div><div style="background:var(--elevated);border-radius:var(--r-sm);padding:0.7rem;margin-top:0.75rem;text-align:left"><div style="font-family:var(--font-display);font-size:0.6rem;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:0.08em">‚ö° ${r.ability_name}</div><div style="font-size:0.8rem;color:var(--text2);margin-top:0.15rem">${r.ability_description}</div></div><div style="font-size:0.7rem;color:var(--text3);font-style:italic;margin-top:0.6rem">Only you can see this.</div></div>`}
      const active=S.players.filter(p=>p.status==='active');const elim=S.players.filter(p=>p.status==='eliminated');
      h+=`<div class="p-grid">`;
      active.forEach(p=>{const me=p.id===castId;h+=`<div class="p-card ${p.immunity?'immune':''} ${p.strikes>0?'struck':''} ${me?'me':''}"><div class="p-strikes">${'<span class="p-strike"></span>'.repeat(p.strikes)}</div><div class="p-av">${AI[p.arch]||'üé≠'}</div><div class="p-nm">${p.name}${me?' (You)':''}</div><div class="p-meta">${p.arch} ¬∑ ${p.drama}${p.immunity?' ¬∑ üõ°Ô∏è':''}</div>${S.phase==='deliberation'&&!me?`<button class="p-btn vote" onclick="castVote('${p.id}')">üó≥Ô∏è Vote</button>`:''}${['social','whisper','confrontation'].includes(S.phase)&&!me?`<button class="p-btn fight" onclick="startFight('${p.id}')">üí• Confront</button>`:''}</div>`});
      h+=`</div>`;
      if(elim.length)h+=`<div style="font-size:0.75rem;color:var(--text3)">Eliminated: ${elim.map(p=>p.name).join(', ')}</div>`;
      a.innerHTML=h;
    }

    function renderRight(){
      const body=document.getElementById('gRight');
      const inputRow=document.getElementById('gRightInput');
      inputRow.style.display=rightTab==='chat'?'flex':'none';
      if(rightTab==='chat'){body.innerHTML='<div style="text-align:center;color:var(--text3);font-size:0.82rem;padding:2rem">Chat is live during the game. Use Drama Chat for full experience.</div><a href="/pages/drama-chat.html?game='+gameId+'" class="btn btn-outline btn-sm" style="align-self:center">Open Drama Chat ‚Üí</a>'}
      else if(rightTab==='missions'){
        if(!S.myMissions.length){body.innerHTML='<div class="empty"><div class="empty-icon">üìã</div>No active missions.</div>';return}
        body.innerHTML=S.myMissions.map(m=>{const t=m.episode_mission_templates;return`<div class="mission"><div style="font-family:var(--font-display);font-size:0.55rem;font-weight:700;color:var(--gold);text-transform:uppercase">${t?.category||'mission'}${t?.is_betrayal?' ¬∑ ‚ö†Ô∏è BETRAYAL':''}</div><div style="font-family:var(--font-display);font-weight:700;font-size:0.85rem;margin-top:0.2rem">${t?.name||'Mission'}</div><div style="font-size:0.75rem;color:var(--text2);margin-top:0.1rem">${t?.description||''}</div><button class="btn btn-fire btn-sm btn-block" style="margin-top:0.5rem" onclick="completeMission('${m.id}')">‚úÖ Complete</button></div>`}).join('');
      } else if(rightTab==='powers'){
        if(!S.myPowers.length){body.innerHTML='<div class="empty"><div class="empty-icon">‚ö°</div>No powers yet.</div>';return}
        const ic={double_vote:'üó≥Ô∏è',spy:'üëÅÔ∏è',veto:'üõ°Ô∏è',immunity_grant:'üíö',secret_reveal:'üîÆ'};
        body.innerHTML=S.myPowers.map(p=>`<div class="card" style="text-align:center"><div style="font-size:2rem">${ic[p.power_type]||'‚ö°'}</div><div class="fire-text" style="font-family:var(--font-display);font-weight:700;font-size:0.85rem;margin-top:0.2rem">${p.power_type.replace(/_/g,' ').toUpperCase()}</div><button class="btn btn-fire btn-sm" style="margin-top:0.5rem" onclick="usePower('${p.id}')">Use</button></div>`).join('');
      }
    }

    window.swRight=(t,el)=>{rightTab=t;document.querySelectorAll('.g-right-tab').forEach(b=>b.classList.remove('on'));el.classList.add('on');renderRight()};
    window.castVote=async(tid)=>{const{data:round}=await sb.from('mm_voting_rounds').select('id').eq('game_id',gameId).in('status',['open','active']).order('created_at',{ascending:false}).limit(1).maybeSingle();if(!round)return;await sb.from('mm_elimination_votes').upsert({round_id:round.id,cast_member_id:castId,voted_for_id:tid},{onConflict:'round_id,cast_member_id'})};
    window.startFight=async(tid)=>{if(!confirm('Confront? Both get a strike!'))return;const{data,error}=await sb.from('episode_fights').insert({game_id:gameId,episode_number:S.ep,initiator_id:castId,target_id:tid,fight_type:'shove',phase:S.phase,outcome:'completed',drama_generated:15}).select().single();if(error)return;await sb.rpc('process_episode_fight',{p_fight_id:data.id})};
    window.completeMission=async(id)=>{await sb.from('episode_missions').update({status:'completed',completed_at:new Date().toISOString()}).eq('id',id).eq('cast_member_id',castId);await loadMyMissions();render()};
    window.usePower=async(id)=>{await sb.from('episode_powers').update({is_used:true,used_at:new Date().toISOString()}).eq('id',id).eq('cast_member_id',castId);await loadMyPowers();render()};
    window.sendChat=async()=>{const i=document.getElementById('chatIn');if(!i?.value.trim())return;await sb.from('mm_tea_room_posts').insert({game_id:gameId,cast_member_id:castId,content:i.value.trim(),post_type:'tea',phase:S.phase});i.value=''};
    document.getElementById('chatIn').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat()});
    init().catch(e=>{console.error(e);document.getElementById('loading').innerHTML=`<div style="color:var(--red)">Error: ${e.message}</div>`});
  </script>
</body>
</html>
