<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alliance Chat | Mansion Mayhem</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0a0a0a;
      --bg-card: #111;
      --bg-elevated: #1a1a1a;
      --border: #2a2a2a;
      --text: #fff;
      --text-dim: #888;
      --gold: #d4af37;
      --purple: #8b5cf6;
      --danger: #e74c3c;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .chat-header {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(139,92,246,0.1));
      border-bottom: 2px solid var(--border);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-info h1 {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .room-members {
      font-size: 13px;
      color: var(--text-dim);
    }
    .btn-leave {
      background: var(--danger);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-leave:hover {
      transform: scale(1.05);
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .messages-container::-webkit-scrollbar {
      width: 8px;
    }
    .messages-container::-webkit-scrollbar-track {
      background: var(--bg);
    }
    .messages-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 70%;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .message.own {
      margin-left: auto;
      flex-direction: row-reverse;
    }
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .message-content {
      flex: 1;
    }
    .message-sender {
      font-size: 12px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .message.own .message-sender {
      text-align: right;
      color: var(--purple);
    }
    .message-bubble {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 12px;
      border-top-left-radius: 4px;
    }
    .message.own .message-bubble {
      background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(139,92,246,0.2));
      border-color: var(--gold);
      border-top-left-radius: 12px;
      border-top-right-radius: 4px;
    }
    .message-text {
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .message-time {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 6px;
    }
    .message.own .message-time {
      text-align: right;
    }

    /* Voice Message */
    .voice-message {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--purple);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s;
    }
    .voice-play-btn:hover {
      transform: scale(1.1);
      background: var(--gold);
    }
    .voice-play-btn.playing {
      background: var(--danger);
    }
    .voice-duration {
      font-size: 13px;
      color: var(--text-dim);
    }

    /* Moderation Badges */
    .moderation-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      display: inline-block;
    }
    .moderation-badge.pending {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.4);
    }
    .moderation-badge.rejected {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid rgba(231, 76, 60, 0.4);
    }
    .message.pending-moderation {
      opacity: 0.6;
    }
    .message.rejected-moderation {
      opacity: 0.5;
    }
    .voice-message.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* System Message */
    .message.system {
      align-self: center;
      max-width: 100%;
      margin: 8px 0;
    }
    .message.system .message-bubble {
      background: rgba(139,92,246,0.1);
      border-color: var(--purple);
      text-align: center;
      color: var(--purple);
      font-size: 13px;
      padding: 8px 16px;
    }

    /* Input Area */
    .input-area {
      background: var(--bg-card);
      border-top: 2px solid var(--border);
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .message-input {
      flex: 1;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 12px 20px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: none;
      outline: none;
      transition: all 0.3s;
    }
    .message-input:focus {
      border-color: var(--gold);
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 24px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn-send {
      background: linear-gradient(135deg, var(--gold), var(--purple));
      color: white;
    }
    .btn-send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(212,175,55,0.4);
    }
    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-voice {
      background: var(--purple);
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      padding: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-voice:hover {
      transform: scale(1.1);
    }
    .btn-voice.recording {
      background: var(--danger);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); }
      50% { box-shadow: 0 0 0 12px rgba(231,76,60,0); }
    }

    /* Voice Recorder Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--bg-card);
      border: 2px solid var(--gold);
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: var(--gold);
      margin-bottom: 24px;
    }
    .recording-indicator {
      width: 120px;
      height: 120px;
      margin: 24px auto;
      border-radius: 50%;
      background: radial-gradient(circle, var(--danger) 0%, transparent 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      animation: pulse 1.5s infinite;
    }
    .timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--gold);
      font-family: 'Courier New', monospace;
      margin: 16px 0;
    }
    .waveform {
      display: flex;
      gap: 4px;
      justify-content: center;
      height: 60px;
      align-items: center;
      margin: 24px 0;
    }
    .wave-bar {
      width: 4px;
      background: var(--gold);
      border-radius: 2px;
      animation: wave 1s ease-in-out infinite;
    }
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes wave {
      0%, 100% { height: 20px; }
      50% { height: 50px; }
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }
    .btn-modal {
      padding: 12px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-modal-primary {
      background: var(--gold);
      color: #000;
    }
    .btn-modal-danger {
      background: var(--danger);
      color: white;
    }
    .btn-modal-secondary {
      background: var(--border);
      color: var(--text);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    .empty-state-icon {
      font-size: 80px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
  <link rel="stylesheet" href="../css/modern-theme.css">
</head>
<body>
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="room-info">
      <h1 id="room-name">Loading...</h1>
      <div class="room-members" id="room-members"></div>
    </div>
    <button class="btn-leave" onclick="leaveRoom()">Leave Room</button>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" id="messages-container">
    <div class="empty-state">
      <div class="empty-state-icon">üí¨</div>
      <p>No messages yet. Start the conversation!</p>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <input
      type="text"
      class="message-input"
      id="message-input"
      placeholder="Type a message..."
      onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
    />
    <button class="btn btn-send" id="send-btn" onclick="sendMessage()">Send</button>
    <button class="btn-voice" id="voice-btn" onclick="startVoiceRecording()">üé§</button>
  </div>

  <!-- Voice Recorder Modal -->
  <div class="modal" id="voice-modal">
    <div class="modal-content">
      <div class="modal-title">üéôÔ∏è Recording Voice Note</div>
      <div class="recording-indicator">üî¥</div>
      <div class="timer" id="voice-timer">00:00</div>
      <div class="waveform">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
      </div>
      <p style="color: var(--text-dim); margin-bottom: 24px;">Max 60 seconds</p>
      <div class="modal-buttons">
        <button class="btn-modal btn-modal-danger" onclick="stopVoiceRecording()">Stop</button>
        <button class="btn-modal btn-modal-secondary" onclick="cancelVoiceRecording()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="/js/supabase-client.js"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');
    const currentCastMemberId = urlParams.get('castMemberId') || localStorage.getItem('currentCastMemberId');

    let room = null;
    let members = [];
    let messages = [];
    let channel = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let timerInterval = null;
    let currentlyPlayingAudio = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      if (!roomId || !currentCastMemberId) {
        alert('Invalid room or cast member');
        window.location.href = '/alliance-rooms.html';
        return;
      }

      await loadRoom();
      await loadMessages();
      subscribeToMessages();
    });

    // Load room data
    async function loadRoom() {
      try {
        const { data, error } = await window.supabaseClient
          .from('mm_alliance_rooms')
          .select('*')
          .eq('id', roomId)
          .single();

        if (error || !data) throw new Error('Room not found');

        room = data;

        // Check if current user is a member
        const memberIds = room.member_ids || room.member_cast_ids || [];
        if (!memberIds.includes(currentCastMemberId)) {
          alert('You are not a member of this room');
          window.location.href = '/alliance-rooms.html';
          return;
        }

        // Load member details
        const { data: memberData, error: memberError } = await window.supabaseClient
          .from('cast_members')
          .select('id, full_name, display_name, avatar_url')
          .in('id', memberIds);

        if (!memberError) {
          members = memberData || [];
        }

        // Update UI
        document.getElementById('room-name').textContent = room.room_name;
        document.getElementById('room-members').textContent =
          members.map(m => m.display_name).join(', ');

      } catch (error) {
        console.error('Error loading room:', error);
        alert('Failed to load room');
        window.location.href = '/alliance-rooms.html';
      }
    }

    // Load messages
    async function loadMessages() {
      try {
        const { data, error } = await window.supabaseClient
          .from('mm_alliance_messages')
          .select('*')
          .eq('room_id', roomId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        messages = data || [];
        renderMessages();
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Render messages
    function renderMessages() {
      const container = document.getElementById('messages-container');

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <p>No messages yet. Start the conversation!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = messages.map(msg => {
        const sender = members.find(m => m.id === msg.sender_cast_id);
        const isOwn = msg.sender_cast_id === currentCastMemberId;
        const senderName = sender?.display_name || 'Unknown';
        const timestamp = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (msg.message_type === 'system') {
          return `
            <div class="message system">
              <div class="message-content">
                <div class="message-bubble">${msg.text_content}</div>
              </div>
            </div>
          `;
        }

        if (msg.message_type === 'text') {
          return `
            <div class="message ${isOwn ? 'own' : ''}">
              <div class="message-avatar">${sender?.display_name?.charAt(0) || '?'}</div>
              <div class="message-content">
                ${!isOwn ? `<div class="message-sender">${senderName}</div>` : ''}
                <div class="message-bubble">
                  <div class="message-text">${escapeHtml(msg.text_content)}</div>
                  <div class="message-time">${timestamp}</div>
                </div>
              </div>
            </div>
          `;
        }

        if (msg.message_type === 'voice') {
          const isPending = msg.moderation_status === 'pending';
          const isRejected = msg.moderation_status === 'rejected';

          // Only show pending/rejected to sender
          if ((isPending || isRejected) && !isOwn) {
            return ''; // Hide from others
          }

          return `
            <div class="message ${isOwn ? 'own' : ''} ${isPending ? 'pending-moderation' : ''} ${isRejected ? 'rejected-moderation' : ''}">
              <div class="message-avatar">${sender?.display_name?.charAt(0) || '?'}</div>
              <div class="message-content">
                ${!isOwn ? `<div class="message-sender">${senderName}</div>` : ''}
                <div class="message-bubble">
                  ${isPending ? '<div class="moderation-badge pending">‚è≥ Under Review</div>' : ''}
                  ${isRejected ? '<div class="moderation-badge rejected">‚ùå Not Approved</div>' : ''}
                  <div class="voice-message ${isPending || isRejected ? 'disabled' : ''}">
                    <button class="voice-play-btn" onclick="playVoiceMessage('${msg.id}', '${msg.voice_note_url}')" ${isPending || isRejected ? 'disabled' : ''}>
                      ${isPending || isRejected ? '‚è∏' : '‚ñ∂'}
                    </button>
                    <span class="voice-duration">${msg.voice_note_duration_seconds}s</span>
                  </div>
                  <div class="message-time">${timestamp}</div>
                </div>
              </div>
            </div>
          `;
        }

        return '';
      }).join('');

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    // Send text message
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();

      if (!text) return;

      try {
        const { error } = await window.supabaseClient
          .from('mm_alliance_messages')
          .insert({
            room_id: roomId,
            sender_cast_id: currentCastMemberId,
            message_type: 'text',
            message: text
          });

        if (error) throw error;

        input.value = '';

        // Update room activity
        await window.supabaseClient
          .from('mm_alliance_rooms')
          .update({
            message_count: (room.message_count || 0) + 1,
            last_activity_at: new Date().toISOString()
          })
          .eq('id', roomId);

      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
      }
    }

    // Start voice recording
    async function startVoiceRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await uploadVoiceNote(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordingStartTime = Date.now();

        // Show modal
        document.getElementById('voice-modal').classList.add('active');

        // Start timer
        timerInterval = setInterval(updateVoiceTimer, 100);

      } catch (error) {
        console.error('Error starting recording:', error);
        alert('Could not access microphone');
      }
    }

    // Update voice timer
    function updateVoiceTimer() {
      const elapsed = (Date.now() - recordingStartTime) / 1000;
      const minutes = Math.floor(elapsed / 60);
      const seconds = Math.floor(elapsed % 60);

      document.getElementById('voice-timer').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

      // Auto-stop at 60 seconds
      if (elapsed >= 60) {
        stopVoiceRecording();
      }
    }

    // Stop voice recording
    function stopVoiceRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
      }
    }

    // Cancel voice recording
    function cancelVoiceRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        audioChunks = [];
      }
      document.getElementById('voice-modal').classList.remove('active');
    }

    // Upload voice note
    async function uploadVoiceNote(audioBlob) {
      try {
        const duration = (Date.now() - recordingStartTime) / 1000;
        const timestamp = Date.now();
        const fileName = `${roomId}/${currentCastMemberId}-${timestamp}.webm`;

        // Upload to moderation pending bucket (not public)
        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
          .from('voice-moderation-pending')
          .upload(fileName, audioBlob, {
            contentType: 'audio/webm',
            cacheControl: '3600'
          });

        if (uploadError) throw uploadError;

        // Get URL (private, for moderation review)
        const { data: urlData } = window.supabaseClient.storage
          .from('voice-moderation-pending')
          .getPublicUrl(fileName);

        // Save message to database with pending moderation status
        const { data: messageData, error: messageError } = await window.supabaseClient
          .from('mm_alliance_messages')
          .insert({
            room_id: roomId,
            sender_cast_id: currentCastMemberId,
            message_type: 'voice',
            voice_note_url: urlData.publicUrl,
            voice_note_duration_seconds: Math.round(duration),
            moderation_status: 'pending'
          })
          .select()
          .single();

        if (messageError) throw messageError;

        // Submit to moderation queue
        const { data: queueData, error: queueError } = await window.supabaseClient
          .rpc('submit_voice_for_moderation', {
            p_source_type: 'alliance_message',
            p_source_table: 'mm_alliance_messages',
            p_source_record_id: messageData.id,
            p_submitter_user_id: (await window.supabaseClient.auth.getUser()).data.user.id,
            p_submitter_cast_id: currentCastMemberId,
            p_game_id: room.game_id,
            p_audio_url: urlData.publicUrl,
            p_duration_seconds: Math.round(duration),
            p_caption: null,
            p_priority: 0
          });

        if (queueError) {
          console.warn('Error adding to moderation queue:', queueError);
          // Continue anyway - message was saved
        }

        // Update room stats
        await window.supabaseClient
          .from('mm_alliance_rooms')
          .update({
            voice_note_count: (room.voice_note_count || 0) + 1,
            message_count: (room.message_count || 0) + 1,
            last_activity_at: new Date().toISOString()
          })
          .eq('id', roomId);

        // Hide modal and show confirmation
        document.getElementById('voice-modal').classList.remove('active');

        // Show moderation pending message
        const pendingMessage = document.createElement('div');
        pendingMessage.className = 'moderation-pending-notice';
        pendingMessage.innerHTML = `
          <div class="notice-icon">‚è≥</div>
          <div class="notice-text">
            <strong>Voice note submitted for review</strong>
            <p>Your voice note will appear in the chat once it's been approved by our moderation team.</p>
          </div>
        `;
        pendingMessage.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; gap: 10px; align-items: center;';
        document.getElementById('messages-container').appendChild(pendingMessage);

        // Auto-remove notice after 5 seconds
        setTimeout(() => pendingMessage.remove(), 5000);

      } catch (error) {
        console.error('Error uploading voice note:', error);
        alert('Failed to send voice note');
        document.getElementById('voice-modal').classList.remove('active');
      }
    }

    // Play voice message
    function playVoiceMessage(messageId, url) {
      // Stop currently playing audio
      if (currentlyPlayingAudio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio = null;
        document.querySelectorAll('.voice-play-btn').forEach(btn => {
          btn.textContent = '‚ñ∂';
          btn.classList.remove('playing');
        });
      }

      // Play new audio
      const audio = new Audio(url);
      const button = event.target;

      audio.play();
      button.textContent = '‚è∏';
      button.classList.add('playing');
      currentlyPlayingAudio = audio;

      audio.onended = () => {
        button.textContent = '‚ñ∂';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      };
    }

    // Subscribe to new messages
    function subscribeToMessages() {
      channel = window.supabaseClient
        .channel(`alliance-room-${roomId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'mm_alliance_messages',
          filter: `room_id=eq.${roomId}`
        }, (payload) => {
          messages.push(payload.new);
          renderMessages();
        })
        .subscribe();
    }

    // Leave room
    async function leaveRoom() {
      if (!confirm('Are you sure you want to leave this alliance room?')) return;

      try {
        // Remove current user from members
        const memberIds = room.member_ids || room.member_cast_ids || [];
        const newMembers = memberIds.filter(id => id !== currentCastMemberId);

        // Post system message
        await window.supabaseClient
          .from('mm_alliance_messages')
          .insert({
            room_id: roomId,
            sender_cast_id: currentCastMemberId,
            message_type: 'system',
            message: `${members.find(m => m.id === currentCastMemberId)?.display_name} left the room`
          });

        // Update room
        await window.supabaseClient
          .from('mm_alliance_rooms')
          .update({
            member_ids: newMembers,
            is_active: newMembers.length >= 2
          })
          .eq('id', roomId);

        window.location.href = '/alliance-rooms.html';
      } catch (error) {
        console.error('Error leaving room:', error);
        alert('Failed to leave room');
      }
    }

    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (channel) channel.unsubscribe();
      if (currentlyPlayingAudio) currentlyPlayingAudio.pause();
    });
  </script>
</body>
</html>
