<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lobby ‚Äî Mansion Mayhem</title>
  <link rel="stylesheet" href="/css/candy.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .lobby-split{display:grid;grid-template-columns:1fr 380px;gap:2rem;align-items:start}
    .modes{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin:1.25rem 0 1.5rem}
    .mode{background:var(--card);border:2px solid var(--border);border-radius:var(--r);padding:1.25rem;text-align:center;cursor:pointer;transition:all 0.25s}
    .mode:hover{border-color:var(--border-h)}
    .mode.sel{border-color:var(--pink);background:var(--pink-s);box-shadow:var(--glow-pink)}
    .mode-e{font-size:2rem;margin-bottom:0.35rem}
    .mode-n{font-family:var(--font-display);font-weight:700;font-size:1rem}
    .mode-t{font-size:0.75rem;color:var(--text3);margin-top:0.1rem}
    .mode-p{font-size:0.7rem;color:var(--purple);margin-top:0.25rem}
    .join-box{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem}
    .join-row{display:flex;gap:0.5rem;margin-top:0.65rem}
    .game-row{display:flex;align-items:center;gap:0.75rem;padding:0.8rem;background:var(--card);border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s}
    .game-row:hover{border-color:var(--pink);background:var(--pink-s)}
    .game-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
    .game-info{flex:1}.game-nm{font-family:var(--font-display);font-weight:700;font-size:0.85rem}.game-sub{font-size:0.7rem;color:var(--text3)}
    .game-ct{font-family:var(--font-display);font-weight:800;font-size:0.9rem;color:var(--gold)}
    .wait{text-align:center;padding:3rem 0;display:none}
    .wait-code{font-family:var(--font-display);font-size:3.2rem;font-weight:900;letter-spacing:0.3em;margin:0.75rem 0}
    .wait-players{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center;margin:1.5rem 0}
    .wait-p{display:flex;align-items:center;gap:0.3rem;padding:0.4rem 0.75rem;border-radius:var(--r-pill);background:var(--card);border:1px solid var(--border);font-size:0.8rem}
    .wait-dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
  </style>
</head>
<body>
  <div class="page">
    <div class="orb3"></div>
    <div class="main">
      <div class="container">
        <div id="vMain">
          <h1 class="display-lg anim" style="margin-bottom:0.25rem">Choose Mode</h1>
          <p class="body-lg anim anim-d1">Create a game or join with a code</p>
          <div class="lobby-split anim anim-d2">
            <div>
              <div class="modes" id="modeGrid">
                <div class="mode sel" data-m="party" onclick="selMode('party')"><div class="mode-e">üéâ</div><div class="mode-n">Party</div><div class="mode-t">35 min</div><div class="mode-p">8‚Äì20 players</div></div>
                <div class="mode" data-m="blitz" onclick="selMode('blitz')"><div class="mode-e">‚ö°</div><div class="mode-n">Blitz</div><div class="mode-t">15 min</div><div class="mode-p">6‚Äì12 players</div></div>
                <div class="mode" data-m="sprint" onclick="selMode('sprint')"><div class="mode-e">üèÉ</div><div class="mode-n">Sprint</div><div class="mode-t">5 min</div><div class="mode-p">4‚Äì8 players</div></div>
                <div class="mode" data-m="weekly" onclick="selMode('weekly')"><div class="mode-e">üìÖ</div><div class="mode-n">Season</div><div class="mode-t">10 weeks</div><div class="mode-p">10‚Äì20 players</div></div>
              </div>
              <button class="btn btn-fire btn-block btn-lg" id="createBtn" onclick="createGame()">Create Game</button>
            </div>
            <div>
              <div class="join-box">
                <div class="label" style="color:var(--text3)">Join with Code</div>
                <div class="join-row"><input class="input input-code" id="joinCode" placeholder="ABC123" maxlength="6"><button class="btn btn-glass" onclick="joinGame()">Join</button></div>
              </div>
              <div class="label" style="color:var(--text3);margin-bottom:0.5rem">Open Games</div>
              <div id="gamesList"></div>
            </div>
          </div>
        </div>
        <div id="vWait" class="wait">
          <div class="anim-float" style="font-size:3rem">üè∞</div>
          <h2 class="display-lg" style="margin-top:0.5rem">Waiting for Players</h2>
          <div class="wait-code fire-text" id="waitCode">------</div>
          <p class="body-lg">Share this code with friends</p>
          <div class="wait-players" id="waitPlayers"></div>
          <div id="waitStatus" class="body-md" style="color:var(--gold)">Waiting...</div>
          <div style="display:flex;gap:0.75rem;margin-top:1.5rem;justify-content:center">
            <button class="btn btn-fire btn-lg" id="startBtn" onclick="startGame()">üé¨ Start Game</button>
            <button class="btn btn-outline" onclick="leaveGame()">Leave</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import{waitForSupabase,requireAuth,signOut,getSupabase,getUser}from'/js/supabase.js';
    import{initSidebar}from'/js/sidebar.js';
    import*as userMod from'/js/supabase.js';
    let sb,user,mode='party',curGame=null;
    async function init(){
      sb=await waitForSupabase();user=await requireAuth();if(!user)return;
      await initSidebar('lobby',userMod);loadGames();checkActive();
    }
    window.selMode=(m)=>{mode=m;document.querySelectorAll('.mode').forEach(c=>c.classList.toggle('sel',c.dataset.m===m))};
    window.createGame=async()=>{const btn=document.getElementById('createBtn');btn.disabled=true;btn.textContent='Creating...';try{
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='';for(let i=0;i<6;i++)code+=chars[Math.floor(Math.random()*chars.length)];
      const maxP={party:20,blitz:12,sprint:8,weekly:20};
      const title=mode[0].toUpperCase()+mode.slice(1)+' Game '+code;

      // 1. Create game
      const{data:g,error}=await sb.from('mm_games').insert({title:title,game_code:code,status:'waiting_lobby',game_mode:mode,max_players:maxP[mode]||20,current_players:0,current_phase:'lobby',phase_started_at:new Date().toISOString()}).select().single();
      if(error){alert('Create error: '+error.message);return}
      if(!g){alert('Game created but could not read it back.');return}
      console.log('Game created:',g.id);

      // 2. Join player
      const{error:joinErr}=await sb.rpc('join_game',{p_game_id:g.id,p_user_id:user.id});
      if(joinErr)console.warn('join_game error:',joinErr.message);

      // 3. Spawn AI cast to fill lobby
      const aiCount={party:7,blitz:5,sprint:3,weekly:7}[mode]||5;
      const{data:aiRes,error:aiErr}=await sb.rpc('spawn_ai_for_game',{p_game_id:g.id,p_count:aiCount});
      if(aiErr)console.warn('AI spawn error:',aiErr.message);
      else console.log('AI spawned:',aiRes);

      // 4. Schedule lobby_check recurring event for the cron processor
      await sb.from('game_events').insert([
        {game_id:g.id,event_type:'lobby_check',scheduled_for:new Date(Date.now()+10000).toISOString(),priority:7,is_recurring:true,recurring_interval:'00:01:00',payload:{mode:mode},status:'scheduled'},
        {game_id:g.id,event_type:'lobby_fill',scheduled_for:new Date().toISOString(),priority:8,is_recurring:false,payload:{mode:mode},status:'scheduled'}
      ]).then(r=>{if(r.error)console.warn('Event insert error:',r.error.message)});

      // 5. Try direct lobby check to start game immediately (if enough players)
      const{data:lobbyRes,error:lobbyErr}=await sb.rpc('handle_event_lobby_check',{p_game_id:g.id,p_payload:{mode:mode}});
      console.log('Lobby check result:',lobbyRes,lobbyErr?.message);

      // 6. If game started, schedule episode phases
      if(lobbyRes?.action==='game_started'){
        console.log('Game started! Scheduling episode...');
        const{data:epRes,error:epErr}=await sb.rpc('schedule_episode_events',{p_game_id:g.id,p_episode_number:1,p_mode:mode});
        if(epErr)console.warn('Episode schedule error:',epErr.message);
        else console.log('Episode scheduled:',epRes);
      }

      curGame=g.id;showWait(g);
    }catch(e){alert('Error: '+e.message);console.error(e)}finally{btn.disabled=false;btn.textContent='Create Game'}};
    window.joinGame=async()=>{const code=document.getElementById('joinCode').value.trim().toUpperCase();if(code.length!==6){alert('Enter 6-char code');return}const{data:g}=await sb.from('mm_games').select('*').eq('game_code',code).in('status',['waiting_lobby','active_lobby','recruiting']).maybeSingle();if(!g){alert('Game not found');return}await sb.rpc('join_game',{p_game_id:g.id,p_user_id:user.id}).catch(()=>{});curGame=g.id;showWait(g)};
    window.joinOpen=async(id)=>{await sb.rpc('join_game',{p_game_id:id,p_user_id:user.id}).catch(()=>{});const{data:g}=await sb.from('mm_games').select('*').eq('id',id).single();if(g){curGame=id;showWait(g)}};
    function showWait(g){document.getElementById('vMain').style.display='none';document.getElementById('vWait').style.display='block';document.getElementById('waitCode').textContent=g.game_code||'------';
      // Check if already active
      if(g.status==='active'){location.href=`/pages/episode-play.html?game=${g.id}`;return}
      // Subscribe to realtime updates
      sb.channel('lob-'+g.id).on('postgres_changes',{event:'*',schema:'public',table:'mm_game_cast',filter:`game_id=eq.${g.id}`},()=>loadWaitP(g.id)).on('postgres_changes',{event:'UPDATE',schema:'public',table:'mm_games',filter:`id=eq.${g.id}`},(p)=>{if(p.new.status==='active')location.href=`/pages/episode-play.html?game=${g.id}`}).subscribe();
      // Poll game status every 5s as fallback (in case realtime misses the update)
      const pollIv=setInterval(async()=>{const{data:gm}=await sb.from('mm_games').select('status').eq('id',g.id).single();if(gm?.status==='active'){clearInterval(pollIv);location.href=`/pages/episode-play.html?game=${g.id}`}},5000);
      loadWaitP(g.id)}
    async function loadWaitP(gid){const{data}=await sb.from('mm_game_cast').select('*,cast_members(display_name,is_ai_player)').eq('game_id',gid);const el=document.getElementById('waitPlayers');if(!data)return;el.innerHTML=data.map(c=>`<div class="wait-p"><span class="wait-dot"></span>${c.cast_members?.display_name||'Player'}${c.cast_members?.is_ai_player?' ü§ñ':''}</div>`).join('');document.getElementById('waitStatus').textContent=`${data.length} player${data.length!==1?'s':''} in lobby`}
    window.startGame=async()=>{if(!curGame)return;const btn=document.getElementById('startBtn');btn.disabled=true;btn.textContent='Starting...';try{
      // Force lobby check (transitions game to active if enough players)
      const{data:lr,error:le}=await sb.rpc('handle_event_lobby_check',{p_game_id:curGame,p_payload:{mode:mode}});
      console.log('Lobby check:',lr,le?.message);
      if(lr?.action==='game_started'){
        // Schedule episode phases
        const{data:er,error:ee}=await sb.rpc('schedule_episode_events',{p_game_id:curGame,p_episode_number:1,p_mode:mode});
        console.log('Episode scheduled:',er,ee?.message);
        location.href=`/pages/episode-play.html?game=${curGame}`;return;
      }
      // If lobby_check didn't start it (not enough players), force-start with direct update
      const{data:castCount}=await sb.from('mm_game_cast').select('id',{count:'exact',head:true}).eq('game_id',curGame);
      await sb.from('mm_games').update({status:'active',started_at:new Date().toISOString(),current_phase:'arrival',phase_started_at:new Date().toISOString(),current_week:1}).eq('id',curGame);
      // Cancel lobby events
      await sb.from('game_events').update({status:'cancelled'}).eq('game_id',curGame).in('event_type',['lobby_check','lobby_fill']).eq('status','scheduled');
      // Schedule episode
      const{data:er2,error:ee2}=await sb.rpc('schedule_episode_events',{p_game_id:curGame,p_episode_number:1,p_mode:mode});
      console.log('Episode scheduled (force):',er2,ee2?.message);
      location.href=`/pages/episode-play.html?game=${curGame}`;
    }catch(e){alert('Start error: '+e.message);console.error(e)}finally{btn.disabled=false;btn.textContent='üé¨ Start Game'}};
    window.leaveGame=()=>{curGame=null;document.getElementById('vMain').style.display='block';document.getElementById('vWait').style.display='none'};
    async function loadGames(){const{data}=await sb.from('mm_games').select('*').in('status',['waiting_lobby','active_lobby','recruiting']).order('created_at',{ascending:false}).limit(10);const el=document.getElementById('gamesList');if(!data?.length){el.innerHTML='<div class="empty"><div class="empty-icon">üè∞</div>No open games. Create one!</div>';return}const mc={party:'var(--pink)',blitz:'var(--gold)',sprint:'var(--cyan)',weekly:'var(--purple)'};const mi={party:'üéâ',blitz:'‚ö°',sprint:'üèÉ',weekly:'üìÖ'};el.innerHTML=data.map(g=>`<div class="game-row" onclick="joinOpen('${g.id}')"><div class="game-dot" style="background:${mc[g.game_mode]||'var(--text3)'}"></div><div class="game-info"><div class="game-nm">${mi[g.game_mode]||'üéÆ'} ${(g.game_mode||'party')[0].toUpperCase()+(g.game_mode||'').slice(1)}</div><div class="game-sub">Code: ${g.game_code||'???'}</div></div><div class="game-ct">${g.current_players||0}/${g.max_players||20}</div></div>`).join('')}
    async function checkActive(){const{data:cms}=await sb.from('cast_members').select('id').eq('user_id',user.id);if(!cms?.length)return;const{data:ag}=await sb.from('mm_game_cast').select('game_id,mm_games(id,status,game_code,current_phase)').in('cast_member_id',cms.map(c=>c.id)).eq('status','active');if(!ag)return;for(const a of ag){const g=a.mm_games;if(!g)continue;if(g.status==='active'&&g.current_phase!=='lobby'){location.href=`/pages/episode-play.html?game=${g.id}`;return}if(['waiting_lobby','active_lobby'].includes(g.status)){curGame=g.id;showWait(g);return}}}
    init();
  </script>
</body>
</html>
